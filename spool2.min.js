function assert(t,e){if(!t)throw new Error(e)}function arraysEqual(t,e){if(t===e)return!0;if(null==t||null==e)return!1;if(t.length!==e.length)return!1;for(var s=0;s<t.length;++s)if(t[s]!==e[s])return!1;return!0}function ABList(t,e){this.allow=t?new Set(t):null,this.block=e?new Set(e):null}function getHex(t){assert(0<=t&&t<=255,"Color out of bounds");return"0123456789abcdef"[Math.floor(t/16)]+"0123456789abcdef"[Math.floor(t%16)]}function getColor(t,e,s){return`#${getHex(255*t)}${getHex(255*e)}${getHex(255*s)}`}function Heap(t){this.arr=[],this.size=0,this.comparator=t}function Node(t,e){this.gid=t,Object.assign(this,e)}function Graph(){this.nodes=[],this.connections=[]}function reconstructPath(t,e,s){for(var n=s,o=[];n&&n!=e;)o.push(n),n=t[n];return o.push(e),o.reverse(),o}function aStar(t,e,s,n){opened=new Heap((t,e)=>f[t.gid]-f[e.gid]),openedSet=new Set;var o=t.get(e),r=t.get(s);for(f={[e]:n(o,r)},g={[e]:0},cameFrom={},opened.add(o),openedSet.add(e);opened.size>0;){var i=opened.pop();if(openedSet.delete(i.gid),i.gid==s)return reconstructPath(cameFrom,e,s);for(var a=0;a<t.connections[i.gid].length;a++){var h=t.connections[i.gid][a];let e=t.nodes[h[0]],s=h[1],o=g[i.gid]+s;e.gid in g&&!(o<g[e.gid])||(cameFrom[e.gid]=i.gid,g[e.gid]=o,f[e.gid]=o+n(e,r),e.gid in openedSet||(opened.add(e),openedSet.add(e.gid)))}}return null}ABList.prototype.allowed=function(t){return(!this.block||!this.block.has(t))&&(!this.allow||this.allow.has(t))},Heap.prototype.pop=function(){if(0==this.size)throw"Heap is already empty";var t=this.arr[0];return this.arr[0]=this.arr[this.size-1],this.size--,this.heapDown(),t},Heap.prototype.add=function(t){this.size<this.arr.length?this.arr[this.size]=t:this.arr.push(t),this.size++,this.heapUp()},Heap.prototype.getParent=function(t){return Math.floor((t-1)/2)},Heap.prototype.getLChild=function(t){return Math.floor(2*t+1)},Heap.prototype.getRChild=function(t){return Math.floor(2*t+2)},Heap.prototype.hasParent=function(t){return 0!=t},Heap.prototype.hasLChild=function(t){return 2*t+1<this.size},Heap.prototype.hasRChild=function(t){return 2*t+2<this.size},Heap.prototype.heapUp=function(){for(var t=this.size-1,e=this.getParent(t);this.hasParent(t)&&this.comparator(this.arr[e],this.arr[t])>0;)this.swap(t,e),t=this.getParent(t),e=this.getParent(t)},Heap.prototype.heapDown=function(){for(var t=0;this.hasLChild(t);){var e=this.getLChild(t);if(this.hasRChild(t)&&this.comparator(this.arr[e],this.arr[this.getRChild(t)])>0&&(e=this.getRChild(t)),this.comparator(e,this.arr[t])>0)break;this.swap(e,t),t=e}},Heap.prototype.swap=function(t,e){let s=this.arr[t];this.arr[t]=this.arr[e],this.arr[e]=s},Graph.prototype.get=function(t){return this.nodes[t]},Graph.prototype.addNode=function(t){let e=new Node(this.nodes.length,t);return this.nodes.push(e),this.connections[e.gid]=[],e.gid},Graph.prototype.connect=function(t,e,s=1){t in this.connections||(this.connections[t]=[]),e in this.connections||(this.connections[e]=[]),this.connections[t].push([e,s]),this.connections[e].push([t,s])},Graph.prototype.getNeighbours=function(t){return this.connections[t.gid].map(t=>[this.nodes[t[0]],t[1]])};const SPMath={polarPoint:(t,e,s)=>SPTensors.vector([t.x+e*Math.cos(s),t.y+e*Math.sin(s)]),polarPoints:(t,e,s=1,n=0,o=0)=>{for(var r=[],i=0;i<t;i++){var a=SPMath.polarPoint(e,s,(i-(t-1)/2)*o+n);r.push(a)}return r},rotatePoint:(t,e,s)=>{var n=Math.sin(s),o=Math.cos(s),r=SPTensors.sub(t,e);return SPTensors.vector([r.x*o+r.y*n+e.x,r.x*n-r.y*o+e.y])},rotatePoints:(t,e,s)=>t.map(t=>rotatePoint(t,e,s)),rotatePolygon:(t,e,s)=>{let n=t.copy(),o=n.shape[0];for(let t=0;t<o;t++){var r=n.subTensor([t]),i=SPMath.rotatePoint(r,e,s);n.set(2*t,i.x),n.set(2*t+1,i.y)}return n},transformPoints:(t,e)=>t.map(t=>SPTensors.add(t,e)),distance:function(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))},angleDistance:function(t,e){var s=(e-t)%(2*Math.PI);return s>0?s>Math.PI?-(2*Math.PI-s):s:s<-Math.PI?-(-2*Math.PI-s):s},point:function(t,e){return SPTensors.vector([t,e])},rect:function(t,e,s,n){return SPTensors.vector([t,e,s,n])},getRect:function(t,e){var s=Math.min(t.x,e.x),n=Math.min(t.y,e.y),o=Math.abs(t.x-e.x),r=Math.abs(t.y-e.y);return SPTensors.vector([s,n,o,r])},rectToPolygon:function(t){return SPTensors.tensor([4,2],[t.x,t.y,t.x+t.width,t.y,t.x+t.width,t.y+t.height,t.x,t.y+t.height])},rectContains:(t,e)=>t.x<e.x&&e.x<t.x+t.width&&t.y<e.y&&e.y<t.y+t.height,rectCollision:(t,e)=>{let s=SPTensors.vector([t.x-e.width/2,t.y-e.height/2,t.width+e.width,t.height+e.height]),n=SPTensors.vector([e.x+e.width/2,e.y+e.height/2]);return SPMath.rectContains(s,n)},lineIntersection:(t,e)=>{var s=t.x,n=t.xx,o=t.y,r=t.yy,i=e.x,a=e.xx,h=e.y,p=e.yy,u=(s-n)*(h-p)-(o-r)*(i-a);if(0==u)return null;var c=((s*r-o*n)*(i-a)-(s-n)*(i*p-h*a))/u,l=((s*r-o*n)*(h-p)-(o-r)*(i*p-h*a))/u;return SPMath.inRange(c,s,n,0)&&SPMath.inRange(c,i,a,0)&&SPMath.inRange(l,o,r,0)&&SPMath.inRange(l,h,p,0)?SPTensors.vector([c,l]):null},polygonContains:(t,e)=>{for(var s=null,n=null,o=null,r=null,i=0;i<t.shape[0];i++){var a=t.subTensor([i]);(null===s||a.x<s)&&(s=a.x),(null===n||a.y<n)&&(n=a.y),(null===o||a.x>o)&&(o=a.x),(null===r||a.y>r)&&(r=a.y)}return!!SPMath.rectContains(SPTensors.vector([s,n,o-s,r-n]),e)&&SPMath.polygonLineIntersection(SPTensors.vector([s-10,n-10,e.x,e.y]),t).length%2==1},polygonLineIntersection:(t,e)=>{for(var s=e.shape[0],n=[],o=0;o<e.shape[0];o++){var r=e.subTensor([o]),i=e.subTensor([(o+1)%s]),a=SPTensors.link([r,i],[2,2]),h=SPMath.lineIntersection(t,a);h&&n.push(h)}return n},unitVector:t=>SPTensors.vector([Math.cos(t),Math.sin(t)]),angleFromVec:t=>Math.atan2(t.y,t.x),range:function*(t=0,e=100,s=1){let n=0;for(let o=t;o<e;o+=s)n++,yield o;return n},inRange:(t,e,s,n=0)=>{if(e<s)var o=e,r=s;else o=s,r=e;return o-n<=t&&t<=r+n},clamp:(t,e,s)=>Math.max(Math.min(t,s),e),randRange:(t,e)=>Math.random()*(e-t)+t,randPointInRect:t=>SPTensors.vector([t.x+SPMath.randRange(0,t.width),t.y+SPMath.randRange(0,t.height)]),randPointInRadius:(t,e)=>{var s=SPMath.randRange(0,2*Math.PI),n=SPMath.randRange(0,e);return console.log(s,n),SPMath.polarPoint(t,n,s)},sigmoid:t=>1/(1+Math.exp(-t)),posmod:(t,e)=>(t%e+e)%e,posmodRange:(t,e,s)=>e+SPMath.posmod(t-e,s-e)},basicAliases={x:0,y:1,z:2,w:3,xx:2,yy:3,a:0,b:1,c:2,d:3,width:2,height:3};function TensorBase(t){this.shape=t,this.size=SPTensors.getSize(t),this.dimension=SPTensors.getDimensions(t)}function Tensor(t,e=null,s=(()=>0)){if(TensorBase.call(this,t),this.type="fixed",this.levelSizes=SPTensors.getLevelSizes(t),e){if(e.length!=this.size)throw new Error(`The size of values (${e.length}) doesn't match the shape of the tensor (${t})`);this.values=e}else this.values=Array.from({length:this.size},s)}function VariableTensor(t,e,s=(()=>0)){if(TensorBase.call(this,t),this.type="variable",this.indexes=SPTensors.getIndexesMap(t)[0],e){if(e.length!=this.size)throw new Error(`The size of values (${e.length}) doesn't match the shape of the tensor (${t})`);this.values=e}else this.values=Array.from({length:this.size},s)}TensorBase.prototype.getIndex=function(t){return this.getIndexAndShape(t).index},TensorBase.prototype.getValue=function(t){"number"==typeof t&&(t=[t]);const e=this.getIndex(t);return this.get(e)},TensorBase.prototype.getValues=function(){res=[];for(var t=0;t<this.size;t++)res.push(this.get(t));return res},TensorBase.prototype.T=function(){if(2!=this.dimension)throw`You can only transpose 2-d tensor, not ${this.dimension}-d`;var t=[this.shape[1],this.shape[0]],e=new SubTensor(self,t);return e.get=(t=>{var e=Math.floor(t/this.shape[0]),s=t%this.shape[0];return this.get(s*this.shape[1]+e)}),e},TensorBase.prototype.copy=function(t=((t,e)=>t)){return SPTensors.copy(this,t)},TensorBase.prototype.apply=function(t=((t,e)=>t)){return SPTensors.apply(this,t)},TensorBase.prototype.add=function(t){return"number"==typeof t?this.apply(e=>e+t):this.apply((e,s)=>e+t.get(s))},TensorBase.prototype.sub=function(t){return"number"==typeof t?this.apply(e=>e-t):this.apply((e,s)=>e-t.get(s))},TensorBase.prototype.mult=function(t){return"number"==typeof t?this.apply(e=>e*t):this.apply((e,s)=>e*t.get(s))},TensorBase.prototype.div=function(t){return"number"==typeof t?this.apply(e=>e/t):this.apply((e,s)=>e/t.get(s))},TensorBase.prototype.toString=function(){return SPTensors.toString(this)},TensorBase.prototype.reshape=function(t){if(SPTensors.getSize(t)!=this.size)throw new Error(`You can't reshape ${this.size} values into ${t.toString()}`);return this.shape=t,this.dimension=SPTensors.getDimensions(t),this},TensorBase.prototype.subTensor=function(t){if(this.shape.length-t.length<0)throw`${t.length} coords for ${s.length} array`;let{index:e,shape:s}=this.getIndexAndShape(t);return new SubTensor(this,s,e,e+SPTensors.getSize(this.shape))},Object.keys(basicAliases).forEach(function(t){Object.defineProperty(TensorBase.prototype,t,{get:function(){return this.get(basicAliases[t])},set:function(e){return this.set(basicAliases[t],e)}})}),Tensor.prototype=Object.create(TensorBase.prototype),Tensor.prototype.get=function(t){return this.values[t]},Tensor.prototype.getValues=function(){return this.values},Tensor.prototype.set=function(t,e){return this.values[t]=e,this.values[t]},Tensor.prototype.getIndexAndShape=function(t){return SPTensors.getIndexAndShape(this.shape,t,this.levelSizes)},VariableTensor.prototype=Object.create(TensorBase.prototype),VariableTensor.prototype.get=function(t){return this.values[t]},VariableTensor.prototype.set=function(t,e){return this.values[t]=e},VariableTensor.prototype.getIndexAndShape=function(t){return SPTensors.getVariableIndexAndShape(this.shape,t,this.indexes)},VariableTensor.prototype.subTensor=function(t){let{index:e,shape:s}=this.getIndexAndShape(t);return new SubTensor(this,s,e,e+SPTensors.getSize(this.shape))},VariableTensor.prototype.toString=function(){for(var t="",e=0;e<this.shape.length;e++)t+=this.subTensor([e]).toString()+"\n";return t};const isVariable=t=>t.length>0&&t[0].constructor===Array;function SubTensor(t,e,s=null,n=null){TensorBase.call(this,e),this.parent=t,this.start=s,this.end=n,this.type="sub",null===this.start&&(this.start=0),null===this.end&&(this.end=SPTensors.getSize(e)),isVariable(e)?(this.indexes=SPTensors.getIndexesMap(this.shape)[0],this.getIndexAndShape=VariableTensor.prototype.getVariableIndexAndShape):(this.levelSizes=SPTensors.getLevelSizes(this.shape),this.getIndexAndShape=Tensor.prototype.getVariableIndexAndShape)}function LinkTensor(t,e){TensorBase.call(this,e),this.sizes=t.map(t=>t.size),this.tensors=t,this.tensorsNumber=t.length,this.levelSizes=SPTensors.getLevelSizes(e),this.type="link"}SubTensor.prototype=Object.create(TensorBase.prototype),SubTensor.prototype.get=function(t){return this.parent.get(t+this.start)},SubTensor.prototype.set=function(t,e){return this.parent.set(t+this.start,e)},SubTensor.prototype.subTensor=function(t){if(this.shape.length-t.length<0)throw`${t.length} coords for ${s.length} array`;let{index:e,shape:s}=this.getIndex(t);var n=SPTensors.getSize(s);return new SubTensor(this.parent,s,e+start,e+start+n)},SubTensor.prototype.toString=function(){return new Tensor(this.shape,null,(t,e)=>this.get(e)).toString()},LinkTensor.prototype=Object.create(TensorBase.prototype),LinkTensor.prototype.getRelevantTensor=function(t){for(var e=0,s=0;s+this.sizes[e]<=t;)if(e+=1,s+=this.sizes[e],assert(e<this.tensorsNumber,"Index out of range"))return;return{ten:this.tensors[e],off:t-s}},LinkTensor.prototype.get=function(t){let{ten:e,off:s}=this.getRelevantTensor(t);return e.get(s)},LinkTensor.prototype.set=function(t,e){let{ten:s,off:n}=this.getRelevantTensor(t);return s.set(n)},LinkTensor.prototype.getIndexAndShape=function(t){return SPTensors.getIndexAndShape(this.shape,t,this.levelSizes)};var operations=["apply",""];const SPTensors={apply:(t,e=((t,e)=>t))=>{assert(t.set&&t.get,"Not a valid tensor");for(var s=0;s<t.size;s++)t.set(s,e(t.get(s),s));return t},copy:(t,e=(t=>t))=>{assert(t.shape&&t.get,"Not a valid tensor");for(var s=t.getValues(),n=[],o=0;o<s.length;o++)n.push(e(s[o],o));return new(SPTensors.constructorForShape(t.shape))(t.shape,n)},tensor:(t,e,s)=>(assert(t),new(SPTensors.constructorForShape(t))(t,e,s)),vector:t=>new Tensor([t.length],t),const:(t,e)=>SPTensors.tensor(t,null,()=>{}),zeros:t=>SPTensors.const(t),ones:t=>SPTensors.const(t,1),constLike:(t,e=0)=>SPTensors.copy(t,()=>e),zerosLike:t=>SPTensors.constLike(a),onesLike:t=>SPTensors.constLike(a,1),random:(t,e=0,s=1)=>new(SPTensors.constructorForShape(t))(t,null,()=>SPMath.randRange(e,s)),randomIn:t=>{for(var e=[],s=t.getValues(),n=0;n<size;n++)e.push(SPMath.randRange(0,s[n]));return SPTensors.tensor(t.shape,e)},randomLike:(t,e=0,s=1)=>SPTensors.copy(t,()=>SPMath.randRange(e,s)),range:(t,e=1)=>new(SPTensors.constructorForShape(t))(t,null,(t,s)=>s*e),elementWiseOperation:(t,e,s,n=!1)=>{var o=t.getValues();if(n)return SPTensors.tensor(t.shape,o.map((t,n)=>s(t,e.get(n%e.size))));assert(arraysEqual(t.shape,e.shape),`The shapes of the tensors don't match: ${t.shape} != ${e.shape}`);for(var r=e.getValues(),i=[],a=0;a<o.length;a++)i.push(s(o[a],r[a]));return SPTensors.tensor(t.shape,i)},add:(t,e,s=!1)=>"number"==typeof e?SPTensors.copy(t,t=>t+e):SPTensors.elementWiseOperation(t,e,(t,e)=>t+e,s),sub:(t,e,s=!1)=>"number"==typeof e?SPTensors.copy(t,t=>t-e):SPTensors.elementWiseOperation(t,e,(t,e)=>t-e,s),mult:(t,e,s=!1)=>"number"==typeof e?SPTensors.copy(t,t=>t*e):SPTensors.elementWiseOperation(t,e,(t,e)=>t*e,s),div:(t,e,s=!1)=>"number"==typeof e?SPTensors.copy(t,t=>t*e):SPTensors.elementWiseOperation(t,e,(t,e)=>t/e,s),dot:(t,e,s=[],n=[])=>{if(2!=t.dimension&&2!=e.dimension)throw new Error(`Dot product supports only 2-d tensor dot your (${t.dimension}-d . ${e.dimension}-d)`);aValues=t.values,bValues=e.values;let o=t.getIndexAndShape(s),r=o.index,i=o.shape;var a=i[0],h=i[1];let p=e.getIndexAndShape(n),u=p.index,c=p.shape;var l=c[0],d=c[1];if(h!=l)throw`Shapes of the tensors are not compatible for dot ${i} ${c}`;for(var y=[a,d],f=[],g=0;g<a;g++)for(var m=0;m<d;m++){for(var S=0,T=0;T<h;T++)S+=aValues[r+g*h+T]*bValues[u+T*d+m];f.push(S)}return new Tensor(y,f)},abs:t=>{if(0==t.size)return 0;for(var e=0,s=0;s<t.size;s++)e+=Math.pow(t.getValue(s),2);return Math.sqrt(e)},concat:(t,e)=>{let s=t.map(t=>t.getValues());return s=s.flat(1),void 0===e?new VariableTensor(t.map(t=>t.shape),[].concat(...t.map(t=>t.values))):new Tensor(e,s)},link:(t,e)=>new LinkTensor(t,e),constructorForShape:t=>{var e=Tensor;return t.length>0&&t[0].constructor===Array&&(e=VariableTensor),e},getIndexAndShape:(t,e,s=null)=>{var n=0;s||(s=SPTensors.getLevelSizes(t)),e.forEach((e,o)=>{if(!SPMath.inRange(e,0,t[o]))throw new Error(`${e} at in depth ${o} is out of range shape - [${t}]`);n+=e*s[1+o]});var o=t.slice(e.length);return{index:n,shape:o}},getVariableIndexAndShape:(t,e,n=null)=>{null===n&&(n=SPTensors.getIndexesMap(s)[0]);for(var o=n,r=t,i={index:o[0],shape:r},a=0;a<e.length;a++){var h=e[a];if(o=o[h],r=r[h],o.constructor!==Array)return(i=SPTensors.getIndexAndShape(r,e.slice(a+1))).index+=o,i;i={index:o[0],shape:r}}return i},getLevelSizes:t=>{for(var e=[1],s=1,n=t.length,o=0;o<n;o++)s*=t[n-o-1],e.push(s);return e.reverse(),e},getSize:t=>0==t.length?1:t[0].constructor===Array?t.map(t=>SPTensors.getSize(t)).reduce((t,e)=>t+e):t.reduce((t,e)=>t*e),getIndexesMap:(t,e=0)=>[t.map(t=>{if(t[0].constructor===Array){var s=SPTensors.getIndexesMap(t,e);return e+=s[1],s[0]}return index=e,e+=t.reduce((t,e)=>t*e),index}),e],getDimensions:t=>t.length,toFixedSize:(t,e=6)=>{for(var s=t.toString();(s.length+1)%e!=0;)s+=" ";return s},toString:(t,e=0,s=0,n="")=>{var o="",r=t.shape.length-s;if(1==r){o+=n;for(var i=0;i<t.shape[t.shape.length-1];i++){var a=6,h=", ";t.dimension<2&&(a=1),i==t.shape[t.shape.length-1]-1&&(a=1,h=""),o+=SPTensors.toFixedSize(t.get(i+e)+h,a)}}else{2!=r&&(o+=n+"[\n");for(i=0;i<t.shape[s];i++){var p=e+i*t.shape.slice(s+1).reduce((t,e)=>t*e),u=2==r&&0==i?n+"[ ":n+"  ",c=2==r&&i==t.shape[s]-1?"":"\n";o+=SPTensors.toString(t,p,s+1,u)+c}o+=2!=r?n+"]":" ]"}return 1==t.dimension?`[${o}]`:o}};try{modules.export={SPTensors:SPTensors,SPMath:SPMath}}catch(t){"undefined"==typeof module?console.log("Modules are not present, you are probably on client, make sure this script is included before the files that require it"):console.error(t)}function DNN(t,e,s,n,o){this.inputSize=t,this.hLayerSize=e,this.hLayerNumber=s,this.outputSize=n;let r=[],i=[];var a=t,h=n;this.size=s+1;for(var p=0;p<s;p++)h=e,r.push([a,h]),i.push([1,h]),a=e;if(h=n,r.push([a,h]),i.push([1,h]),void 0==o)this.weights=SPTensors.random(r,-1,1),this.biases=SPTensors.random(i,-1,1);else{let t=SPTensors.getSize(r);this.weights=new VariableTensor(r,o.slice(0,t)),this.biases=new VariableTensor(i,o.slice(t))}}function Coordinator(){this.entities=new Array(2e4),this.systems=[],this.currentId=0,this.returnedIdStack=[],this.usedIds=new Set}function Entity(){this.id=-1,this.signature=new Set}function Component(t,e){this.name=t,this.values=e}function defineComponent(t,e){let s=function(...s){Component.call(this,t,e(...s))};return s.prototype=Object.create(Component.prototype),s}function constructObject(...t){let e=new Entity;return t.forEach(t=>{t.addTo(e)}),e}function System(t,e){t||console.warn(`Your system with signature:${e.toString()} has invalid coordinator: ${t}`),this.coordinator=t,this.signature=e?new Set(e):null,this.entities=new Set}function defineSystem(t,e,s=(()=>({}))){let n=function(e,...n){System.call(this,e,t);var o=s(...n);assert("object"==typeof o,"Invalid system constructor, constructor needs to return object"),Object.assign(this,o)};return n.prototype=Object.create(System.prototype),console.log(),assert("function"==typeof e,"Invalid update function"),n.prototype.update=e,n}function Clock(t,e){this.frameTime=1e3/t,this.onTick=e,this.offset=0}function IntervalClock(t,e){this.onTick=t,this.frameTime=1e3/e,this.lastFrameTime=Date.now(),this.tickCounter=0}function BrowserClock(t){this.onTick=t,this.frameTime=1e3/60,this.lastFrameTime=0,this.tickCounter=0}function SimpleTimer(t=0){this.start=Date.now(),this.length=t}function PeriodicLogger(t){this.broswerClock=t}DNN.prototype.toString=function(){return"WEIGHTS\n"+this.weights.toString()+"BIASES\n"+this.biases.toString()},DNN.prototype.vectorize=function(){return SPTensors.concat([this.weights,this.biases],[this.weights.size+this.biases.size])},DNN.prototype.forward=function(t){for(var e=t,s=0;s<this.size;s++)e=SPTensors.dot(e,this.weights,[],[s]).add(this.biases.subTensor([s])).apply(SPMath.sigmoid);return e},DNN.prototype.mutate=function(){var t=new DNN(this.inputSize,this.hLayerSize,this.hLayerNumber,this.outputSize);return t.weights=SPTensors.add(this.weights,SPTensors.randomLike(this.weights,-.25,.25)),t.biases=SPTensors.add(this.biases,SPTensors.randomLike(this.biases,-.25,.25)),t},Coordinator.prototype.addSystem=function(t){this.systems.push(t)},Coordinator.prototype.add=function(t){var e=-1;e=this.returnedIdStack.length>0?this.returnedIdStack.pop():this.currentId++,t.id=e,this.usedIds.add(e),this.entities[e]=t,this.systems.forEach(e=>{e.add(t)})},Coordinator.prototype.remove=function(t){this.entities[t.id]=null,this.returnedIdStack.push(t.id),this.currentId,this.usedIds.delete(t.id),this.systems.forEach(e=>{e.remove(t)})},Coordinator.prototype.removeId=function(t){this.remove(this.entities[t])},Coordinator.prototype.removeAll=function(){for(;this.usedIds.size>0;)this.removeId(this.usedIds.values().next().value)},Coordinator.prototype.update=function(t){this.systems.forEach(e=>{e.update(t)})},Entity.prototype.addComponent=function(t,e){return this[t]=e,this.signature.add(t),this},Entity.prototype.addTo=function(t){return t.add(this),this},Component.prototype.addTo=function(t){t.addComponent(this.name,this.values)},System.prototype.add=function(t){if(this.signature){for(let e of this.signature)if(!t.signature.has(e))return;this.entities.add(t.id)}},System.prototype.remove=function(t){this.entities.delete(t.id)},System.prototype.getEntities=function*(){for(let t of this.entities)yield this.coordinator.entities[t]},System.prototype.addTo=function(t){return t.addSystem(this),this},System.prototype.update=function(){},Clock.prototype.start=function(){this.lastMillisTimer=Date.now(),this.lastMillis=Date.now(),this.lastFrameTime=Date.now(),this.loop()},Clock.prototype.loop=function(){let t=Date.now();if(t-this.lastFrameTime>=this.frameTime-this.offset){var e=t-this.lastFrameTime;this.onTick(e/this.frameTime),this.lastFrameTime=t,(e=Date.now()-this.lastMillisTimer)>=1e3?(console.log("FPS:"+this.frameCounter),this.frameCounter=0,this.lastMillisTimer=Date.now()):this.frameCounter+=1,this.offset=Date.now()-t}setTimeout(()=>{this.loop()})},IntervalClock.prototype.start=function(){this.lastFrameTime=Date.now(),setInterval(()=>{this.update()},this.frameTime)},IntervalClock.prototype.update=function(){let t=Date.now(),e=t-this.lastFrameTime;this.onTick(e),this.tickCounter=(this.tickCounter+1)%this.frequency,this.lastFrameTime=t},BrowserClock.prototype.start=function(){window.requestAnimationFrame(t=>{this.update(t)})},BrowserClock.prototype.update=function(t){let e=t-this.lastFrameTime;this.onTick(e/this.frameTime),this.lastFrameTime=t,this.tickCounter=(this.tickCounter+1)%60,window.requestAnimationFrame(t=>{this.update(t)})},SimpleTimer.prototype.delta=function(){return Date.now()-this.start},SimpleTimer.prototype.isDone=function(){return this.delta()>=this.length},SimpleTimer.prototype.lap=function(){return this.start=Date.now(),this.start},PeriodicLogger.prototype.log=function(...t){this.broswerClock.tickCounter%60==0&&console.log(...t)};const Transform=defineComponent("tran",(t,e=0)=>({pos:SPTensors.vector(t),rot:e})),Movement=defineComponent("mov",(t=[0,0],e=[0,0])=>({acc:SPTensors.vector(e),vel:SPTensors.vector(t)})),RigidBody=defineComponent("rig",(t,e="aabb",s=null)=>({rad:SPTensors.vector(t),shape:e,polygon:s?s.copy((e,s)=>e*t[s%2]):null})),Meta=defineComponent("meta",t=>({type:t})),DNNComponent=defineComponent("dnn",(t,e,s,n,o=null)=>({network:new DNN(t,s,e,n,o)})),Genome=defineComponent("genome",t=>({genes:t})),EvolutionComponent=defineComponent("evolution",t=>({spieces:t,dead:!1,fitness:0})),MouseFollow=defineComponent("mfollow",()=>({})),Material=defineComponent("mat",t=>({color:t})),Eyes=defineComponent("eyes",(t,e,s,n=null,o=null)=>({count:t,radius:e,output:null,angle:s,types:new ABList(n,o)}));function posRadToBounds(t,e){return{pos:SPTensors.vector([t.x-e.x,t.y-e.y]),dims:SPTensors.mult(e,2)}}function posRadToRect(t,e){return SPTensors.vector([t.x-e.x,t.y-e.y,2*e.x,2*e.y])}function entityGetBounds(t){return posRadToBounds(t.tran.pos,t.rig.rad)}function ChunkSystem(t){System.call(this,t,["tran","rig","meta"]),this.map={},this.chunkSize=250}function VelocitySystem(t){System.call(this,t,["tran","mov"])}function RenderingSystem(t,e){System.call(this,t,["tran","rig","mat"]),this.renderer=e}function EyeSystem(t,e){System.call(this,t,["tran","meta","eyes"]),this.chunkSystem=e}function MouseFollowerSystem(t,e){System.call(this,t,["tran","mfollow"]),this.mouseListener=e}function AvoiderSystem(t){System.call(this,t,["rigidbody","eye","dnn"])}function WorldFoldingSystem(t,e,s){System.call(this,t,["tran"]),this.onObjectPorted=s,this.bounds=e}function onObjectPorted(t){"boid"==t.objectType&&boidResetFitness(t)}function EvolutionSystem(t,e){System.call(this,t,["genome","evolution"]),this.spieces=e,this.spiecesTypes=Object.keys(e),this.timer=new SimpleTimer(5e3)}function CollisionSystem(t,e,s){System.call(this,t,["tran","rig"]),this.chunkSystem=e,this.onCollision=s}function DraggingSystem(t,e,s){System.call(this,t),this.mouseListener=e,this.renderer=s,this.button=0,this.dragging=!1,this.dragStart=!1}function Renderer2D(t){this.canvas=t,this.ctx=t.ctx}function TransformedRenderer2D(t,e){Renderer2D.call(this,t),this.transformer=e}function Canvas(t=null){this.canvas=document.createElement("CANVAS"),this.width=this.canvas.width,this.height=this.canvas.height,this.canvas.oncontextmenu=function(t){t.preventDefault()},this.ctx=this.canvas.getContext("2d"),null===t?document.body.appendChild(this.canvas):document.getElementById(t).appendChild(this.canvas)}function MouseListener(t){this.activeTypes=["mousedown","mouseup"],this.pressedButtons=Array(3).fill(!1),this.m=SPTensors.vector([0,0]),this.dm=SPTensors.vector([0,0]),this.target=t,this.onUpdate=(()=>{})}function Camera(t,e=[0,0],s=0,n=[1,1]){this.screenSize=SPTensors.vector(t),this.pos=SPTensors.vector(e),this.rot=s,this.scale=SPTensors.vector(n)}function DevUI(t,e){this.root=document.createElement("div"),this.root.className="spool-devui-root",this.root.style.position="absolute",this.root.style.bottom="0px",this.root.style.left="0px",this.root.style.padding="1em",this.root.style.width="250px",this.stateContainer=e,this.stateListeners={},document.getElementById(t).appendChild(this.root)}ChunkSystem.prototype=Object.create(System.prototype),ChunkSystem.prototype.update=function(t){this.map={};for(let t of this.getEntities()){let{pos:n,dims:o}=entityGetBounds(t),{a:r,b:i}=this.getChunkBoundsCoords(n,o);for(var e=r.y;e<=i.y;e++)for(var s=r.x;s<=i.x;s++)void 0===this.map[`${s}-${e}`]&&(this.map[`${s}-${e}`]=new Set),this.map[`${s}-${e}`].add(t.id)}},ChunkSystem.prototype.remove=function(t){this.entities.delete(t.id);let{pos:e,dims:s}=posRadToBounds(t.tran.pos,t.rig.rad),{a:n,b:o}=this.getChunkBoundsCoords(e,s);for(var r=n.y;r<=o.y;r++)for(var i=n.x;i<=o.x;i++)void 0!==this.map[`${i}-${r}`]&&this.map[`${i}-${r}`].delete(t.id)},ChunkSystem.prototype.getChunkBoundsCoords=function(t,e){return{a:SPTensors.copy(t,t=>Math.floor(t/this.chunkSize)),b:SPTensors.copy(SPTensors.add(t,e),t=>Math.floor(t/this.chunkSize))}},ChunkSystem.prototype.getObjectsInRect=function(t,e,s){let n=new Set,{a:o,b:r}=this.getChunkBoundsCoords(t,e),i=SPTensors.link([t,e],[4]);for(var a=o.y;a<=r.y;a++)for(var h=o.x;h<=r.x;h++)void 0!==this.map[`${h}-${a}`]&&this.map[`${h}-${a}`].forEach(t=>{if(this.coordinator.entities[t]){var e=this.coordinator.entities[t];if(!s||s(e)){var o=posRadToBounds(e.tran.pos,e.rig.rad),r=SPTensors.link([o.pos,o.dims],[4]);SPMath.rectCollision(i,r)&&n.add(e)}}});return n},VelocitySystem.prototype=Object.create(System.prototype),VelocitySystem.prototype.update=function(t){for(let e of this.getEntities())e.tran.pos.add(SPTensors.mult(e.mov.vel,t)),e.mov.vel.add(SPTensors.mult(e.mov.acc,t))},RenderingSystem.prototype=Object.create(System.prototype),RenderingSystem.prototype.update=function(t){for(let t of this.getEntities()){this.renderer.setColor(t.mat.color);let e=t.tran.pos,s=t.rig.rad;if(this.transformer&&(e=this.transformer.transformPoint(e),s=this.transformer.transformScale(s)),"aabb"==t.rig.shape)this.renderer.drawRect(SPTensors.sub(e,s),SPTensors.mult(s,2));else if("circle"==t.rig.shape)this.renderer.fillCircle(e,s.x);else if("polygon"==t.rig.shape){let s=SPMath.rotatePolygon(t.rig.polygon,SPTensors.vector([0,0]),-t.tran.rot);this.renderer.fillPolygon(SPTensors.add(s,e,!0))}else assert(!1,`${t.rig.shape} is not supported by RenderingSystem`)}},EyeSystem.prototype=Object.create(System.prototype),EyeSystem.prototype.update=function(t){for(let t of this.getEntities()){var e=[],s=t.tran.pos.copy(),n=t.tran.pos.copy();(e=SPMath.polarPoints(t.eyes.count,t.tran.pos,t.eyes.radius,t.tran.rot,t.eyes.angle)).forEach(t=>{(!s.x||t.x<s.x)&&(s.x=t.x),(!s.y||t.y<s.y)&&(s.y=t.y),(!n.x||t.x>n.x)&&(n.x=t.x),(!n.y||t.y>n.y)&&(n.y=t.y)});var o=this.chunkSystem.getObjectsInRect(s,SPTensors.sub(n,s),e=>t.eyes.types.allowed(e.meta.type));t.eyes.output=[],renderer.setColor("rgb(0, 0, 0, 0.5)"),e.forEach((e,s)=>{let n=SPTensors.link([t.tran.pos,e],[2,2]);var r=0;o.forEach(e=>{if(e.id!=t.id){var s=posRadToRect(e.tran.pos,e.rig.rad),o=SPMath.rectToPolygon(s);SPMath.polygoneLineIntersection(n,o).forEach(e=>{var s=1-SPMath.distance(t.tran.pos,e)/t.eyes.radius;s>r&&(r=s)})}}),t.eyes.output.push(r),r>0&&renderer.drawLine(t.tran.pos,e)})}},MouseFollowerSystem.prototype=Object.create(System.prototype),MouseFollowerSystem.prototype.update=function(t){for(let t of this.getEntities()){t.tran.pos=mouseListener.m.copy(),chunkSystem.getObjectsInRect(SPTensors.sub(t.tran.pos,t.rig.rad),SPTensors.mult(t.rig.rad,2)).forEach(t=>{t.mat.color="red"})}},AvoiderSystem.prototype=Object.create(System.prototype),AvoiderSystem.prototype.update=function(t){for(let t of this.getEntities())if(t.eyeOutput){let e=SPTensors.vector(t.eyeOutput).reshape([1,t.eyeCount]),s=t.dnn.forward(e);t.rot+=s.x/10,t.vel=SPMath.getUnitVector(t.rot).mult(5*s.y)}},WorldFoldingSystem.prototype=Object.create(System.prototype),WorldFoldingSystem.prototype.update=function(t){for(entity of this.getEntities())SPMath.rectContains(this.bounds,entity.tran.pos)||(entity.tran.pos.x=SPMath.posmodRange(entity.tran.pos.x,this.bounds.x,this.bounds.x+this.bounds.width),entity.tran.pos.y=SPMath.posmodRange(entity.tran.pos.y,this.bounds.y,this.bounds.y+this.bounds.height),this.onObjectPorted&&this.onObjectPorted(entity))},EvolutionSystem.prototype=Object.create(System.prototype),Object.defineProperty(EvolutionSystem.prototype,"period",{get:function(){return this.timer.length},set:function(t){return this.timer.length=t,this.timer.lap(),this.timer.length}}),EvolutionSystem.prototype.update=function(t){if(this.timer.isDone()){var e=Array.from(this.getEntities());for(let t of this.spiecesTypes){var s=e.filter(e=>e.evolution.spieces==t);s.sort((t,e)=>e.evolution.fitness-t.evolution.fitness),this.spieces[t].onGenerationEnds(s)}this.timer.lap()}else for(let t of this.getEntities())t.fitness=this.spieces[t.evolution.spieces].fitnessFunction(t)},CollisionSystem.prototype=Object.create(System.prototype),CollisionSystem.prototype.update=function(){for(let s of this.getEntities()){var t=entityGetBounds(s),e=this.chunkSystem.getObjectsInRect(t.pos,t.dims);for(let t of e)s.id!=t.id&&this.onCollision(s,t)}},DraggingSystem.prototype=Object.create(System.prototype),DraggingSystem.prototype.update=function(t){let e=this.mouseListener.pressedButtons[this.button];!this.dragging&&e&&(this.dragging=!0,this.dragStart=this.mouseListener.m.copy()),this.dragging&&e&&this.renderer.drawRect(SPMath.getRect(this.dragStart,this.mouseListener.m)),this.dragging&&!e&&(this.onDragFinished&&this.onDragFinished(SPMath.getRect(this.dragStart,this.mouseListener.m)),this.dragging=!1)},Renderer2D.prototype.setColor=function(t){this.ctx.fillStyle=t,this.ctx.strokeStyle=t},Renderer2D.prototype.drawLine=function(t,e){this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y),this.ctx.lineTo(e.x,e.y),this.ctx.stroke()},Renderer2D.prototype.rectPath=function(t,e){void 0===e?(this.ctx.beginPath(),this.ctx.rect(t.x,t.y,t.width,t.height)):(this.ctx.beginPath(),this.ctx.rect(t.x,t.y,e.x,e.y))},Renderer2D.prototype.drawRect=function(t,e){this.rectPath(t,e),this.ctx.stroke()},Renderer2D.prototype.fillRect=function(t,e){this.rectPath(t,e),this.ctx.fill()},Renderer2D.prototype.circlePath=function(t,e,s=0,n=360){this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e,s,n)},Renderer2D.prototype.drawCircle=function(t,e,s=0,n=360){this.circlePath(t,e,s,n),this.ctx.stroke()},Renderer2D.prototype.fillCircle=function(t,e,s=0,n=360){this.circlePath(t,e,s,n),this.ctx.fill()},Renderer2D.prototype.polygonPath=function(t,e=!0){this.ctx.beginPath();var s=t.subTensor([0]);this.ctx.moveTo(s.x,s.y);let n=t.shape[0];for(var o=1;o<n;o++){var r=t.subTensor([o]);this.ctx.lineTo(r.x,r.y)}e&&this.ctx.closePath()},Renderer2D.prototype.drawPolygon=function(t,e=!0){this.polygonPath(t,e),this.ctx.stroke()},Renderer2D.prototype.fillPolygon=function(t){this.polygonPath(t),this.ctx.fill()},Renderer2D.prototype.drawText=function(t,e){this.ctx.fillText(t,e.x,e.y)},Renderer2D.prototype.drawFunction=function(t,e,s,n,o){for(var r=[],i=null,a=null,h=e;h<s;h+=n){var p=t(h);(!i||p<i)&&(i=p),(!a||p>a)&&(a=p),r.push([h,p])}var u=[],c=r.length,l=o.width/(c-1),d=a-i;for(h=0;h<c;h++){var y=r[h],f=o.x+l*h;p=o.y+(1-(y[1]-i)/d)*o.height;u.push(f),u.push(p)}if(SPMath.inRange(0,i,a)){var g=o.y+(1-(0-i)/d)*o.height;this.drawLine(SPMath.point(o.x,g),SPMath.point(o.x+o.width,g))}this.drawPolygon(new Tensor([c,2],u),!1),this.drawText(a.toFixed(2),SPMath.point(o.x+o.width,o.y)),this.drawText(i.toFixed(2),SPMath.point(o.x+o.width,o.y+o.height)),this.drawText(e.toFixed(2),SPMath.point(o.x,o.y+o.height+20)),this.drawText(s.toFixed(2),SPMath.point(o.x+o.width,o.y+o.height+20))},TransformedRenderer2D.prototype=Object.create(Renderer2D.prototype),TransformedRenderer2D.prototype.drawLine=function(t,e){Renderer2D.prototype.drawLine.call(this,...this.transformer.transformPoints(t,e))},TransformedRenderer2D.prototype.circlePath=function(t,e,s=0,n=360){Renderer2D.prototype.circlePath.call(this,this.transformer.transformPoint(t),e,s,n)},TransformedRenderer2D.prototype.polygonPath=function(t,e=!0){Renderer2D.prototype.polygonPath.call(this,this.transformer.transformPolygon(t),e)},Canvas.prototype.fullScreen=function(){return this.resize(window.innerWidth,window.innerHeight),this},Canvas.prototype.resize=function(t,e){return this.width=t,this.height=e,this.canvas.width=t,this.canvas.height=e,this},Canvas.prototype.renderBackground=function(){this.ctx.beginPath(),this.ctx.rect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="white",this.ctx.fill()},Canvas.prototype.clear=function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.renderBackground()},MouseListener.prototype.initListener=function(){return this.target.onmousedown=(t=>{this.pressedButtons[t.button]=!0,this.onUpdate(t)}),this.target.onmouseup=(t=>{this.pressedButtons[t.button]=!1,this.onUpdate(t)}),this.target.onmousemove=(t=>{let e=this.m.x,s=this.m.y;this.m.x=t.clientX,this.m.y=t.clientY,this.dm.x=this.m.x-e,this.dm.y=this.m.y-s,this.onUpdate(t)}),this},Camera.prototype.transformPoint=function(t){var e=Math.sin(this.rot),s=Math.cos(this.rot);let{x:n,y:o}=t;var r=this.scale.x*((n-this.pos.x)*s-(-o+this.pos.y)*e)+this.screenSize.x/2,i=this.scale.y*((n-this.pos.x)*e+(-o+this.pos.y)*s)+this.screenSize.y/2;return SPTensors.vector([r,i])},Camera.prototype.transformPoints=function(...t){var e=[];return t.forEach(t=>{e.push(this.transformPoint(t))}),e},Camera.prototype.transformPolygon=function(t){var e=t.copy();let s=t.shape[0];for(var n=0;n<s;n++){var o=this.transformPoint(t.subTensor([n]));e.set(2*n,o.x),e.set(2*n+1,o.y)}return e},Camera.prototype.inverseTransformPoint=function(t){var e=Math.sin(this.rot),s=Math.cos(this.rot);let{x:n,y:o}=t;var r=this.pos.y-(-e*(n/this.scale.x-this.screenSize.x/2)+s*(o/this.scale.y-this.screenSize.y/2)),i=s*(n/this.scale.x-this.screenSize.x/2)+e*(o/this.scale.y-this.screenSize.y/2)+this.pos.x;return SPTensors.vector([i,r])},Camera.prototype.transformScale=function(t){return SPTensors.mult(t,this.scale)},DevUI.prototype.refresh=function(){for(const t of Object.keys(this.stateListeners))this.stateListeners[t](this.stateContainer[t])},DevUI.prototype.addRange=function(t,e=0,s=5,n=1,o){void 0===o?o=this.stateContainer[t]:this.stateContainer[t]=o;let r=document.createElement("div");r.className="spool-devui-range",r.style.paddingBottom="0.3em",r.style.paddingTop="0.3em";let i=document.createElement("p");i.innerHTML=t+": "+o,this.stateListeners[t]=(e=>{i.innerHTML=t+": "+e,a.value=e}),i.style.margin="0px",r.appendChild(i);let a=document.createElement("input");a.type="range",a.min=e,a.max=s,a.step=n,a.value=o,a.className="spool-devui-range-input",a.style.width="100%",a.oninput=(e=>{i.innerHTML=t+": "+e.target.value,this.stateContainer[t]=e.target.value,e.preventDefault()}),r.appendChild(a),this.root.appendChild(r)},DevUI.prototype.addButton=function(t,e){let s=document.createElement("div");s.style.paddingTop="0.3em",s.style.paddingBottom="0.3em";var n=document.createElement("button");n.innerHTML=t,n.style.width="100%",n.onclick=e,n.style.borderRadius="10px",s.appendChild(n),this.root.appendChild(s)};
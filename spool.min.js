const CAMERA_ROTATION_SPEED=.05,CAMERA_FOLLOW_SPEED=.4,CAMERA_SCALE_SPEED=.02,CAMERA_MINIMAL_SCALE=.5,CAMERA_MAXIMAL_SCALE=1,CAMERA_MAXIMAL_SCALE_HANDLEVEL=35;var Client=e=>{var t={keyToConstructor:{},spoolKeyToConstructor:{SPL_POINT:{const:Point},SPL_LINE:{const:Line},SPL_RECT:{const:Rectangle}},onMouseEvent:e=>{},onKeyEvent:e=>{},lastTime:0,frameCounter:0,chunkSize:1e3,FPS:60,pureLocalClient:!1,updateOnLoop:!1,serverSideLoading:!1,clientSideLoading:!1,...e};return t.frameTime=1e3/t.FPS,t.clientId=void 0,t.clientObject=void 0,t.width=window.innerWidth,t.height=window.innerHeight,t.gameArea=GameArea(t.width,t.height),t.camera=Camera({width:t.width,height:t.height,canvasWidth:t.width,canvasHeight:t.height}),t.handler=ClientHandler(t.chunkSize,t,t.pureLocalClient),t.uiHandler=SpoolUIHandler(),t.objectServer=ClientObjectServer(t),t.socketInit=(()=>{t.pureLocalClient&&console.warn("You've set the pureLocalClient flag to true, but are initializing sockets."),t.socket=io(),t.socket.on(MessageCodes.SM_PACK_INIT,e=>{for(key in e.resetHandler&&(t.handler.reset(),t.clientObject=void 0),e)if("resetHandler"!=key){var r=void 0;if(key in t.keyToConstructor?r=t.keyToConstructor[key]:key in t.spoolKeyToConstructor&&(r=t.spoolKeyToConstructor[key]),r)for(var o=0;o<e[key].length;o++){r.const||console.warn(`Spool: ${key} has invalid constructor function`);var n=r.const({...r.defs,...e[key][o]});n||console.error(`Object ${key} doesn't return anything, check if constructor returns self.`),n.clientInstance=t,t.handler.add(n)}else console.error(`Object ${key} doesn't have a constructor`)}t.firstInit||(t.onFirstLoad&&t.onFirstLoad(t),t.firstInit=!0)}),t.socket.on(MessageCodes.SM_RESET,e=>{t.client.handler.reset()}),t.socket.on(MessageCodes.ASIGN_CLIENT_ID,e=>{t.clientId=e.clientId,t.clientObjectFingerprint=e.clientObject}),t.socket.on(MessageCodes.SERVER_LOADING,e=>{console.log(e),t.serverSideLoading=e.loading,t.serverSideLoadingData=e}),t.socket.on(MessageCodes.SM_PACK_UPDATE,e=>{t.handler.update(e),t.camera.update(),t.clientId&&!t.clientObject&&(t.clientObject=t.handler.getObject(t.clientObjectFingerprint.objectType,t.clientObjectFingerprint.id),t.camera.followObject=t.clientObject,t.onClientObjectAssigned&&t.onClientObjectAssigned(t.clientObject))}),t.socket.on(MessageCodes.SM_PACK_REMOVE,e=>{console.log(),t.handler.removeBulk(e)}),t.objectServer.init(t.socket)}),t.emit=((e,r)=>{t.socket.emit(e,r)}),t.startGameLoop=(()=>{t.lastMillisTimer=Date.now(),t.lastMillis=Date.now(),t.lastFrameTime=Date.now(),t.loop()}),t.render=(()=>{try{t.background&&t.background(t.gameArea.ctx,t.camera),t.preHandler&&t.preHandler(t.gameArea.ctx,t.camera),t.handler.render(t.gameArea.ctx,t.camera),t.postHandler&&t.postHandler(t.gameArea.ctx,t.camera),t.uiHandler&&t.uiHandler.render(t.gameArea.ctx),t.postUi&&t.postUi(t.gameArea.ctx,t.camera)}catch(e){console.error(e.stack)}}),t.loop=(()=>{let e=Date.now();if(e-t.lastFrameTime>=t.frameTime){t.lastFrameTime;t.lastFrameTime=e,t.gameArea.clear(),t.loopUpdateCall&&(t.handler.update(),t.camera.update()),t.render(),Date.now()-t.lastMillisTimer>=1e3?(t.frameCounter=0,t.lastMillisTimer=Date.now()):t.frameCounter+=1}setTimeout(t.loop)}),t.initResizeListener=(()=>{window.onresize=(e=>{t.width=window.innerWidth,t.height=window.innerHeight,t.gameArea.resize(t.width,t.height),t.camera.width=t.width,t.camera.height=t.height})}),t},GameArea=(e=500,t=500)=>{var r={};return r.canvas=document.createElement("CANVAS"),r.resize=((e,t)=>{r.width=e,r.height=t,r.canvas.width=e,r.canvas.height=t}),r.resize(e,t),document.getElementById("spool-root").appendChild(r.canvas),r.canvas.oncontextmenu=function(e){e.preventDefault()},r.ctx=r.canvas.getContext("2d"),SpoolRenderer.ctx=r.ctx,SpoolRenderer.camera=r.camera,r.clear=(()=>{r.ctx.clearRect(0,0,r.canvas.width,r.canvas.height),r.renderBackground()}),r.renderBackground=(()=>{r.ctx.beginPath(),r.ctx.rect(0,0,r.canvas.width,r.canvas.height),r.ctx.fillStyle="white",r.ctx.fill()}),r},TextureManager=(e,t)=>{var r={spriteSheetInitObject:e,objectSheetInitObject:t,spriteSheets:{},objectSheets:{},onLoad:null,loadCounter:0,targetLoad:0,chunkBlankSize:500,chunkBlankImage:null,load:()=>{r.textures={};var e=Object.keys(r.spriteSheetInitObject);r.targetLoad=e.length,e.forEach(e=>{var t=new Image;t.onload=(()=>{var o=(k=document.createElement("canvas")).getContext("2d"),n=r.spriteSheetInitObject[e].r?r.spriteSheetInitObject[e].r:1,a=r.spriteSheetInitObject[e].c?r.spriteSheetInitObject[e].c:1,i=t.width/a,s=t.height/n;k.width=i,k.height=s;for(var l=[],h=[],c=0;c<n;c++)for(var d=0;d<a;d++){o.clearRect(0,0,i,s),o.imageSmoothingEnabled=!1,o.drawImage(t,d*i,c*s,i,s,0,0,i,s);var u=new Image;u.src=k.toDataURL("image/png"),l.push(u);for(var p=new Image,y=o.getImageData(0,0,k.width,k.height),g=y.data,x=[],f=k.height-1;f>-1;f--){for(var m=[],v=0;v<k.width;v++)m.push(0,0,0,g[f*k.width*4+4*v+3]/2);x.push(...m)}for(var b=0,S=g.length;b<S;b++)g[b]=x[b];o.putImageData(y,0,0),p.src=k.toDataURL("image/png"),h.push(p)}r.spriteSheets[e]={title:e,textureMap:t,rows:n,columns:a,sprites:l,shadowSprites:h},r.loadCounter+=1,r.loadCounter>=r.targetLoad&&r.onLoad&&r.prepareChunkImage();var k;o=(k=document.createElement("canvas")).getContext("2d")}),t.src=r.spriteSheetInitObject[e].src})},getSubSpriteSheet:(e,t,o,n,a)=>{var i=n-t+1,s=a-o+1,l=[],h=[],c=r.spriteSheets[e];if(!c)return console.error(`${e} is not in the texture manager`),null;for(var d=o;d<=a;d++)for(var u=t;u<=n;u++){var p=d*c.columns+u;l.push(c.sprites[p]),h.push(c.shadowSprites[p])}return{textureMap:c.textureMap,rows:s,columns:i,sprites:l,shadowSprites:h}},getSprite:(e,t=0,o=0)=>r.spriteSheets[e]?r.spriteSheets[e].sprites[o*r.spriteSheets[e].columns+t]:(console.error(`@TextureManager: ${e} is not in spritesheets`),null),getSprites:e=>r.spriteSheets[e]?r.spriteSheets[e].sprites:(console.error(`@TextureManager: ${e} is not in spritesheets`),null),prepareChunkImage:()=>{var e=document.createElement("canvas");e.getContext("2d");e.width=r.chunkBlankSize,e.height=r.chunkBlankSize;var t=new Image;t.src=e.toDataURL("image/png"),r.chunkBlankImage=t,r.prepareObjectSheets()},prepareObjectSheets:()=>{r.objectSheetInitObject||console.error("Spool: Invalid objectSheetInitObject");var e=Object.keys(r.objectSheetInitObject);r.targetLoad=e.length,e.forEach(e=>{var o=t[e],n=r.spriteSheets[o.src],a=SpoolMath.numberDefined(o.x)?o.x:0,i=SpoolMath.numberDefined(o.y)?o.y:0,s=SpoolMath.numberDefined(o.xx)?o.xx:n.columns-1,l=SpoolMath.numberDefined(o.yy)?o.yy:n.rows-1,h=s-a+1,c=l-i+1;o.variantBox&&(h=o.variantBox.c,c=o.variantBox.r);for(var d=[],u=i;u<=l;u+=c)for(var p=a;p<=s;p+=h){var y=r.getSubSpriteSheet(o.src,p,u,p+h-1,u+c-1);y.title=e,d.push(y)}r.objectSheets[e]=d}),r.onLoad()},textureObj:e=>{var t=r.objectSheets[e.objectType];if(t){tid=e.textureId?e.textureId:0;var o=t[SpoolMath.randomInt(0,t.length-1)];e.sprite=o.sprites[tid%o.sprites.length],e.shadowSprite=o.shadowSprites[tid%o.sprites.length],e.texture=o}else"SPL_CHUNK"==e.objectType&&(e.sprite=r.chunkBlankImage)},resizeSprite:(e,t,r,o)=>{var n=document.createElement("canvas"),a=n.getContext("2d");n.width=t,n.height=r,a.imageSmoothingEnabled=!1,a.drawImage(e,0,0,t,r);var i=new Image;i.src=n.toDataURL("image/png"),i.onload=(()=>{o(i)})},resizeSprites:(e,t,r,o)=>{t&&r||console.warn("@textureManager resizedSprite: Width and height error");for(var n=0,a=[],i=e.length;i--;)a.push(1);var s=0,l=document.createElement("canvas"),h=l.getContext("2d");l.width=t,l.height=r,e.forEach(i=>{h.clearRect(0,0,t,r),h.imageSmoothingEnabled=!1,h.drawImage(i,0,0,t,r);var c=new Image;c.posInList=n,c.src=l.toDataURL("image/png"),c.onload=(t=>{a[t.target.posInList]=c,(s+=1)==e.length&&o(a)}),n++})},bakeIn:(e,t,r,o,n=null)=>{var a=document.createElement("canvas"),i=a.getContext("2d");a.width=e.width,a.height=e.height,i.imageSmoothingEnabled=!1,i.drawImage(e,0,0),i.drawImage(t,r.x,r.y,r.width,r.height);var s=new Image;s.src=a.toDataURL("image/png"),s.onload=(()=>{o(s,n)})},bakeBatch:(e,t,r,o)=>{var n=document.createElement("canvas"),a=n.getContext("2d");n.width=e.width,n.height=e.height,a.imageSmoothingEnabled=!1,a.drawImage(e,0,0),t.forEach(e=>{a.drawImage(e.bakedTexture,e.dBounds.x,e.dBounds.y,e.dBounds.width,e.dBounds.height)});var i=new Image;i.src=n.toDataURL("image/png"),i.onload=(()=>{r(i,o)})}};return r};cameraContainsEntity=((e,t)=>{let r=({x:x,y:y,width:width,height:height}=e.transformBounds(t.x,t.y,2*t.radius,2*t.radius));return 0<=r.x+r.width/2&&r.x-r.width/2<=e.width*e.scale&&0<=r.y+r.height/2&&r.y-r.height/2<=e.height*e.scale});var Grid=()=>{var e={rowGap:200,columnGap:200,render:(t,r)=>{for(var o=r.x-r.width*CAMERA.scale,n=r.y-r.width*CAMERA.scale;o<(r.x+r.width)/CAMERA.scale;){var a=r.y-r.width,i=r.y+r.width,s=o+-r.x%e.columnGap,l=o+-r.x%e.columnGap;let n=({x:x,y:y}=r.transformPoint(s,a));s=n.x,a=n.y;let h=({x:x,y:y}=r.transformPoint(l,i));l=h.x,i=h.y,t.beginPath(),t.moveTo(s,a),t.strokeStyle="gray",t.lineWidth=1,t.lineTo(l,i),t.stroke(),o+=e.columnGap}for(;n<(r.y+r.width)/CAMERA.scale;){var h=n+-r.y%e.rowGap,c=n+-r.y%e.rowGap,d=r.x-r.width,u=r.x+r.width;let o=({x:x,y:y}=r.transformPoint(d,h));d=o.x,h=o.y;let a=({x:x,y:y}=r.transformPoint(u,c));u=a.x,c=a.y,t.beginPath(),t.moveTo(d,h),t.strokeStyle="gray",t.lineTo(u,c),t.stroke(),n+=e.rowGap}}};return e},ObjectRadar=(e,t,r,o)=>{var n={handler:e,camera:t,objectType:r,radius:o,render:e=>{if(t.followObject&&n.objectType in n.handler.objects){var o=n.handler.objects[r];for(id in o){if(id==t.followObject.id)continue;var a=o[id];if(cameraContainsEntity(t,a))continue;var i=2*Math.PI-SpoolMath.objGlobalAngle(t.followObject,a)+t.rotation;e.fillStyle=a.color;let r=({x:x,y:y}=SpoolMath.polarPoint(t.width/2*t.scale,t.height/2*t.scale,200,i));var s=r.x,l=r.y;let n=({x:x,y:y}=SpoolMath.polarPoint(r.x,r.y,20,i+3*Math.PI/4)),h=({x:x,y:y}=SpoolMath.polarPoint(s,l,20,i+5*Math.PI/4));e.beginPath(),e.moveTo(r.x,r.y),e.lineTo(n.x,n.y),e.lineTo(h.x,h.y),e.closePath(),e.fill()}}}};return n},ClientObjectServer=(e,t=[])=>{var r={client:e,objects:{},init:()=>{r.client.socket.on(MessageCodes.OS_SEND_OBJ,e=>{r.add(e)})},load:e=>{r.client.socket.emit(MessageCodes.OS_GET_OBJ,e)},getObject:e=>{var t=e.objectType,o=e.id,n=r.objects[t];if(n){var a=n[o];if(a)return a}return null},add:e=>{e.objectType in r.objects||(r.objects[e.objectType]={}),r.objects[e.objectType][e.id]?Object.assign(r.objects[e.objectType][e.id],e):r.objects[e.objectType][e.id]=e},remove:(e,t)=>{e in r.objects&&delete r.objects[e][t]}};return r},ClientHandler=(e,t,r=!1)=>{var o=Handler({client:t,chunkSize:e,chunkConstructor:ClientChunk}),n={add:o.add};return r||(o.update=(e=>{for(key in e)if(o.objects[key])for(var t=0;t<e[key].length;t++){var r=e[key][t];if(o.objects[key][r.id]){var n={...r};delete n.id,o.objects[key][r.id].update(n),o.updateObjectsChunk(o.objects[key][r.id])}}})),o.onChunkCreated=(e=>{o.textureManager&&o.textureManager.textureObj(e)}),o.render=((e,t)=>{var r=Math.floor((t.x-t.width/2-100)/o.chunkSize),n=Math.floor((t.y-t.height/2-100)/o.chunkSize),a=Math.floor((t.x+t.width/2+100)/o.chunkSize),i=Math.floor((t.y+t.height/2+100)/o.chunkSize),s=o.getChunks(r,n,a,i),l={},h={};for(chunkKey in s){var c=s[chunkKey],d=c.objects;if(c.sprite){var u=t.transformBounds(c.x*o.chunkSize,(c.y+1)*o.chunkSize,o.chunkSize,o.chunkSize);e.drawImage(c.sprite,u.x,u.y,u.width,u.height)}for(key in d)for(id in d[key]){var p=c.objects[key][id];if(p.bakeIn){if(!p.bakedIn||!p.bakedIn.includes(c.key)){var y=p.getRenderBounds(),g=c.sprite.width/o.chunkSize,x=c.sprite.height/o.chunkSize,f={bakedTexture:p.sprite,dBounds:{x:(y.x-c.x*o.chunkSize)*g,y:(o.chunkSize-(y.y-c.y*o.chunkSize)-y.height)*x,width:y.width*g,height:y.height*x},attributes:{obj:p,chunk:c},callback:(e,t,r)=>{e.attributes.chunk.sprite=t,e.attributes.obj.bakedIn=!0}},m=c.key;m in h||(h[m]={}),p.layer in h[m]||(h[m][p.layer]=[]),h[m][p.layer].push(f)}}else p.layer in l?l[p.layer][id]=p:l[p.layer]={id:p}}}for(key in h)if(key in o.chunks){var v=[],b=[];Object.keys(h[key]).sort((e,t)=>parseInt(e)-parseInt(t)).forEach(e=>{h[key][e].forEach(e=>{v.push({bakedTexture:e.bakedTexture,dBounds:e.dBounds}),b.push(e.attributes.obj)})}),callback=((e,t)=>{o.chunks[t.key].sprite=e,b.forEach(e=>{e.bakedIn?e.bakedIn.push(t.key):e.bakedIn=[t.key]})}),o.textureManager.bakeBatch(o.chunks[key].sprite,v,callback,{key:key})}else console.warn("invalid chunk added to baking:",key);Object.keys(l).sort((e,t)=>parseInt(e)-parseInt(t)).forEach(r=>{Object.keys(l[r]).sort((e,t)=>l[r][t].y-l[r][e].y).forEach(o=>{l[r][o].render(e,t)})})}),o.preBake=(()=>{var e=o.chunks,t={};for(chunkKey in e){var r=e[chunkKey],n=r.objects;for(key in n)for(id in n[key]){var a=r.objects[key][id];if(o.updateObjectsChunk(a),a.bakeIn&&(!a.bakedIn||!a.bakedIn.includes(r.key))){var i=a.getRenderBounds(),s=r.sprite.width/o.chunkSize,l=r.sprite.height/o.chunkSize,h={bakedTexture:a.sprite,dBounds:{x:(i.x-r.x*o.chunkSize)*s,y:(o.chunkSize-(i.y-r.y*o.chunkSize)-i.height)*l,width:i.width*s,height:i.height*l},callback:(e,t)=>{t.chunk.sprite=e,t.obj.bakedIn=!0},attributes:{obj:a,chunk:r}},c=r.key;c in t||(t[c]={}),a.layer in t[c]||(t[c][a.layer]=[]),t[c][a.layer].push(h)}}}for(key in t)if(key in o.chunks){var d=[],u=[];Object.keys(t[key]).sort((e,t)=>parseInt(e)-parseInt(t)).forEach(e=>{t[key][e].forEach(e=>{d.push({bakedTexture:e.bakedTexture,dBounds:e.dBounds}),u.push(e.attributes.obj)})}),callback=((e,t)=>{o.chunks[t.key].sprite=e,t.waitingList.forEach(e=>{e.bakedIn?e.bakedIn.push(t.key):e.bakedIn=[t.key]})}),o.textureManager.bakeBatch(o.chunks[key].sprite,d,callback,{key:key,waitingList:u})}else console.warn("invalid chunk added to baking")}),o.add=(e=>{n.add(e),o.textureManager&&o.textureManager.textureObj(e)}),o.removeBulk=(e=>{for(key in e)if(key in o.objects)for(var t=0;t<e[key].length;t++)e[key][t]in o.objects[key]&&o.remove(o.objects[key][e[key][t]])}),o.reset=(()=>{var r={objects:{},objectsById:{},chunks:{},client:t,chunkSize:e};Object.keys(r).forEach(e=>{delete o.key}),Object.assign(o,r)}),o},ClientChunk=(e,t)=>{return Chunk({objectType:"SPL_CHUNK",...e},t)},Camera=(e={})=>{var t={x:0,y:0,rotation:0,width:0,height:0,canvasWidth:0,canvasHeight:0,scaleX:1,scaleY:1,followSpeed:.4,rotationSpeed:.05,followObject:null,offsetX:0,offsetY:0,...e,update:()=>{if(t.followObject){if(t.lerpRotation&&(t.rotation=SpoolMath.lerpRotation(t.rotation,t.followObject.rotation-Math.PI/2,t.rotationSpeed)),t.lerpSpeedToScale)t.followObject.velocity&&t.followObject.velocity;t.width=t.canvasWidth/t.scaleX,t.height=t.canvasHeight/t.scaleY,t.lerp&&(t.x=SpoolMath.lerp(t.x,t.followObject.x+t.offsetX,t.followSpeed),t.y=SpoolMath.lerp(t.y,t.followObject.y+t.offsetY,t.followSpeed))}else t.followObject&&(t.x=t.followObject.x+t.offsetX,t.y=t.followObject.y+t.offsetY);t.onUpdate&&t.onUpdate(t)},transformBounds:(e,r,o,n)=>{let a=({x:e,y:r}=t.transformPoint(e,r));return{x:a.x,y:a.y,width:o*t.scaleX,height:n*t.scaleY}},transformPoint:(e,r)=>{var o=Math.sin(t.rotation),n=Math.cos(t.rotation);return{x:t.scaleX*((e-t.x)*n-(-r+t.y)*o+t.width/2),y:t.scaleY*((e-t.x)*o+(-r+t.y)*n+t.height/2)}},transformDimension:e=>t.scaleX*e,clickTransfer:(e,r)=>{var o=SpoolMath.distance(e,r,t.width/2,t.height/2),n=t.rotation+Math.atan2(r-t.height/2,e-t.width/2);return{x:t.x+Math.cos(n)*o,y:t.y+Math.sin(n)*o}},inverseTransformPoint:(e,r)=>{var o=Math.sin(t.rotation),n=Math.cos(t.rotation),a=t.y-(-o*(e/t.scaleX-t.width/2)+n*(r/t.scaleY-t.height/2));return{x:n*(e/t.scaleX-t.width/2)+o*(r/t.scaleY-t.height/2)+t.x,y:a}},setFollowObject:e=>{e&&(t.followObject=e,t.angle=e.angle)}};return t},ClientEntity=(e,t=null)=>{var r={x:0,y:0,rotation:0,radius:10,color:"red",layer:10,animationCounter:0,animationTime:0,animationFrame:0,animationSize:0,...e};if(t)var o=t(r);else o=r;return o.update=(e=>{Object.assign(o,e)}),o.render=((e,t)=>{o.renderOval(e,t)}),o.renderOval=((e,t,r=o.color)=>{e.fillStyle=r;var n=t.transformBounds(o.x,o.y,o.width,o.height);SpoolRenderer.fillInscribedOval(new SpoolRect(n.x-n.width/2,n.y-n.height/2,n.width,n.height))}),o.renderNtagon=((e,t,r,n,a=0,i=o.color)=>{e.fillStyle=i,e.beginPath();var s=t.transformBounds(o.x,o.y,n,n),l=s.width;e.moveTo(s.x-l*Math.cos(a),s.y-l*Math.sin(a));for(var h=1;h<r;h++)angle=a+2*Math.PI/r*h,e.lineTo(s.x-l*Math.cos(angle),s.y-l*Math.sin(angle));e.closePath(),e.fill()}),o.renderRectangle=((e,t,r=o.color)=>{var n=t.transformBounds(o.x,o.y,o.width,o.height);e.beginPath(),e.lineWidth="1",e.rect(Math.floor(n.x-n.width/2),Math.floor(n.y-n.height/2),n.width,n.height),e.fillStyle=r,e.fill()}),o.renderSprite=((e,t,r=o.sprite,n=null)=>{if(r){var a;if(n)a=n;else{var i=o.width,s=o.height,l=o.x,h=o.y;o.clientWidth&&(i=o.clientWidth),o.clientHeight&&(s=o.clientHeight);var c=t.transformBounds(l,h,i,s),d=o.width/2,u=o.height/2;o.clientOffsetX&&(d=o.clientOffsetX),o.clientOffsetY&&(u=o.clientOffsetY);var p=t.transformBounds(l,h,d,u);e.imageSmoothingEnabled=!1,a={x:c.x-p.width,y:c.y-p.height,width:c.width,height:c.height}}return e.drawImage(r,a.x,a.y,a.width,a.height),o.showBounds&&o.renderRectangle(e,t,o.color),a}return o.renderRectangle(e,t,"violet"),null}),o.renderRotatedSprite=((e,t,r,o,n,a,i)=>{e.save();var s=t.transformPoint(r,o);e.translate(s.x,s.y),e.rotate(n),e.drawImage(a,i.x,i.y,i.width,i.height),e.restore()}),o.getMovementAnimationSpriteIndex=((e=o.moving,t=o.movementAngle)=>{var r=o.texture.rows-1;if(e){var n=t;n<0&&(n+=2*Math.PI),(n=n/Math.PI/2+1/r/2)<0&&(n+=1),n%=1;var a=Math.floor(n*r)%r+1}else a=0;return a*o.texture.columns+o.animationFrame}),o.renderMovementAnimation=((e,t,r=null)=>{if(r)var n=r;else n=o.getMovementAnimationSpriteIndex();return o.animationCounter==o.animationTime?(o.texture&&(o.animationFrame+=1,o.animationFrame==o.texture.columns&&(o.animationFrame=0)),o.animationCounter=0):o.animationCounter+=1,[o.renderSprite(e,t,o.texture.sprites[n]),n]}),o.getRenderBounds=((e=null)=>{if(e){l=o.width,h=o.height;var t=o.x,r=o.y;o.clientWidth&&(l=o.clientWidth),o.clientHeight&&(h=o.clientHeight);s=e.transformBounds(t,r,l,h),a=o.width/2,i=o.height/2;o.clientOffsetX&&(a=o.clientOffsetX),o.clientOffsetY&&(i=o.clientOffsetY);var n=e.transformBounds(t,r,a,i);return ctx.imageSmoothingEnabled=!1,finalBounds={x:s.x-n.width,y:s.y-n.height,width:s.width,height:s.height},finalBounds}var a=o.width/2,i=o.height/2;o.clientOffsetX&&(a=o.clientOffsetX),o.clientOffsetY&&(i=o.clientOffsetY);var s,l=o.width,h=o.height;return o.clientWidth&&(l=o.clientWidth),o.clientHeight&&(h=o.clientHeight),s={x:o.x-a,y:o.y-i,width:l,height:h}}),o},RectangleEntity=e=>{var t=ClientEntity(e);return t.render=((e,r)=>{t.renderRectangle(e,r)}),t},SpriteEntity=e=>{var t=ClientEntity(e);return t.render=((e,r)=>{t.renderSprite(e,r)}),t},MovementAnimationEntity=e=>{var t=ClientEntity({...e,animationTime:5});return t.render=((e,r)=>{t.renderMovementAnimation(e,r)}),t},Point=e=>{var t={x:0,y:0,xx:0,yy:0,color:"green",...e,update:e=>{Object.assign(t,e)},render:(e,r)=>{e.fillStyle=t.color,e.beginPath();let{x:o,y:n,width:a}=r.transformBounds(t.x,t.y,3,3);e.arc(o,n,a,0,360),e.stroke()}};return t},Line=e=>{var t=Entity({x:0,y:0,xx:0,yy:0,color:"green",...e});return t.render=((e,r)=>{let o=r.transformPoint(t.x,t.y);var n=r.transformPoint(t.xx,t.yy);e.strokeStyle=t.color,e.beginPath(),e.moveTo(o.x,o.y),e.lineTo(n.x,n.y),e.stroke()}),t},Rectangle=e=>{var t={x:0,y:0,xx:0,yy:0,color:"green",...e,update:e=>{Object.assign(t,e)},render:(e,r)=>{let o=r.transformPoint(t.x,t.y);var n=r.transformPoint(t.xx,t.yy);e.beginPath(),e.lineWidth="1",e.rect(o.x,o.y,n.x-o.x,n.y-o.y),t.fill?(e.fillStyle=t.color,e.fill()):(e.strokeStyle=t.color,e.stroke())}};return t},KeyboardListener=(e,t)=>{var r={client:e,keyListeners:{65:{inputMessage:MessageCodes.KI_MOV_LEFT,parameter:"pressedLeft"},87:{inputMessage:MessageCodes.KI_MOV_UP,parameter:"pressedUp"},68:{inputMessage:MessageCodes.KI_MOV_RIGHT,parameter:"pressedRight"},83:{inputMessage:MessageCodes.KI_MOV_DOWN,parameter:"pressedDown"}},additionalKeyListeners:{},activeTypes:["keydown","keyup"],...t};return r.handleKeyDown=r.activeTypes.includes("keydown"),r.handleKeyUp=r.activeTypes.includes("keyup"),Object.assign(r.keyListeners,r.additionalKeyListeners),r.onEvent=((e,t)=>{e.keyCode in r.keyListeners&&(listener=r.keyListeners[e.keyCode],r.client.pureLocalClient?r.client.clientObject&&(r.client.clientObject[listener.parameter]=t):r.client.socket.emit(MessageCodes.SM_KEY_PRESS,{inputId:listener.inputMessage,value:t}))}),r.initListener=(()=>{document.onkeydown=(e=>{r.handleKeyDown&&r.onEvent(e,!0),r.onKeyDown&&r.onKeyDown(e)}),document.onkeyup=(e=>{r.handleKeyUp&&r.onEvent(e,!1),r.onKeyUp&&r.onKeyUp(e)})}),r},MouseListener=(e,t)=>{var r={client:e,mouseCoordTransformation:null,activeButtons:[0,2],activeTypes:["mousedown","mouseup"],pressed:!1,...t,onMouseButtonEvent:(t,o,n)=>{r.client.uiHandler.mouseEvent(t)||(r.gamePlaneMouseButtonEvent(t,o,n),r.client.onMouseEvent(t,e))},gamePlaneMouseButtonEvent:(t,o,n)=>{if(r.activeButtons.includes(t.button)&&r.activeTypes.includes(t.type)){var a="mousedown"==t.type||"mouseup"!=t.type&&null;if(null===a)return void console.error("@MouseListener, event value is null");r.client.pureLocalClient?e.clientObject.mouseEventInWorld&&e.clientObject.mouseEventInWorld(o,n,t):r.client.socket.emit(MessageCodes.SM_MOUSE_INPUT,{x:o,y:n,value:a,type:t.type})}},initListener:()=>{document.onmousedown=(e=>{var t=e.clientX,o=e.clientY;if(r.pressed=!0,r.mouseCoordTransformation){var n=r.mouseCoordTransformation(t,o);t=n.x,o=n.y}r.onMouseDown&&r.onMouseDown(e,t,o),r.onMouseButtonEvent(e,t,o)}),document.onmouseup=(e=>{var t=e.clientX,o=e.clientY;if(r.pressed=!1,r.mouseCoordTransformation){var n=r.mouseCoordTransformation(t,o);t=n.x,o=n.y}r.onMouseUp&&r.onMouseUp(e,t,o),r.onMouseButtonEvent(e,t,o)}),document.onmousemove=(e=>{r.onMouseMove&&r.onMouseMove(e),r.client.uiHandler.mouseMove(e)})}};return r};const FileReader={readImage:(e,t,r=4)=>{var o=new Image;o.onload=(()=>{var e=document.createElement("canvas");e.width=o.width,e.height=o.height;var n=e.getContext("2d");n.drawImage(o,0,0,o.width,o.height);var a=n.getImageData(0,0,o.width,o.height);t({data:a.data,width:a.width,height:a.height,pixelSize:r})}),o.src=e}};try{SpoolMath=require("./spoolmath.js").SpoolMath}catch(e){console.warn("SpoolMath require importing failed, require is most likely not present, make sure you are importing SpoolMath in another way")}try{SpoolUtils=require("./spoolutils.js").SpoolUtils}catch(e){console.warn("SpoolUtils require importing failed, require is most likely not present, make sure you are importing SpoolMath in another way")}try{FileReader=require("../spoolfilereader.js").FileReader}catch(e){console.warn("FileReader require importing failed, require is most likely not present, make sure you are importing SpoolMath in another way")}try{var Perlin=require("perlin-noise")}catch(e){console.warn("Perlin noise is not available without require (server side)")}var Chunk=(e,t)=>{var r={x:0,y:0,width:0,height:0,handler:t,objects:{},...e,add:e=>{e.objectType in r.objects||(r.objects[e.objectType]={}),r.objects[e.objectType][e.id]=e},removeSignature:(e,t)=>{e in r.objects&&delete r.objects[e][t]},remove:e=>{r.removeSignature(e.objectType,e.id)},getClosestObject:(e,t,o)=>{var n=null;for(key in r.objects)if(!o||!o.whitelist||o.whitelist.includes(key))for(id in r.objects[key]){var a=r.objects[key][id],i=SpoolMath.distance(e,t,a.x,a.y);(!n||i<n.distance)&&(n={object:a,distance:i})}return n}};return r},Handler=(e={})=>{var t={objectsById:{},objects:{},chunks:{},staticKeys:[],preManagers:[],managers:[],chunkSize:300,chunkConstructor:Chunk,...e,resetObjects:()=>{Object.assign(t,{objectsById:{},objects:{},chunks:{}})},updateObjectsChunk:e=>{var r=!1,o=Math.floor((e.x-e.width/2)/t.chunkSize),n=Math.floor((e.y-e.height/2)/t.chunkSize),a=Math.floor((e.x+e.width/2)/t.chunkSize),i=Math.floor((e.y+e.height/2)/t.chunkSize);if(e.chunks)if(0==e.chunks.length)r=!0;else{if(o==e.chunksX&&n==e.chunksY&&a==e.chunksXX&&i==e.chunksYY)return;r=!0,e.chunks.forEach(t=>{t.remove(e)})}else r=!0;if(r&&(e.chunksX=o,e.chunksY=n,e.chunksXX=a,e.chunksYY=i,e.chunks=[],r))for(var s=o;s<a+1;s++)for(var l=n;l<i+1;l++){var h=`[${s};${l}]`,c=void 0;h in t.chunks?c=t.chunks[h]:(c=t.chunkConstructor({x:s,y:l,width:t.chunkSize,height:t.chunkSize,key:h,color:SpoolMath.randomHsvColor(.5,.8)},t),t.chunks[h]=c,t.onChunkCreated&&t.onChunkCreated(c)),c.add(e),e.chunks.push(c),e.chunkColor=c.color}},update:()=>{for(key in t.objects)if(!t.staticKeys.includes(key)){var e=t.objects[key];for(objKey in e){var r=e[objKey];if(!r.static){for(var o=0;o<t.preManagers.length;o++)t.preManagers[o].update(r);t.updateObjectsChunk(r),r.update();for(o=0;o<t.managers.length;o++)t.managers[o].update(r)}}}for(o=0;o<t.managers.length;o++)t.managers[o].handlerUpdate&&t.managers[o].handlerUpdate()},add:e=>{e.objectType in t.objects||(t.objects[e.objectType]={}),t.objects[e.objectType][e.id]=e,t.objectsById[e.id]=e,t.updateObjectsChunk(e)},removeSignature:(e,r)=>{e in t.objects&&(t.objects[e][r]&&t.objects[e][r].chunks&&t.objects[e][r].chunks.forEach(o=>{o.remove(t.objects[e][r])}),delete t.objects[e][r]),delete t.objectsById[r]},remove:e=>{t.removeSignature(e.objectType,e.id)},emptyObjectType:e=>{if(e in t.objects){var r=t.objects[e];Object.keys(r).forEach(r=>{t.remove(e,r)})}},getObject:(e,r)=>t.objects[e]&&t.objects[e][r]?t.objects[e][r]:null,getClosestObject:(e,r,o)=>{var n=Math.floor(e/t.chunkSize),a=Math.floor(r/t.chunkSize),i=null;if(t.getChunks(n,a,n,a).forEach(t=>{var n=t.getClosestObject(e,r,o);n&&(!i||n.distance<i.distance)&&(i=n)}),!i)for(key in t.chunks){var s=t.chunks[key].getClosestObject(e,r,o);s&&(!i||s.distance<i.distance)&&(i=s)}return i},addManager:e=>{t.managers.push(e)},addPreManager:e=>{t.preManagers.push(e)},getChunks:(e,r,o,n)=>{result=[];for(var a=e;a<=o;a++)for(var i=r;i<=n;i++){var s=`[${a};${i}]`;s in t.chunks&&result.push(t.chunks[s])}return result},getChunksForRect:e=>t.getChunks(Math.floor(e.x/t.chunkSize),Math.floor(e.y/t.chunkSize),Math.floor(e.xx/t.chunkSize),Math.floor(e.yy/t.chunkSize)),getObjectsInRect:(e,r=[],o=!0)=>{for(var n=t.getChunksForRect(e),a=[],i=0;i<n.length;i++){var s=n[i];for(bType in s.objects)if(onList=r.includes(bType),onList!=o)for(bKey in s.objects[bType]){var l=s.objects[bType][bKey];!l.SPL_COLL_MARKER&&e.collision(l.getBounds())&&(a.push(l),l.SPL_COLL_MARKER=!0)}}return a.forEach(e=>{delete e.SPL_COLL_MARKER}),a}};return t},CollisionManager=(e,t)=>{var r={handler:t,...e};return r.colPairs.forEach(e=>{e.a.forEach(t=>{e.b.forEach(o=>{r.colPairs.push({a:t,b:o,func:e.func,exception:e.exception,solid:void 0===e.solid||e.solid,solidException:e.solidException})})})}),r.getNeededChunks=(e=>{if(e.x>e.px)var t=e.px-e.width/2,o=e.x+e.width/2;else t=e.x-e.width/2,o=e.px+e.width/2;if(e.y>e.py)var n=e.py-e.height/2,a=e.y+e.height/2;else n=e.y-e.height/2,a=e.py+e.height/2;return r.handler.getChunksForRect(new SpoolRect(t,n,o-t,a-n))}),r.update=(e=>{var o=e.objectType;if(o in t.objects)for(var n=0;n<r.colPairs.length;n++){var a=r.colPairs[n].a,i=r.colPairs[n].harsh;if(o==a)for(var s=r.colPairs[n].b,l=r.getNeededChunks(e),h=0;h<l.length;h++){var c=l[h];if(s in c.objects)for(bKey in c.objects[s]){var d=e,u=c.objects[s][bKey];if(!(d.objectType==u.objectType&&d.id==u.id||r.colPairs[n].exception&&r.colPairs[n].exception(d,u))){if("oval"==d.bodyType&&"oval"==u.bodyType)var p=r.objectOvalCollision;else p=r.objectRectCollision;var y=p(d,u,i);y&&y.result&&(r.colPairs[n].solid&&y.point&&(r.colPairs[n].solidException&&r.colPairs[n].solidException(d,u)||(d.x=Math.round(y.point.x),d.y=Math.round(y.point.y))),r.colPairs[n].func&&r.colPairs[n].func(d,u,y))}}}}}),r.objectOvalCollision=((e,t)=>{if(aradius=Math.max(e.width,e.height)/2,bradius=Math.max(t.width,t.height)/2,SpoolMath.distance(e.x,e.y,t.x,t.y)<aradius+bradius){var r,o=parseInt(e.px),n=parseInt(e.py),a=parseInt(e.x),i=parseInt(e.y),s=bradius+aradius,l=parseInt(t.x),h=parseInt(t.y),c=0;if(o!=a){var d=(i-n)/(a-o),u=n-o*d,p=u-h,y=d*d+1,g=p*p+l*l-s*s,x=(-(b=2*d*p-2*l)+(S=Math.sqrt(Math.pow(b,2)-4*y*g)))/(2*y),f=(-b-S)/(2*y),m=d*x+u,v=d*f+u;SpoolMath.distance(x,m,o,n)<SpoolMath.distance(f,v,o,n)?(r=x,c=m):(r=f,c=v)}else{var b,S,k=o;y=1,g=h*h+l*l-s*s+k*k-2*l*k,m=(-(b=-2*h)+(S=Math.sqrt(b*b-4*y*g)))/(2*y),v=(-b-S)/(2*y);SpoolMath.distance(k,m,o,n)<SpoolMath.distance(k,v,o,n)?(r=k,c=m):(r=k,c=v)}return{result:!0,x:r,y:c}}return null}),r.objMovementLine=(e=>({x:e.px,y:e.py,xx:e.x,yy:e.y})),r.objectRectCollision=((e,t,r=!1)=>{var o=SpoolMath.movingRectCollision(e.getBounds(),t.getBounds(),{x:e.px,y:e.py},r);return o.result&&o.point&&o.direction&&("left"==o.direction||"right"==o.direction?o.point.y=(o.point.y+e.y)/2:o.point.x=(o.point.x+e.x)/2),o}),r},OuterWorldManager=(e,t)=>{var r={handler:e,validObjects:t,update:e=>{if(r.validObjects.includes(e.objectType)&&e.objectType in r.handler.objects){var t=SpoolMath.distance(e.x,e.y,0,0);t>OUTER_EDGE?e.setAcc("outer-world",t/500,SpoolMath.globalAngle(e.x,e.y,0,0)):e.setAcc("outer-world",0,0)}}};return r},GravityManager=(e,t)=>{var r={handler:t,gravityType:"homogenous",G:2,colPairs:[],...e,update:e=>{"homogenous"==r.gravityType?r.homGravity(e):r.vecGravity(e)},vecGravity:e=>{var o=e.objectType,n=e.accelerations.gravity?e.accelerations.gravity.angle:0;if(e.setAcc("gravity",0,n),!e.ground&&!e.gravityLock&&o in t.objects)for(var a=0;a<r.colPairs.length;a++){if(o==r.colPairs[a].a){var i=r.colPairs[a].b;if(i in t.objects)for(bKey in t.objects[i]){var s=e,l=t.objects[i][bKey];SpoolMath.objDistance(s,l)<bradius*GRAVITY_RADIUS_COEF&&s.addToAcc("gravity",r.objectGravity(s,l),SpoolMath.objGlobalAngle(s,l))}}}e.rotation=e.accelerations.gravity.angle+Math.PI},objectGravity:(e,t)=>{var o=r.G*e.mass*t.mass/Math.pow(SpoolMath.objDistance(e,t),GRAVITY_RADIUS_POW);return gravity=o/e.mass},homGravity:e=>{e.gravityIgnore||e.setAcc("gravity",r.G,Math.PI/2*3)}};return r},SpoolTimer=(e,t,r=null)=>{var o={startTime:Date.now(),duration:e,event:t,object:r,active:!0,timeLeft:0,update:()=>{o.timeLeft=o.startTime+o.duration-Date.now(),o.timeLeft<0&&o.active&&(o.event(r),o.active=!1)},stop:()=>{o.active=!1}};return o},ObjectSpawner=(e,t,r={})=>{var o={keyToConstAndDefs:t,handler:e,...r,zones:{},zoneCounters:{},currentZoneMap:null,gx:10,gy:10,mapPxWidth:0,mapPxHeight:0,colTexturingMap:[[!0,!0,!0,!0],[!0,!1,!0,!1],[!1,!0,!1,!0],[!1,!0,!0,!0],[!0,!0,!1,!1],[!1,!0,!1,!1],[!1,!0,!0,!1],[!0,!1,!0,!0],[!0,!1,!1,!1],[!1,!1,!1,!1],[!1,!1,!0,!1],[!0,!0,!1,!0],[!0,!1,!1,!0],[!1,!1,!1,!0],[!1,!1,!0,!0],[!0,!0,!0,!1]],reset:()=>{Object.assign(o,{zones:{},zoneCounters:{}})},spawn:(e,r=0,n=0)=>{if(e in o.keyToConstAndDefs){var a=t[e],i=a.const({...a.defs,x:r,y:n});return o.handler.add(i),i}},spawnInRadius:(e,r,n,a=0,i=0)=>{if(e in o.keyToConstAndDefs)for(var s=t[e],l=0;l<r;l++){var h=Math.random()*Math.PI*2,c=Math.random()*n,d=a+c*Math.cos(h),u=i+c*Math.sin(h),p=s.const({...s.defs,x:d,y:u});o.handler.add(p)}},spawnInRectangle:(e,r,n,a,i,s)=>{if(e in o.keyToConstAndDefs)for(var l=t[e],h=0;h<r;h++){var c=n+i*Math.random(),d=a+s*Math.random(),u=l.const({...l.defs,x:c,y:d});o.handler.add(u)}},zoneStep:(e,t,r,n)=>{if(o.currentZoneMap[t][e]){var a=o.currentZoneMap[t][e];a.key==r.key&&a.color==r.color&&(o.zoneMap[t][e][r.key]=n,o.zones[r.key]||(o.zones[r.key]={}),o.zones[r.key][n]||(o.zones[r.key][n]=[]),o.zones[r.key][n].push([e,t]),o.currentZoneMap[t][e]=null,o.zoneStep(e-1,t,r,n),o.zoneStep(e+1,t,r,n),o.zoneStep(e,t-1,r,n),o.zoneStep(e,t+1,r,n))}},addZonesFromImageArray:(e,t,r)=>{o.addZones(e[0],t,()=>{var n=e.slice(1);0==n.length?r():o.addZonesArray(n,t,r)})},addZonesFromImage:(e,t,r)=>{FileReader.readImage(e,e=>{var n=[],a=e.data;if(!o.zoneMap){for(var i=[],s=0;s<e.height;s++){for(var l=[],h=0;h<e.width;h++)l.push({});i.push(l)}o.zoneMap=i}for(s=0;s<e.height;s++){var c=[];for(h=0;h<e.width;h++){var d=(s*e.width+h)*e.pixelSize,u=a[d],p=a[d+1],y=a[d+2],g=t[SpoolMath.rgbToHex(u,p,y)];g?c.push({key:g,color:SpoolMath.rgbToHex(u,p,y)}):c.push(null)}n.push(c)}o.mapPxWidth=e.width,o.mapPxHeight=e.height;var x=o.zoneCounters;o.currentZoneMap=n;for(s=0;s<o.currentZoneMap.length;s++)for(h=0;h<o.currentZoneMap[s].length;h++){var f=o.currentZoneMap[s][h];f&&(f.key in x||(x[f.key]=0),o.zoneStep(h,s,f,x[f.key]),x[f.key]+=1)}o.zoneCounters=x,r&&r()})},spawnFromKeyArray:(e,r=o.gx,n=o.gy,a=null)=>{for(var i=0;i<e.length;i++)for(var s=0;s<e[i].length;s++)if(e[i][s]){var l=t[e[i][s]];if(l){var h={};l.dependantConst&&(h=l.dependantConst(o,a?a[i][s]:null));var c=l.const({...l.defs,x:parseInt((s-e[i].length/2)*r),y:parseInt((-i+e.length/2)*n),gridX:s,gridY:i,...h}),d=[e[i][s]];if(l.gridColRemovalSiblings&&(d=[e[i][s],...l.gridColRemovalSiblings]),c.gridColRemoval){s>0&&d.includes(e[i][s-1])&&(c.leftColIgnore=!0),s<e[i].length-1&&d.includes(e[i][s+1])&&(c.rightColIgnore=!0),i>0&&d.includes(e[i-1][s])&&(c.topColIgnore=!0),i<e.length-1&&d.includes(e[i+1][s])&&(c.bottomColIgnore=!0);var u=o.getColTextureId([!c.leftColIgnore,!c.topColIgnore,!c.rightColIgnore,!c.bottomColIgnore]);c.textureId=u,c.onGridColRemoval&&c.onGridColRemoval()}o.zoneMap&&Object.keys(o.zoneMap[i][s]).forEach(e=>{c.zones[e]=o.zoneMap[i][s][e]}),o.handler.add(c)}}},getColTextureId:e=>{for(var t=0;t<o.colTexturingMap.length;t++){for(var r=o.colTexturingMap[t],n=!1,a=0;a<e.length;a++)if(r[a]!==e[a]){n=!0;break}if(!n)return t}return 0},spawnFromIndexMap:(e,t=o.gx,r,n=" ",a="\r\n")=>{FileReader.readFile(e,e=>{var i=[],s=Object.keys(o.keyToConstAndDefs);e.split(a).forEach(e=>{var t=e.split(n);xPointer=0;var r=[];t.forEach(e=>{o.keyToConstAndDefs[s[parseInt(e)-1]]?r.push(s[parseInt(e)-1]):r.push(null)}),i.push(r)}),o.spawnFromKeyArray(i,t,r)})},spawnFromImageMap:(e,t,r,n=o.gx,a=o.gy)=>{FileReader.readImage(e,e=>{for(var i=[],s=(Object.keys(o.keyToConstAndDefs),e.data),l=t["non-black"],h=[],c=0;c<e.height;c++){for(var d=[],u=[],p=0;p<e.width;p++){var y=(c*e.width+p)*e.pixelSize,g=s[y],x=s[y+1],f=s[y+2],m=SpoolMath.rgbToHex(g,x,f),v=t[m];!l||v||0==g&&0==x&&0==f||(v=l),v?d.push(v):d.push(null),u.push([g,x,f,m])}i.push(d),h.push(u)}o.spawnFromKeyArray(i,n,a,h),r&&r()})},spawnRPGWorld:(e,t,r=o.gx,n=o.gy)=>{o.spawnFromImageMap(e.ground,t,r,n),o.spawnFromImageMap(e.objects,t,r,n)},spawnInZone:(e,r,n,a=null)=>{if(e in o.keyToConstAndDefs){var i=t[e];if(o.zones[n])for(var s=0;s<r;s++){var l=a;if(void 0==l||null==l){var h=Object.keys(o.zones[n]);l=h[Math.round(Math.random()*(h.length-1))]}var c=o.zones[n][l];if(c){var d=c[Math.round(Math.random()*(c.length-1))],u=(d[0]-o.mapPxWidth/2)*o.gx+Math.round(Math.random()*o.gx),p=(-d[1]+o.mapPxWidth/2)*o.gy+Math.round(Math.random()*o.gy),y=i.const({...i.defs,x:u,y:p});o.handler.add(y)}}}else console.log("@ObjectSpawner: Object key is not in known by object spawner: "+e)},getRandomPositionInZone:(e,t=null)=>{var r=t;if(!r){var n=Object.keys(o.zones[e]);r=n[Math.round(Math.random()*(n.length-1))]}var a=o.zones[e][r];if(a){var i=a[Math.round(Math.random()*(a.length-1))];return{x:(i[0]-o.mapPxWidth/2)*o.gx+Math.round(Math.random()*o.gx),y:(-i[1]+o.mapPxHeight/2)*o.gy+Math.round(Math.random()*o.gy)}}return null}};return o},Entity=(e={},t=null)=>{var r={asyncUpdatePackage:{},asyncUpdateNeeded:!1,x:0,y:0,velX:0,velY:0,calculatedVelX:0,calculatedVelY:0,movementAngle:0,rotation:0,accelerations:{},velocities:{},chunks:[],chunksX:0,chunksY:0,chunksXX:0,chunksYY:0,color:"red",zones:{},...GravityParameters,...CollisionParameters,...OvalBodyParameters,id:Math.random(),objectType:"BLANK_ENTITY",...e};if(t)var o=t(r);else o=r;return o.getEntityId=(()=>objectType+":"+id),o.update=(()=>{var e=!1;return o.updateVel(),(e|=o.updatePos())?o.updatePack():null}),o.initPack=(()=>{var e={};return void 0!==o.textureId&&(e.textureId=o.textureId),{...o.updatePack(),objectType:o.objectType,width:o.width,height:o.height,bodyType:o.bodyType,color:o.color,...e}}),o.updatePack=(()=>({x:o.x,y:o.y,color:o.color,rotation:o.rotation,id:o.id,movementAngle:o.movementAngle,moving:o.moving,...o.asyncUpdatePackage})),o.authorizedUpdatePack=(()=>null),o.setAsyncUpdateValue=((e,t)=>{o.asyncUpdatePackage[e]=t,o.asyncUpdateNeeded=!0}),o.addAsyncUpdatePackage=(e=>{Object.assign(o.asyncUpdatePackage,e),o.asyncUpdateNeeded=!0}),o.updatePos=(()=>{for(velKey in o.px=o.x,o.py=o.y,o.x+=o.velX,o.y+=o.velY,o.calculatedVelX=0,o.calculatedVelY=0,o.velocities){var e=o.velocities[velKey],t=SpoolMath.coordVelsFromVel(e.vel,e.angle);o.x+=t.x,o.y+=t.y,o.calculatedVelX+=t.x,o.calculatedVelY+=t.y}return o.px!=o.x||o.py!=o.y?(o.movementAngle=SpoolMath.globalAngle(o.px,o.py,o.x,o.y),o.moving=!0,!0):(o.moving=!1,!0)}),o.impulse=((e,t)=>{var r=SpoolMath.coordVelsFromVel(e,t);o.velX+=r.x,o.velY+=r.y}),o.vectorImpulse=((e,t)=>{o.velX+=e,o.velY+=t}),o.updateVel=(()=>{for(acckey in o.accelerations){var e=o.accelerations[acckey],t=SpoolMath.coordVelsFromVel(e.acc,e.angle);o.velX+=t.x,o.velY+=t.y}}),o.setAcc=((e,t,r)=>{o.accelerations[e]={acc:t,angle:r}}),o.addToAcc=((e,t,r)=>{var n={...o.accelerations[e]},a=n.acc*Math.cos(n.angle)+t*Math.cos(r),i=n.acc*Math.sin(n.angle)+t*Math.sin(r);newAcc=Math.sqrt(a*a+i*i),newAngle=Math.atan2(i,a),o.setAcc(e,newAcc,newAngle)}),o.removeAcc=(e=>{delete o.accelerations[e]}),o.setVel=((e,t,r)=>{o.velocities[e]={vel:t,angle:r}}),o.setVelVector=((e,t)=>{o.velocities[e]={vel:SpoolMath.distance(0,0,t[0],t[1]),angle:SpoolMath.globalAngle(0,0,t[0],t[1])}}),o.removeVel=(e=>{delete o.velocities[e]}),o.addToHandler=(e=>{e.add(o)}),o.vectorFromVel=(()=>({angle:Math.atan2(o.velY,o.velX),value:SpoolMath.distance(o.velX,o.velY,0,0)})),o.vectorFromVels=((e,t)=>({angle:Math.atan2(t,e),value:SpoolMath.distance(e,t,0,0)})),o.left=(()=>o.x-o.width/2),o.top=(()=>o.y-o.height/2),o.right=(()=>o.x+o.width/2),o.bottom=(()=>o.y+o.height/2),o.getBounds=(()=>new SpoolRect(o.x-o.width/2,o.y-o.height/2,o.width,o.height)),o},InputManager=()=>{},KeyInputParameters={pressedLeft:!1,pressedUp:!1,pressedRight:!1,pressedDown:!1},GravityParameters={mass:1,gravityLock:!1},CollisionParameters={px:0,py:0},OvalBodyParameters={bodyType:"oval",width:10,height:10},RectangleBodyParameters={bodyType:"rect",width:10,height:10};try{module.exports={Handler:Handler,Chunk:Chunk,CollisionManager:CollisionManager,GravityManager:GravityManager,OuterWorldManager:OuterWorldManager,InputManager:InputManager,ObjectSpawner:ObjectSpawner,Entity:Entity,KeyInputParameters:KeyInputParameters,GravityParameters:GravityParameters,CollisionParameters:CollisionParameters,OvalBodyParameters:OvalBodyParameters,RectangleBodyParameters:RectangleBodyParameters,SpoolTimer:SpoolTimer,SpoolMath:SpoolMath,SpoolUtils:SpoolUtils,Perlin:Perlin}}catch(e){"undefined"==typeof module?console.log("Modules are not present, you are probably on client, make sure this script is included before the files that require it"):console.error(e)}const SpoolMath={coordVelsFromVel:(e,t)=>({x:Math.cos(t)*e,y:Math.sin(t)*e}),globalAngle:(e,t,r,o)=>Math.atan2(o-t,r-e),objGlobalAngle:(e,t)=>this.globalAngle(e.x,e.y,t.x,t.y),angleDistance:(e,t)=>{var r=(t-e)%(2*Math.PI);return r>0?r>Math.PI?-(2*Math.PI-r):r:r<-Math.PI?-(-2*Math.PI-r):r},distance:(e,t,r,o)=>Math.sqrt(Math.pow(r-e,2)+Math.pow(o-t,2)),objDistance:(e,t)=>Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)),polarPoint:(e,t,r,o)=>({x:e+r*Math.cos(o),y:t+r*Math.sin(o)}),rotatePoint:(e,t,r,o,n)=>{var a=Math.sin(n),i=Math.cos(n);return{x:(e-=r)*i-(t-=o)*a+r,y:e*a+t*i+o}},rotatePoints:(e,t,r,o)=>{for(var n=Math.sin(o),a=Math.cos(o),i=[],s=0;s<e.length;s++){var l=e[s][0]-t,h=e[s][1]-r;i.push([l*a-h*n+t,l*n+h*a+r])}return i},transformPoints:(e,t,r)=>{for(var o=[],n=0;n<e.length;n++)o.push([e[n][0]+t,e[n][1]+r]);return o},randRange:(e,t)=>Math.random()*(t-e)+e,randomColor:(e,t)=>`rgb(${Math.floor(Math.random()*(t-e)+e)},${Math.floor(Math.random()*(t-e)+e)},${Math.floor(Math.random()*(t-e)+e)})`,randomHsvColor:(e,t)=>SpoolMath.HSVtoColor(Math.random(),e,t),HSVtoColor:(e,t,r)=>{let{r:o,g:n,b:a}=SpoolMath.HSVtoRGB(e,t,r);return`rgb(${o}, ${n}, ${a})`},HSVtoRGB:(e,t=null,r=null)=>{var o,n,a,i,s,l,h,c;switch(!e||t||r||(t=e.s,r=e.v,e=e.h),l=r*(1-t),h=r*(1-(s=6*e-(i=Math.floor(6*e)))*t),c=r*(1-(1-s)*t),i%6){case 0:o=r,n=c,a=l;break;case 1:o=h,n=r,a=l;break;case 2:o=l,n=r,a=c;break;case 3:o=l,n=h,a=r;break;case 4:o=c,n=l,a=r;break;case 5:o=r,n=l,a=h}return{r:Math.round(255*o),g:Math.round(255*n),b:Math.round(255*a)}},posDimsToRect:(e,t)=>SPTensors.link([e,t],[4]),posDimsToPolygon:(e,t)=>new Tensor([4,2],[e.x,e.y,e.x+t.x,e.y,e.x+t.x,e.y+t.y,e.x,e.y+t.y]),generateLines(e,t,r){for(var o=[],n=0;n<r;n++)o.push(new SpoolLine(e(n),t(n)));return o},lineIntersection:(e,t)=>{var r=e.x,o=e.xx,n=e.y,a=e.yy,i=t.x,s=t.xx,l=t.y,h=t.yy,c=(r-o)*(l-h)-(n-a)*(i-s);if(0==c)return null;var d=((r*a-n*o)*(i-s)-(r-o)*(i*h-l*s))/c,u=((r*a-n*o)*(l-h)-(n-a)*(i*h-l*s))/c;return SpoolMath.inInterval(d,r,o,2)&&SpoolMath.inInterval(d,i,s,2)&&SpoolMath.inInterval(u,n,a,2)&&SpoolMath.inInterval(u,l,h,2)?{x:d,y:u}:null},rectCollision:(e,t)=>(e.x<=t.x&&t.x<=e.xx||e.x<=t.xx&&t.xx<=e.xx)&&(e.y<=t.y&&t.y<=e.yy||e.y<=t.yy&&t.yy<=e.yy),getLinesFromRect:e=>[{x:e.x,y:e.y,xx:e.x,yy:e.yy},{x:e.xx,y:e.y,xx:e.xx,yy:e.yy},{x:e.x,y:e.yy,xx:e.xx,yy:e.yy},{x:e.x,y:e.y,xx:e.xx,yy:e.y}],getLine:(e,t)=>({x:e.x,y:e.y,xx:t.x,yy:t.y}),movingRectCollision:(e,t,r,o=!1)=>{var n=SpoolMath.boundRect(parseInt(t.cx-t.width/2-e.width/2),parseInt(t.cy-t.height/2-e.height/2),parseInt(t.cx+t.width/2+e.width/2),parseInt(t.cy+t.height/2+e.height/2)),a={result:n.contains(e.cx,e.cy)};if(Math.abs(e.cx-t.cx)>=Math.abs(r.x-t.cx)&&Math.abs(e.cy-t.cy)>=Math.abs(r.y-t.cy))return a;var i=SpoolMath.getLine(r,{x:e.cx,y:e.cy});return SpoolMath.lineRectCollision(n,i)},lineRectCollision:(e,t)=>{var r=[],o=SpoolMath.getLinesFromRect(e),n=["right","left","bottom","top"],a=0;if(e.contains(t.x,t.y))return{x:t.x,y:t.y};e.contains(t.xx,t.yy)&&r.push({x:t.xx,y:t.yy}),o.forEach(e=>{var o=SpoolMath.lineIntersection(e,t);o&&(o.direction=n[a]),r.push(o),a++});var i=null,s=null;return a=0,r.forEach(e=>{if(e){var r=SpoolMath.distance(t.x,origin.y,e.x,e.y);(!s||r<s)&&(a,s=r,i=e)}a++}),i?{x:i.x,y:i.y,direction:i.direction}:null},lerp:(e,t,r)=>e+(t-e)*(r=r>1?1:r<0?0:r),lerpRotation:(e,t,r)=>{return e+(((t-e)%(2*Math.PI)+Math.PI/180*540)%(2*Math.PI)-Math.PI)*r%(2*Math.PI)},randomInt:(e,t)=>e+Math.round(Math.random()*(t-e)),randomChoice:e=>0==e.length?null:e[SpoolMath.randomInt(0,e.length-1)],toHex:e=>{var t=Number(e).toString(16);return t.length<2&&(t="0"+t),t},rgbToHex:(e,t,r)=>SpoolMath.toHex(e)+SpoolMath.toHex(t)+SpoolMath.toHex(r),divideColor:(e,t)=>{elements=e.substring(4).split(",");for(var r=0;r<elements.length;r++)elements[r]=parseInt(parseInt(elements[r])/t);return SpoolMath.rgbToHex(elements[0],elements[1],elements[2])},inInterval:(e,t,r,o=0)=>{if(t<r)var n=t,a=r;else n=r,a=t;return n-o<=e&&e<=a+o},inRange:(e,t,r)=>t<=e&&e<r,numberDefined:e=>void 0!==e&&null!==e,getYFromCircle:(e,t)=>{if(e<=t&&e>=-t)var r=Math.sqrt(Math.pow(t,2)-Math.pow(e,2));return-r},getYFromMovedCircle:(e,t,r,o)=>(movY=SpoolMath.getYFromCircle(r,o)+t,movX=r+e,pos=[movX,movY],pos),getAngleFromCircle:(e,t)=>{return Math.acos(t/e)-Math.PI/2},rectangleMouseCollision:(e,t,r,o,n,a)=>n>=e&&n<=e+r&&a<=t&&a>=t-o,rotatePoint:(e,t,r,o,n)=>{var a=SpoolMath.distance(e,t,r,o),i=SpoolMath.globalAngle(e,-t,r,-o)-n,s=Math.cos(i)*a+e,l=-Math.sin(i)*a+t;return pos=[s,l],pos},getUnitVector:e=>[Math.cos(e),Math.sin(e)],scaleVector:(e,t)=>e.map(e=>e*t),addVectors:(e,t)=>{res=[];for(var r=0;r<e.length;r++)res.push(e[r]+t[r]);return res},averageVectors:e=>{if(0==e.length)return null;temp=e[0];for(var t=1;t<e.length;t++)temp=SpoolMath.addVectors(temp,e[t]);return SpoolMath.scaleVector(temp,1/e.length)},average:e=>{if(0==e.length)return 0;for(var t=0,r=0;r<e.length;r++)t+=e[r];return t/e.length},weightedAverage:(e,t)=>{for(var r=0,o=0,n=0;n<e.length;n++)r+=e[n]*t[n],o+=t[n];return 0==o?0:r/o},sigmoid:e=>1/(1+Math.exp(-e)),boundRect:(e,t,r,o)=>new SpoolRect(e,t,r-e,o-t)};function SpoolPoint(e,t){this.x=e,this.y=t}function SpoolLine(e,t){this.a=e,this.b=t}function SpoolRect(e,t,r,o){this.x=e,this.y=t,this.width=r,this.height=o}SpoolLine.prototype.get=function(){return[this.x,this.y,this.xx,this.yy]},Object.defineProperty(SpoolLine.prototype,"x",{get:function(){return this.a.x},set:function(e){this.a.x=e}}),Object.defineProperty(SpoolLine.prototype,"y",{get:function(){return this.a.y},set:function(e){this.a.y=e}}),Object.defineProperty(SpoolLine.prototype,"xx",{get:function(){return this.b.x},set:function(e){this.b.x=e}}),Object.defineProperty(SpoolLine.prototype,"yy",{get:function(){return this.b.y},set:function(e){this.b.y=e}}),SpoolRect.prototype.get=function(){return[this.x,this.y,this.width,this.height]},SpoolRect.prototype.collision=function(e){return(this.x<=e.x&&e.x<=this.xx||this.x<=e.xx&&e.xx<=this.xx)&&(this.y<=e.y&&e.y<=this.yy||this.y<=e.yy&&e.yy<=this.yy)},SpoolRect.prototype.contains=function(e,t){return this.x<=e&&e<=this.xx&&this.y<=t&&t<=this.yy},Object.defineProperty(SpoolRect.prototype,"cx",{get:function(){return this.x+this.width/2},set:function(e){this.x=e-this.width/2}}),Object.defineProperty(SpoolRect.prototype,"cy",{get:function(){return this.y+this.height/2},set:function(e){this.y=e-this.height/2}}),Object.defineProperty(SpoolRect.prototype,"xx",{get:function(){return this.x+this.width},set:function(e){this.x=e-this.width}}),Object.defineProperty(SpoolRect.prototype,"yy",{get:function(){return this.y+this.height},set:function(e){this.y=e-this.height}});var RadiusRect=(e,t,r,o)=>new SpoolRect(e-r,t-o,2*r,2*o);try{module.exports={SpoolMath:SpoolMath,SpoolRect:SpoolRect,RadiusRect:RadiusRect}}catch(e){"undefined"==typeof module?console.log("Modules are not present, you are probably on client, make sure this script is included before the files that require it"):console.error(e)}const basicAliases={x:0,y:1,z:2,w:3,a:0,b:1,c:2,d:3,width:2,height:3},getIndexAndShape=(e,t,r=null)=>{var o=0;r||(r=getLevelSizes(e)),t.forEach((t,n)=>{if(!SpoolMath.inRange(t,0,e[n]))throw`${t} at ${n}-d is out of range(${e[n]})`;o+=t*r[1+n]});var n=e.slice(t.length);return{index:o,shape:n}},getVariableIndexAndShape=(e,t,r=null)=>{null===r&&(r=getIndexesMap(e)[0]);for(var o=r,n=e,a={index:o[0],shape:n},i=0;i<t.length;i++){var s=t[i];if(o=o[s],n=n[s],o.constructor!==Array)return(a=getIndexAndShape(n,t.slice(i+1))).index+=o,a;a={index:o[0],shape:n}}return a},getLevelSizes=e=>{for(var t=[1],r=1,o=e.length,n=0;n<o;n++)r*=e[o-n-1],t.push(r);return t.reverse(),t},getSize=e=>0==e.length?1:e[0].constructor===Array?e.map(e=>getSize(e)).reduce((e,t)=>e+t):e.reduce((e,t)=>e*t),getIndexesMap=(e,t=0)=>[e.map(e=>{if(e[0].constructor===Array){var r=getIndexesMap(e,t);return t+=r[1],r[0]}return index=t,t+=e.reduce((e,t)=>e*t),index}),t],getDimensions=e=>e.length,toFixedSize=(e,t=6)=>{for(var r=e.toString();(r.length+1)%t!=0;)r+=" ";return r},toString=(e,t=0,r=0,o="")=>{var n="",a=e.shape.length-r;if(1==a){n+=o;for(var i=0;i<e.shape[e.shape.length-1];i++){var s=6,l=", ";e.dimension<2&&(s=1),i==e.shape[e.shape.length-1]-1&&(s=1,l=""),n+=toFixedSize(e.get(i+t)+l,s)}}else{2!=a&&(n+=o+"[\n");for(i=0;i<e.shape[r];i++){var h=t+i*e.shape.slice(r+1).reduce((e,t)=>e*t),c=2==a&&0==i?o+"[ ":o+"  ",d=2==a&&i==e.shape[r]-1?"":"\n";n+=toString(e,h,r+1,c)+d}n+=2!=a?o+"]":" ]"}return 1==e.dimension?`[${n}]`:n};function TensorBase(e){this.shape=e,this.size=getSize(e),this.dimension=getDimensions(e)}function Tensor(e,t=null,r=(()=>0)){if(TensorBase.call(this,e),this.type="fixed",this.levelSizes=getLevelSizes(e),t){if(t.length!=this.size)throw`The size of values (${t.length}) doesn't match the shape of the tensor (${e})`;this.values=t}else this.values=Array.from({length:this.size},r)}function VariableTensor(e,t,r=(()=>0)){if(TensorBase.call(this,e),this.type="variable",this.indexes=getIndexesMap(e)[0],t){if(t.length!=this.size)throw`The size of values (${t.length}) doesn't match the shape of the tensor (${e})`;this.values=t}else this.values=Array.from({length:this.size},r)}TensorBase.prototype.getIndex=function(e){return this.getIndexAndShape(e).index},TensorBase.prototype.getValue=function(e){const t=this.getIndex(e);return this.get(t)},TensorBase.prototype.T=function(){if(2!=this.dimension)throw`You can only transpose 2-d tensor, not ${this.d}-d`;var e=[this.shape[1],this.shape[0]],t=new SubTensor(self,e);return t.get=(e=>{var t=Math.floor(e/this.shape[0]),r=e%this.shape[0];return this.get(r*this.shape[1]+t)}),t},TensorBase.prototype.apply=function(e=((e,t)=>e)){return SPTensors.apply(this,e)},TensorBase.prototype.add=function(e){return"number"==typeof e?this.apply(t=>t+e):this.apply((t,r)=>t+e.get(r))},TensorBase.prototype.sub=function(e){return"number"==typeof e?this.apply(t=>t-e):this.apply((t,r)=>t-e.get(r))},TensorBase.prototype.mult=function(e){return"number"==typeof e?this.apply(t=>t*e):this.apply((t,r)=>t*e.get(r))},TensorBase.prototype.toString=function(){return toString(this)},Object.keys(basicAliases).forEach(function(e){Object.defineProperty(TensorBase.prototype,e,{get:function(){return this.get(basicAliases[e])},set:function(t){return this.set(basicAliases[e],t)}})}),Tensor.prototype=Object.create(TensorBase.prototype),Tensor.prototype.get=function(e){return this.values[e]},Tensor.prototype.set=function(e,t){return this.values[e]=t,this.values[e]},Tensor.prototype.getIndexAndShape=function(e){return getIndexAndShape(this.shape,e,this.levelSizes)},Tensor.prototype.subTensor=function(e){if(this.shape.length-e.length<0)throw`${e.length} coords for ${r.length} array`;let{index:t,shape:r}=this.getIndexAndShape(e);return new SubTensor(this,r,t,t+getSize(this.shape))},VariableTensor.prototype=Object.create(TensorBase.prototype),VariableTensor.prototype.get=function(e){return this.values[e]},VariableTensor.prototype.set=function(e,t){return this.values[e]=t},VariableTensor.prototype.getIndexAndShape=function(e){return getVariableIndexAndShape(this.shape,e,this.indexes)},VariableTensor.prototype.subTensor=function(e){let{index:t,shape:r}=this.getIndexAndShape(e);return new SubTensor(this,r,t,t+getSize(this.shape))},VariableTensor.prototype.toString=function(){for(var e="",t=0;t<this.shape.length;t++)e+=this.subTensor([t]).toString()+"\n";return e};const isVariable=e=>e.length>0&&e[0].constructor===Array;function SubTensor(e,t,r=null,o=null){TensorBase.call(this,t),this.parent=e,this.start=r,this.end=o,this.type="sub",null===this.start&&(this.start=0),null===this.end&&(this.end=getSize(t)),isVariable(t)?(this.indexes=getIndexesMap(this.shape)[0],this.getIndexAndShape=VariableTensor.prototype.getVariableIndexAndShape):(this.levelSizes=getLevelSizes(this.shape),this.getIndexAndShape=Tensor.prototype.getVariableIndexAndShape)}SubTensor.prototype=Object.create(TensorBase.prototype),SubTensor.prototype.get=function(e){return this.parent.get(e+this.start)},SubTensor.prototype.set=function(e,t){return this.parent.set(e+this.start,t)},SubTensor.prototype.subTensor=function(e){if(this.shape.length-e.length<0)throw`${e.length} coords for ${r.length} array`;let{index:t,shape:r}=this.getIndex(e);var o=getSize(r);return new SubTensor(this.parent,r,t+start,t+start+o)},SubTensor.prototype.toString=function(){return new Tensor(this.shape,null,(e,t)=>this.get(t)).toString()};var operations=["apply",""],SPTensors={apply:(e,t=((e,t)=>e))=>{for(var r=0;r<e.size;r++)e.set(r,t(e.get(r),r));return e},copy:(e,t=(e=>e))=>new(SPTensors.constructorForShape(e.shape))(e.shape,null,(r,o)=>t(e.get(o))),tensor:(e,t,r)=>new(SPTensors.constructorForShape(e))(e,t,r),vector:e=>new Tensor([e.length],e),const:(e,t)=>SPTensors.tensor(e,null,()=>{}),zeros:e=>SPTensors.const(e),ones:e=>SPTensors.const(e,1),constLike:(e,t=0)=>SPTensors.copy(e,()=>t),zerosLike:e=>SPTensors.constLike(e),onesLike:e=>SPTensors.constLike(e,1),random:(e,t=0,r=1)=>new Tensor(e,null,()=>SpoolMath.randRange(t,r)),randomLike:(e,t=0,r=1)=>SPTensors.copy(e,()=>SpoolMath.randRange(t,r)),range:(e,t=1)=>new(SPTensors.constructorForShape(e))(e,null,(e,r)=>r*t),elementWiseOperation:(e,t,r)=>{if(!SpoolUtils.arraysEqual(e.shape,t.shape))throw new Error(`The shapes of the tensors don't match: ${e.shape} != ${t.shape}`);return SPTensors.tensor(e.shape,null,(o,n)=>r(e.get(n),t.get(n)))},add:(e,t)=>"number"==typeof t?SPTensors.copy(e,e=>e+t):SPTensors.elementWiseOperation(e,t,(e,t)=>e+t),sub:(e,t)=>"number"==typeof t?SPTensors.copy(e,e=>e-t):SPTensors.elementWiseOperation(e,t,(e,t)=>e-t),mult:(e,t)=>"number"==typeof t?SPTensors.copy(e,e=>e*t):SPTensors.elementWiseOperation(e,t,(e,t)=>e*t),dot:(e,t,r=[],o=[])=>{if(2!=e.dimension&&2!=t.dimension)throw`Dot product supports only 2-d tensor dot your (${e.d}d . ${t.d})`;aValues=e.values,bValues=t.values;let n=e.getIndexAndShape(r),a=n.index,i=n.shape;var s=i[0],l=i[1];let h=t.getIndexAndShape(o),c=h.index,d=h.shape;var u=d[0],p=d[1];if(l!=u)throw`Shapes of the tensors are not compatible for dot ${i} ${d}`;for(var y=[s,p],g=[],x=0;x<s;x++)for(var f=0;f<p;f++){for(var m=0,v=0;v<l;v++)m+=aValues[a+x*l+v]*bValues[c+v*p+f];g.push(m)}return new Tensor(y,g)},concat:e=>new VariableTensor(e.map(e=>e.shape),[].concat(...e.map(e=>e.values))),constructorForShape:e=>{var t=Tensor;return e.length>0&&e[0].constructor===Array&&(t=VariableTensor),t}};try{modules.export={SPTensors:SPTensors}}catch(e){"undefined"==typeof module?console.log("Modules are not present, you are probably on client, make sure this script is included before the files that require it"):console.error(e)}var MessageCodes={SM_RESET:"reset",SM_PACK_INIT:"init-pack",SM_PACK_UPDATE:"update-pack",SM_PACK_REMOVE:"remove-pack",OS_GET_OBJ:"get-obj",OS_SEND_OBJ:"send-obj",ASIGN_CLIENT_ID:"asign-id",SM_KEY_PRESS:"key-press",SM_MOUSE_INPUT:"mouse-clicked",KI_MOV_LEFT:"MOV_LEFT",KI_MOV_RIGHT:"MOV_RIGHT",KI_MOV_UP:"KI_MOV_UP",KI_MOV_DOWN:"KI_MOV_DOWN",SERVER_LOADING:"SERVER_LOADING"};try{module.exports={...MessageCodes}}catch(e){console.warn("Module exporting is not present. If you are in client make sure you include files correctly in you index file.")}var SpoolRenderer={ctx:null,camera:null,setColor:e=>{SpoolRenderer.ctx.fillStyle=e,SpoolRenderer.ctx.strokeStyle=e},setFont:(e,t)=>{SpoolRenderer.ctx.font=`${t}px ${e}`},drawInscribedOval:e=>{SpoolRenderer.ctx.beginPath(),SpoolRenderer.ctx.ellipse(e.cx,e.cy,e.width/2,e.height/2,0,0,360),SpoolRenderer.ctx.stroke()},fillInscribedOval:e=>{SpoolRenderer.ctx.beginPath(),SpoolRenderer.ctx.ellipse(e.cx,e.cy,e.width/2,e.height/2,0,0,360),SpoolRenderer.ctx.fill()},tDrawPoint:(e,t,r)=>{var o=SpoolRenderer.camera.transformPoint(e,t);SpoolRenderer.fillOval(o.x,o.y,r)},drawLine:(e,t,r,o)=>{SpoolRenderer.ctx.beginPath(),SpoolRenderer.ctx.moveTo(e,t),SpoolRenderer.ctx.lineTo(r,o),SpoolRenderer.ctx.stroke()},tDrawLine:(e,t,r,o)=>{var n=SpoolRenderer.camera.transformPoint(e,t),a=SpoolRenderer.camera.transformPoint(r,o);SpoolRenderer.ctx.beginPath(),SpoolRenderer.ctx.moveTo(n.x,n.y),SpoolRenderer.ctx.lineTo(a.x,a.y),SpoolRenderer.ctx.stroke()},fillInscribedOvalPercentFull:(e,t)=>{if(SpoolRenderer.ctx.beginPath(),t>.5){var r=t-.5,o=Math.asin(2*r);SpoolRenderer.ctx.ellipse(e.cx,e.cy,e.width/2,e.height/2,0,-o,Math.PI+o)}else{o=Math.asin(2*(.5-t));SpoolRenderer.ctx.ellipse(e.cx,e.cy,e.width/2,e.height/2,0,o,Math.PI-o)}SpoolRenderer.ctx.fill()},drawOval:(e,t,r)=>{SpoolRenderer.ctx.beginPath(),SpoolRenderer.ctx.arc(e,t,r,0,360),SpoolRenderer.ctx.stroke()},fillOval:(e,t,r)=>{SpoolRenderer.ctx.beginPath(),SpoolRenderer.ctx.arc(e,t,r,0,360),SpoolRenderer.ctx.fill()},linePolygon:e=>{SpoolRenderer.ctx.beginPath(),SpoolRenderer.ctx.moveTo(e[0][0],e[0][1]);for(var t=1;t<e.length;t++)SpoolRenderer.ctx.lineTo(e[t][0],e[t][1]);SpoolRenderer.ctx.closePath()},fillPolygon:e=>{SpoolRenderer.linePolygon(e),SpoolRenderer.ctx.fill()},renderRotatedSprite:(e,t,r,o,n)=>{SpoolRenderer.ctx.save(),SpoolRenderer.ctx.translate(r,o),SpoolRenderer.ctx.rotate(-t),SpoolRenderer.ctx.drawImage(e,n.x,n.y,n.width,n.height),SpoolRenderer.ctx.restore()},drawRect:(e,t,r,o)=>{SpoolRenderer.ctx.beginPath(),SpoolRenderer.ctx.rect(e,t,r,o),SpoolRenderer.ctx.stroke()},tDrawRect:(e,t,r,o)=>{const n=SpoolRenderer.camera.transformBounds(e,t,r,o);SpoolRenderer.drawRect(n.x,n.y-n.height,n.width,n.height)},fillRect:(e,t,r,o)=>{SpoolRenderer.ctx.fillRect(e,t,r,o)},fillSplRect:e=>{SpoolRenderer.ctx.fillRect(e.x,e.y,e.width,e.height)},drawSplRect:e=>{SpoolRenderer.ctx.fillRect(e.x,e.y,e.width,e.height)},fillRoundRect(e,t,r,o,n,a=0,i=!0,s=!1){if(void 0===a&&(a=5),"number"==typeof a)a={tl:a,tr:a,br:a,bl:a};else{var l={tl:0,tr:0,br:0,bl:0};for(var h in l)a[h]=a[h]||l[h]}e.beginPath(),e.moveTo(t+a.tl,r),e.lineTo(t+o-a.tr,r),e.quadraticCurveTo(t+o,r,t+o,r+a.tr),e.lineTo(t+o,r+n-a.br),e.quadraticCurveTo(t+o,r+n,t+o-a.br,r+n),e.lineTo(t+a.bl,r+n),e.quadraticCurveTo(t,r+n,t,r+n-a.bl),e.lineTo(t,r+a.tl),e.quadraticCurveTo(t,r,t+a.tl,r),e.closePath(),i&&e.fill(),s&&e.stroke()},multiLineText:(e,t,r,o=.33,n=null)=>{var a=[];e.split("\n").forEach(e=>{var t=e.split(" "),o="";SpoolRenderer.ctx.textAlign="center",t.forEach((e,t)=>{SpoolRenderer.ctx.measureText(o+e).width>=r?(a.push(o.trim()),o=e):o+=" "+e}),o&&a.push(o.trim())});var i=parseInt(SpoolRenderer.ctx.font)+3;a.forEach((e,r)=>{var s=t.x+t.width/2,l=t.y+t.height/2-(a.length-1)/2*i+r*i+i*o;n&&(SpoolRenderer.ctx.lineWidth=n,SpoolRenderer.ctx.strokeText(e,s,l)),SpoolRenderer.ctx.fillText(e,s,l)})},simpleText:(e,t,r,o=null)=>{o&&(SpoolRenderer.ctx.lineWidth=o,SpoolRenderer.ctx.strokeText(e,t,r)),SpoolRenderer.ctx.fillText(e,t,r)},tSimpleText:(e,t,r,o=null)=>{var n=SpoolRenderer.camera.transformPoint(t,r);o&&(SpoolRenderer.ctx.lineWidth=o,SpoolRenderer.ctx.strokeText(e,n.x,n.y)),SpoolRenderer.ctx.fillText(e,n.x,n.y)}};console.log("loaded");var SpoolUIElement=e=>{var t={elements:{},layerKeys:[],x:0,y:0,width:0,height:0,layer:10,visible:!0,bgColor:null,fgColor:null,strokeColor:null,textMargin:10,id:Math.random(),lineHeight:10,bindedMouseEvent:null,mouseUp:!1,mouseDown:!0,...e};return t.left=t.x,t.top=t.y,t.right=t.x+t.width,t.bottom=t.y+t.height,t.update=(()=>{}),t.render=(e=>{t.renderBounds(e),t.renderSprite(e),t.renderText(e),t.layerKeys.forEach(r=>{r.ids.forEach(o=>{t.elements[r.key][o].update(),t.elements[r.key][o].visible&&t.elements[r.key][o].render(e)})})}),t.renderBounds=(e=>{t.radius?(t.bgColor&&(e.fillStyle=t.bgColor),t.strokeColor&&(e.strokeStyle=t.strokeColor),drawRoundRect(e,t.x,t.y,t.width,t.height,t.radius,t.bgColor,t.strokeColor)):(e.beginPath(),e.lineWidth="1",e.rect(t.x,t.y,t.width,t.height),t.bgColor&&(1!=t.bgOpacity?(e.globalAlpha=t.bgOpacity,e.fillStyle=t.bgColor,e.fill(),e.globalAlpha=1):(e.fillStyle=t.bgColor,e.fill())))}),t.renderText=(e=>{if(t.text)if(t.disabled?e.fillStyle="gray":t.fgColor?e.fillStyle=fgColor:e.fillStyle="white",t.font&&(e.font=t.font),e.textAlign="center",t.multiLine){if(!t.linesSplit||!t.textLines||t.linesSplit!=t.text){var r="",o=[];t.text.split(" ").forEach((n,a)=>{e.measureText(r+n).width>=t.width-2*t.textMargin?(o.push(r),r=n):r+=" "+n}),r&&o.push(r),t.lineHeight=parseInt(e.font)+3,t.textLines=o}t.textLines.forEach((r,o)=>{e.fillText(r,t.x+t.width/2,t.y+t.height/2-t.textLines.length/2*t.lineHeight+o*t.lineHeight)}),t.linesSplit=t.text}else e.fillText(t.text,t.x+t.width/2,t.y+t.height/2)}),t.renderSprite=((e,r=t.sprite,o=1)=>{r&&e.drawImage(r,t.x+t.width/2-t.width/2*o,t.y+t.height/2-t.height/2*o,t.width*o,t.height*o)}),t.mouseEvent=((e,r=t.mouseUp,o=t.mouseDown)=>{var n=!1;if(t.disabled)return!1;if(t.layerKeys.forEach(r=>{r.ids.forEach(o=>{t.elements[r.key][o].visible&&(n|=t.elements[r.key][o].mouseEvent(e))})}),n)return n;if(recognizedEvent="mouseup"==e.type&&r||"mousedown"==e.type&&o,t.bindedMouseEvent&&recognizedEvent){if(t.x<=e.x&&e.x<=t.x+t.width)if(t.y<=e.y&&e.y<=t.y+t.width)if(!1!==(n=t.bindedMouseEvent(e,t)))return!0;return!1}return!1}),t.mouseMove=(e=>{t.mx=e.clientX,t.my=e.clientY;var r=!1,o=!1;t.layerKeys.forEach(r=>{r.ids.forEach(n=>{t.elements[r.key][n].visible&&(o|=t.elements[r.key][n].mouseMove(e))})});var n=t.mouseOn,a=t.mouseIn;return o?(n=!1,a=!0,r=!1):(t.x<=e.x&&e.x<=t.x+t.width&&t.y<=e.y&&e.y<=t.y+t.width&&(r=!0),n=r,a=r),n!=t.mouseOn&&(n&&t.onMouseEnter?t.onMouseEnter(e,t):!n&&t.onMouseLeave&&t.onMouseLeave(e,t),t.mouseOn=n),t.mouseOn=a,r}),t.add=(e=>{t.elements[e.layer]||(t.elements[e.layer]={}),t.elements[e.layer][e.id]=e,t.refreshKeys()}),t.remove=(e=>{delete t.elements[e],t.refreshKeys()}),t.forEachElement=(e=>{t.layerKeys.forEach(r=>{r.ids.forEach(o=>{e(t.elements[r.key][o])})})}),t.removeAll=(()=>{t.elements={},t.layerKeys=[]}),t.refreshKeys=(()=>{var e=Object.keys(t.elements).sort((e,t)=>parseInt(e)-parseInt(t));t.layerKeys=[],e.forEach(e=>{t.layerKeys.push({key:e,ids:Object.keys(t.elements[e])})})}),t.alignItems=((e,r,o)=>{var n=null,a=null,i=null,s=null;t.layerKeys.forEach(e=>{e.ids.forEach(r=>{var o=t.elements[e.key][r];(!n||o.x<n)&&(n=o.x),(!i||o.y<i)&&(i=o.y),(!a||o.x+o.width>a)&&(a=o.x+o.width),(!s||o.y+o.height>s)&&(s=o.y+o.height)})});var l=r-(n+a)/2,h=o-(i+s)/2;console.log(l,h),t.layerKeys.forEach(e=>{e.ids.forEach(r=>{t.elements[e.key][r].x+=l,t.elements[e.key][r].y+=h})})}),t.getElementBounds=(()=>{var e=null,r=null,o=null,n=null;return t.layerKeys.forEach(a=>{a.ids.forEach(i=>{var s=t.elements[a.key][i];(!e||s.x<e)&&(e=s.x),(!o||s.y<o)&&(o=s.y),(!r||s.x+s.width>r)&&(r=s.x+s.width),(!n||s.y+s.height>n)&&(n=s.y+s.height)})}),{x:e,y:o,width:r-e,height:n-o,left:e,right:r,top:o,bottom:n}}),t.pack=(()=>{var e=t.getElementBounds();t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height}),t},SpoolUIHandler=e=>{return SpoolUIElement({initObject:e})},SpoolUIButton=e=>{return SpoolUIElement({...e})},SpoolUIButtonList=(e,t,r=SpoolUIButton)=>{var o=SpoolUIElement({rows:1,columns:1,margin:10,buttonWidth:50,buttonHeight:50,offsetX:.5,offsetY:.5,...e});o.width=(o.margin+o.buttonWidth)*o.columns,o.height=(o.margin+o.buttonHeight)*o.rows;var n=o.x-o.width*o.offsetX,a=o.y-o.height*o.offsetY,i=0;return o.left=n,o.up=a,o.right=n+o.width,o.bottom=a+o.height,o.buttons=[],t.forEach(e=>{var t=r({x:n+i%o.columns*(o.buttonWidth+o.margin),y:a+Math.floor(i/o.columns)*(o.buttonWidth+o.margin),width:o.buttonWidth,height:o.buttonHeight,...e});i+=1,o.buttons.push(t),o.add(t)}),o},LoadingUI=(e,t)=>{var r=SpoolUIElement({client:e,x:e.gameArea.width-60,y:e.gameArea.height-60,width:50,height:50,overlay:!1,overlayColor:"white",...t});return r.animationFrame=0,r.bounds=SpoolRect(r.x,r.y,r.width,r.height),r.render=(t=>{r.animationFrame+=1,(r.client.serverSideLoading||r.client.clientSideLoading)&&(r.overlay&&(SpoolRenderer.setColor(r.overlayColor),SpoolRenderer.fillRect(0,0,r.client.gameArea.width,r.client.gameArea.height),SpoolRenderer.setColor("black"),SpoolRenderer.setFont("Arial",50),e.serverSideLoadingData&&e.serverSideLoadingData.message?(t.textAlign="center",SpoolRenderer.simpleText(e.serverSideLoadingData.message,r.client.gameArea.width/2,r.client.gameArea.height/2),t.textAlign="right",SpoolRenderer.simpleText("Loading",r.bounds.cx-2*r.bounds.width,r.bounds.cy)):(t.textAlign="center",SpoolRenderer.simpleText("Loading",r.client.gameArea.width/2,r.client.gameArea.height/2))),SpoolRenderer.setColor("black"),SpoolRenderer.drawInscribedOval("black"),SpoolRenderer.fillInscribedOvalPercentFull(r.bounds,r.animationFrame/30),r.animationFrame>30&&(r.animationFrame=0))}),r};const SpoolUtils={forEachInObject:(e,t)=>{Object.keys(e).forEach(r=>{t(e[r],r)})},shuffle:e=>{e.sort(()=>Math.random()-.5)},subarray:(e,t,r)=>r<=t?[]:e.filter((e,o)=>o>=t&&o<r),arraysEqual:(e,t)=>{if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;++r)if(e[r]!==t[r])return!1;return!0}};try{module.exports={SpoolUtils:SpoolUtils}}catch(e){"undefined"==typeof module?console.log("Modules are not present, you are probably on client, make sure this script is included before the files that require it"):console.error(e)}
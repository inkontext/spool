const CAMERA_ROTATION_SPEED=.05,CAMERA_FOLLOW_SPEED=.4,CAMERA_SCALE_SPEED=.02,CAMERA_MINIMAL_SCALE=.5,CAMERA_MAXIMAL_SCALE=1,CAMERA_MAXIMAL_SCALE_HANDLEVEL=35;var Client=e=>{var t={keyToConstructor:{},spoolKeyToConstructor:{SPL_POINT:{const:Point},SPL_LINE:{const:Line},SPL_RECT:{const:Rectangle}},onMouseEvent:e=>{},onKeyEvent:e=>{},lastTime:0,frameCounter:0,chunkSize:1e3,FPS:60,pureLocalClient:!1,updateOnLoop:!1,serverSideLoading:!1,clientSideLoading:!1,...e};return t.frameTime=1e3/t.FPS,t.clientId=void 0,t.clientObject=void 0,t.width=window.innerWidth,t.height=window.innerHeight,t.gameArea=GameArea(t.width,t.height),t.camera=Camera({width:t.width,height:t.height,canvasWidth:t.width,canvasHeight:t.height}),t.handler=ClientHandler(t.chunkSize,t,t.pureLocalClient),t.uiHandler=SpoolUIHandler(),t.objectServer=ClientObjectServer(t),t.socketInit=(()=>{t.pureLocalClient&&console.warn("You've set the pureLocalClient flag to true, but are initializing sockets."),t.socket=io(),t.socket.on(MessageCodes.SM_PACK_INIT,e=>{for(key in e.resetHandler&&(t.handler.reset(),t.clientObject=void 0),e)if("resetHandler"!=key){var o=void 0;if(key in t.keyToConstructor?o=t.keyToConstructor[key]:key in t.spoolKeyToConstructor&&(o=t.spoolKeyToConstructor[key]),o)for(var r=0;r<e[key].length;r++){o.const||console.warn(`Spool: ${key} has invalid constructor function`);var n=o.const({...o.defs,...e[key][r]});n||console.error(`Object ${key} doesn't return anything, check if constructor returns self.`),n.clientInstance=t,t.handler.add(n)}else console.error(`Object ${key} doesn't have a constructor`)}t.firstInit||(t.onFirstLoad&&t.onFirstLoad(t),t.firstInit=!0)}),t.socket.on(MessageCodes.SM_RESET,e=>{t.client.handler.reset()}),t.socket.on(MessageCodes.ASIGN_CLIENT_ID,e=>{t.clientId=e.clientId,t.clientObjectFingerprint=e.clientObject}),t.socket.on(MessageCodes.SERVER_LOADING,e=>{console.log(e),t.serverSideLoading=e.loading,t.serverSideLoadingData=e}),t.socket.on(MessageCodes.SM_PACK_UPDATE,e=>{t.handler.update(e),t.camera.update(),t.clientId&&!t.clientObject&&(t.clientObject=t.handler.getObject(t.clientObjectFingerprint.objectType,t.clientObjectFingerprint.id),t.camera.followObject=t.clientObject,t.onClientObjectAssigned&&t.onClientObjectAssigned(t.clientObject))}),t.socket.on(MessageCodes.SM_PACK_REMOVE,e=>{console.log(),t.handler.removeBulk(e)}),t.objectServer.init(t.socket)}),t.emit=((e,o)=>{t.socket.emit(e,o)}),t.startGameLoop=(()=>{t.lastMillisTimer=Date.now(),t.lastMillis=Date.now(),t.lastFrameTime=Date.now(),t.loop()}),t.render=(()=>{try{t.background&&t.background(t.gameArea.ctx,t.camera),t.preHandler&&t.preHandler(t.gameArea.ctx,t.camera),t.handler.render(t.gameArea.ctx,t.camera),t.postHandler&&t.postHandler(t.gameArea.ctx,t.camera),t.uiHandler&&t.uiHandler.render(t.gameArea.ctx),t.postUi&&t.postUi(t.gameArea.ctx,t.camera)}catch(e){console.error(e.stack)}}),t.loop=(()=>{let e=Date.now();if(e-t.lastFrameTime>=t.frameTime){t.lastFrameTime;t.lastFrameTime=e,t.gameArea.clear(),t.loopUpdateCall&&(t.handler.update(),t.camera.update()),t.render(),Date.now()-t.lastMillisTimer>=1e3?(t.frameCounter=0,t.lastMillisTimer=Date.now()):t.frameCounter+=1}setTimeout(t.loop)}),t.initResizeListener=(()=>{window.onresize=(e=>{t.width=window.innerWidth,t.height=window.innerHeight,t.gameArea.resize(t.width,t.height),t.camera.width=t.width,t.camera.height=t.height})}),t},GameArea=(e=500,t=500)=>{var o={};return o.canvas=document.createElement("CANVAS"),o.resize=((e,t)=>{o.width=e,o.height=t,o.canvas.width=e,o.canvas.height=t}),o.resize(e,t),document.getElementById("spool-root").appendChild(o.canvas),o.canvas.oncontextmenu=function(e){e.preventDefault()},o.ctx=o.canvas.getContext("2d"),SpoolRenderer.ctx=o.ctx,SpoolRenderer.camera=o.camera,o.clear=(()=>{o.ctx.clearRect(0,0,o.canvas.width,o.canvas.height),o.renderBackground()}),o.renderBackground=(()=>{o.ctx.beginPath(),o.ctx.rect(0,0,o.canvas.width,o.canvas.height),o.ctx.fillStyle="white",o.ctx.fill()}),o},TextureManager=(e,t)=>{var o={spriteSheetInitObject:e,objectSheetInitObject:t,spriteSheets:{},objectSheets:{},onLoad:null,loadCounter:0,targetLoad:0,chunkBlankSize:500,chunkBlankImage:null,load:()=>{o.textures={};var e=Object.keys(o.spriteSheetInitObject);o.targetLoad=e.length,e.forEach(e=>{var t=new Image;t.onload=(()=>{var r=(k=document.createElement("canvas")).getContext("2d"),n=o.spriteSheetInitObject[e].r?o.spriteSheetInitObject[e].r:1,a=o.spriteSheetInitObject[e].c?o.spriteSheetInitObject[e].c:1,i=t.width/a,s=t.height/n;k.width=i,k.height=s;for(var l=[],h=[],c=0;c<n;c++)for(var d=0;d<a;d++){r.clearRect(0,0,i,s),r.imageSmoothingEnabled=!1,r.drawImage(t,d*i,c*s,i,s,0,0,i,s);var u=new Image;u.src=k.toDataURL("image/png"),l.push(u);for(var p=new Image,y=r.getImageData(0,0,k.width,k.height),g=y.data,x=[],f=k.height-1;f>-1;f--){for(var m=[],v=0;v<k.width;v++)m.push(0,0,0,g[f*k.width*4+4*v+3]/2);x.push(...m)}for(var b=0,S=g.length;b<S;b++)g[b]=x[b];r.putImageData(y,0,0),p.src=k.toDataURL("image/png"),h.push(p)}o.spriteSheets[e]={title:e,textureMap:t,rows:n,columns:a,sprites:l,shadowSprites:h},o.loadCounter+=1,o.loadCounter>=o.targetLoad&&o.onLoad&&o.prepareChunkImage();var k;r=(k=document.createElement("canvas")).getContext("2d")}),t.src=o.spriteSheetInitObject[e].src})},getSubSpriteSheet:(e,t,r,n,a)=>{var i=n-t+1,s=a-r+1,l=[],h=[],c=o.spriteSheets[e];if(!c)return console.error(`${e} is not in the texture manager`),null;for(var d=r;d<=a;d++)for(var u=t;u<=n;u++){var p=d*c.columns+u;l.push(c.sprites[p]),h.push(c.shadowSprites[p])}return{textureMap:c.textureMap,rows:s,columns:i,sprites:l,shadowSprites:h}},getSprite:(e,t=0,r=0)=>o.spriteSheets[e]?o.spriteSheets[e].sprites[r*o.spriteSheets[e].columns+t]:(console.error(`@TextureManager: ${e} is not in spritesheets`),null),getSprites:e=>o.spriteSheets[e]?o.spriteSheets[e].sprites:(console.error(`@TextureManager: ${e} is not in spritesheets`),null),prepareChunkImage:()=>{var e=document.createElement("canvas");e.getContext("2d");e.width=o.chunkBlankSize,e.height=o.chunkBlankSize;var t=new Image;t.src=e.toDataURL("image/png"),o.chunkBlankImage=t,o.prepareObjectSheets()},prepareObjectSheets:()=>{o.objectSheetInitObject||console.error("Spool: Invalid objectSheetInitObject");var e=Object.keys(o.objectSheetInitObject);o.targetLoad=e.length,e.forEach(e=>{var r=t[e],n=o.spriteSheets[r.src],a=SpoolMath.numberDefined(r.x)?r.x:0,i=SpoolMath.numberDefined(r.y)?r.y:0,s=SpoolMath.numberDefined(r.xx)?r.xx:n.columns-1,l=SpoolMath.numberDefined(r.yy)?r.yy:n.rows-1,h=s-a+1,c=l-i+1;r.variantBox&&(h=r.variantBox.c,c=r.variantBox.r);for(var d=[],u=i;u<=l;u+=c)for(var p=a;p<=s;p+=h){var y=o.getSubSpriteSheet(r.src,p,u,p+h-1,u+c-1);y.title=e,d.push(y)}o.objectSheets[e]=d}),o.onLoad()},textureObj:e=>{var t=o.objectSheets[e.objectType];if(t){tid=e.textureId?e.textureId:0;var r=t[SpoolMath.randomInt(0,t.length-1)];e.sprite=r.sprites[tid%r.sprites.length],e.shadowSprite=r.shadowSprites[tid%r.sprites.length],e.texture=r}else"SPL_CHUNK"==e.objectType&&(e.sprite=o.chunkBlankImage)},resizeSprite:(e,t,o,r)=>{var n=document.createElement("canvas"),a=n.getContext("2d");n.width=t,n.height=o,a.imageSmoothingEnabled=!1,a.drawImage(e,0,0,t,o);var i=new Image;i.src=n.toDataURL("image/png"),i.onload=(()=>{r(i)})},resizeSprites:(e,t,o,r)=>{t&&o||console.warn("@textureManager resizedSprite: Width and height error");for(var n=0,a=[],i=e.length;i--;)a.push(1);var s=0,l=document.createElement("canvas"),h=l.getContext("2d");l.width=t,l.height=o,e.forEach(i=>{h.clearRect(0,0,t,o),h.imageSmoothingEnabled=!1,h.drawImage(i,0,0,t,o);var c=new Image;c.posInList=n,c.src=l.toDataURL("image/png"),c.onload=(t=>{a[t.target.posInList]=c,(s+=1)==e.length&&r(a)}),n++})},bakeIn:(e,t,o,r,n=null)=>{var a=document.createElement("canvas"),i=a.getContext("2d");a.width=e.width,a.height=e.height,i.imageSmoothingEnabled=!1,i.drawImage(e,0,0),i.drawImage(t,o.x,o.y,o.width,o.height);var s=new Image;s.src=a.toDataURL("image/png"),s.onload=(()=>{r(s,n)})},bakeBatch:(e,t,o,r)=>{var n=document.createElement("canvas"),a=n.getContext("2d");n.width=e.width,n.height=e.height,a.imageSmoothingEnabled=!1,a.drawImage(e,0,0),t.forEach(e=>{a.drawImage(e.bakedTexture,e.dBounds.x,e.dBounds.y,e.dBounds.width,e.dBounds.height)});var i=new Image;i.src=n.toDataURL("image/png"),i.onload=(()=>{o(i,r)})}};return o};cameraContainsEntity=((e,t)=>{let o=({x:x,y:y,width:width,height:height}=e.transformBounds(t.x,t.y,2*t.radius,2*t.radius));return 0<=o.x+o.width/2&&o.x-o.width/2<=e.width*e.scale&&0<=o.y+o.height/2&&o.y-o.height/2<=e.height*e.scale});var Grid=()=>{var e={rowGap:200,columnGap:200,render:(t,o)=>{for(var r=o.x-o.width*CAMERA.scale,n=o.y-o.width*CAMERA.scale;r<(o.x+o.width)/CAMERA.scale;){var a=o.y-o.width,i=o.y+o.width,s=r+-o.x%e.columnGap,l=r+-o.x%e.columnGap;let n=({x:x,y:y}=o.transformPoint(s,a));s=n.x,a=n.y;let h=({x:x,y:y}=o.transformPoint(l,i));l=h.x,i=h.y,t.beginPath(),t.moveTo(s,a),t.strokeStyle="gray",t.lineWidth=1,t.lineTo(l,i),t.stroke(),r+=e.columnGap}for(;n<(o.y+o.width)/CAMERA.scale;){var h=n+-o.y%e.rowGap,c=n+-o.y%e.rowGap,d=o.x-o.width,u=o.x+o.width;let r=({x:x,y:y}=o.transformPoint(d,h));d=r.x,h=r.y;let a=({x:x,y:y}=o.transformPoint(u,c));u=a.x,c=a.y,t.beginPath(),t.moveTo(d,h),t.strokeStyle="gray",t.lineTo(u,c),t.stroke(),n+=e.rowGap}}};return e},ObjectRadar=(e,t,o,r)=>{var n={handler:e,camera:t,objectType:o,radius:r,render:e=>{if(t.followObject&&n.objectType in n.handler.objects){var r=n.handler.objects[o];for(id in r){if(id==t.followObject.id)continue;var a=r[id];if(cameraContainsEntity(t,a))continue;var i=2*Math.PI-SpoolMath.objGlobalAngle(t.followObject,a)+t.rotation;e.fillStyle=a.color;let o=({x:x,y:y}=SpoolMath.polarPoint(t.width/2*t.scale,t.height/2*t.scale,200,i));var s=o.x,l=o.y;let n=({x:x,y:y}=SpoolMath.polarPoint(o.x,o.y,20,i+3*Math.PI/4)),h=({x:x,y:y}=SpoolMath.polarPoint(s,l,20,i+5*Math.PI/4));e.beginPath(),e.moveTo(o.x,o.y),e.lineTo(n.x,n.y),e.lineTo(h.x,h.y),e.closePath(),e.fill()}}}};return n},ClientObjectServer=(e,t=[])=>{var o={client:e,objects:{},init:()=>{o.client.socket.on(MessageCodes.OS_SEND_OBJ,e=>{o.add(e)})},load:e=>{o.client.socket.emit(MessageCodes.OS_GET_OBJ,e)},getObject:e=>{var t=e.objectType,r=e.id,n=o.objects[t];if(n){var a=n[r];if(a)return a}return null},add:e=>{e.objectType in o.objects||(o.objects[e.objectType]={}),o.objects[e.objectType][e.id]?Object.assign(o.objects[e.objectType][e.id],e):o.objects[e.objectType][e.id]=e},remove:(e,t)=>{e in o.objects&&delete o.objects[e][t]}};return o},ClientHandler=(e,t,o=!1)=>{var r=Handler({client:t,chunkSize:e,chunkConstructor:ClientChunk}),n={add:r.add};return o||(r.update=(e=>{for(key in e)if(r.objects[key])for(var t=0;t<e[key].length;t++){var o=e[key][t];if(r.objects[key][o.id]){var n={...o};delete n.id,r.objects[key][o.id].update(n),r.updateObjectsChunk(r.objects[key][o.id])}}})),r.onChunkCreated=(e=>{r.textureManager&&r.textureManager.textureObj(e)}),r.render=((e,t)=>{var o=Math.floor((t.x-t.width/2-100)/r.chunkSize),n=Math.floor((t.y-t.height/2-100)/r.chunkSize),a=Math.floor((t.x+t.width/2+100)/r.chunkSize),i=Math.floor((t.y+t.height/2+100)/r.chunkSize),s=r.getChunks(o,n,a,i),l={},h={};for(chunkKey in s){var c=s[chunkKey],d=c.objects;if(c.sprite){var u=t.transformBounds(c.x*r.chunkSize,(c.y+1)*r.chunkSize,r.chunkSize,r.chunkSize);e.drawImage(c.sprite,u.x,u.y,u.width,u.height)}for(key in d)for(id in d[key]){var p=c.objects[key][id];if(p.bakeIn){if(!p.bakedIn||!p.bakedIn.includes(c.key)){var y=p.getRenderBounds(),g=c.sprite.width/r.chunkSize,x=c.sprite.height/r.chunkSize,f={bakedTexture:p.sprite,dBounds:{x:(y.x-c.x*r.chunkSize)*g,y:(r.chunkSize-(y.y-c.y*r.chunkSize)-y.height)*x,width:y.width*g,height:y.height*x},attributes:{obj:p,chunk:c},callback:(e,t,o)=>{e.attributes.chunk.sprite=t,e.attributes.obj.bakedIn=!0}},m=c.key;m in h||(h[m]={}),p.layer in h[m]||(h[m][p.layer]=[]),h[m][p.layer].push(f)}}else p.layer in l?l[p.layer][id]=p:l[p.layer]={id:p}}}for(key in h)if(key in r.chunks){var v=[],b=[];Object.keys(h[key]).sort((e,t)=>parseInt(e)-parseInt(t)).forEach(e=>{h[key][e].forEach(e=>{v.push({bakedTexture:e.bakedTexture,dBounds:e.dBounds}),b.push(e.attributes.obj)})}),callback=((e,t)=>{r.chunks[t.key].sprite=e,b.forEach(e=>{e.bakedIn?e.bakedIn.push(t.key):e.bakedIn=[t.key]})}),r.textureManager.bakeBatch(r.chunks[key].sprite,v,callback,{key:key})}else console.warn("invalid chunk added to baking:",key);Object.keys(l).sort((e,t)=>parseInt(e)-parseInt(t)).forEach(o=>{Object.keys(l[o]).sort((e,t)=>l[o][t].y-l[o][e].y).forEach(r=>{l[o][r].render(e,t)})})}),r.preBake=(()=>{var e=r.chunks,t={};for(chunkKey in e){var o=e[chunkKey],n=o.objects;for(key in n)for(id in n[key]){var a=o.objects[key][id];if(r.updateObjectsChunk(a),a.bakeIn&&(!a.bakedIn||!a.bakedIn.includes(o.key))){var i=a.getRenderBounds(),s=o.sprite.width/r.chunkSize,l=o.sprite.height/r.chunkSize,h={bakedTexture:a.sprite,dBounds:{x:(i.x-o.x*r.chunkSize)*s,y:(r.chunkSize-(i.y-o.y*r.chunkSize)-i.height)*l,width:i.width*s,height:i.height*l},callback:(e,t)=>{t.chunk.sprite=e,t.obj.bakedIn=!0},attributes:{obj:a,chunk:o}},c=o.key;c in t||(t[c]={}),a.layer in t[c]||(t[c][a.layer]=[]),t[c][a.layer].push(h)}}}for(key in t)if(key in r.chunks){var d=[],u=[];Object.keys(t[key]).sort((e,t)=>parseInt(e)-parseInt(t)).forEach(e=>{t[key][e].forEach(e=>{d.push({bakedTexture:e.bakedTexture,dBounds:e.dBounds}),u.push(e.attributes.obj)})}),callback=((e,t)=>{r.chunks[t.key].sprite=e,t.waitingList.forEach(e=>{e.bakedIn?e.bakedIn.push(t.key):e.bakedIn=[t.key]})}),r.textureManager.bakeBatch(r.chunks[key].sprite,d,callback,{key:key,waitingList:u})}else console.warn("invalid chunk added to baking")}),r.add=(e=>{n.add(e),r.textureManager&&r.textureManager.textureObj(e)}),r.removeBulk=(e=>{for(key in e)if(key in r.objects)for(var t=0;t<e[key].length;t++)e[key][t]in r.objects[key]&&r.remove(r.objects[key][e[key][t]])}),r.reset=(()=>{var o={objects:{},objectsById:{},chunks:{},client:t,chunkSize:e};Object.keys(o).forEach(e=>{delete r.key}),Object.assign(r,o)}),r},ClientChunk=(e,t)=>{return Chunk({objectType:"SPL_CHUNK",...e},t)},Camera=(e={})=>{var t={x:0,y:0,rotation:0,width:0,height:0,canvasWidth:0,canvasHeight:0,scaleX:1,scaleY:1,followSpeed:.4,rotationSpeed:.05,followObject:null,offsetX:0,offsetY:0,...e,update:()=>{if(t.followObject){if(t.lerpRotation&&(t.rotation=SpoolMath.lerpRotation(t.rotation,t.followObject.rotation-Math.PI/2,t.rotationSpeed)),t.lerpSpeedToScale)t.followObject.velocity&&t.followObject.velocity;t.width=t.canvasWidth/t.scaleX,t.height=t.canvasHeight/t.scaleY,t.lerp&&(t.x=SpoolMath.lerp(t.x,t.followObject.x+t.offsetX,t.followSpeed),t.y=SpoolMath.lerp(t.y,t.followObject.y+t.offsetY,t.followSpeed))}else t.followObject&&(t.x=t.followObject.x+t.offsetX,t.y=t.followObject.y+t.offsetY);t.onUpdate&&t.onUpdate(t)},transformBounds:(e,o,r,n)=>{let a=({x:e,y:o}=t.transformPoint(e,o));return{x:a.x,y:a.y,width:r*t.scaleX,height:n*t.scaleY}},transformPoint:(e,o)=>{var r=Math.sin(t.rotation),n=Math.cos(t.rotation);return{x:t.scaleX*((e-t.x)*n-(-o+t.y)*r+t.width/2),y:t.scaleY*((e-t.x)*r+(-o+t.y)*n+t.height/2)}},transformDimension:e=>t.scaleX*e,clickTransfer:(e,o)=>{var r=SpoolMath.distance(e,o,t.width/2,t.height/2),n=t.rotation+Math.atan2(o-t.height/2,e-t.width/2);return{x:t.x+Math.cos(n)*r,y:t.y+Math.sin(n)*r}},inverseTransformPoint:(e,o)=>{var r=Math.sin(t.rotation),n=Math.cos(t.rotation),a=t.y-(-r*(e/t.scaleX-t.width/2)+n*(o/t.scaleY-t.height/2));return{x:n*(e/t.scaleX-t.width/2)+r*(o/t.scaleY-t.height/2)+t.x,y:a}},setFollowObject:e=>{e&&(t.followObject=e,t.angle=e.angle)}};return t},ClientEntity=(e,t=null)=>{var o={x:0,y:0,rotation:0,radius:10,color:"red",layer:10,animationCounter:0,animationTime:0,animationFrame:0,animationSize:0,...e};if(t)var r=t(o);else r=o;return r.update=(e=>{Object.assign(r,e)}),r.render=((e,t)=>{r.renderOval(e,t)}),r.renderOval=((e,t,o=r.color)=>{e.fillStyle=o;var n=t.transformBounds(r.x,r.y,r.width,r.height);SpoolRenderer.fillInscribedOval(new SpoolRect(n.x-n.width/2,n.y-n.height/2,n.width,n.height))}),r.renderNtagon=((e,t,o,n,a=0,i=r.color)=>{e.fillStyle=i,e.beginPath();var s=t.transformBounds(r.x,r.y,n,n),l=s.width;e.moveTo(s.x-l*Math.cos(a),s.y-l*Math.sin(a));for(var h=1;h<o;h++)angle=a+2*Math.PI/o*h,e.lineTo(s.x-l*Math.cos(angle),s.y-l*Math.sin(angle));e.closePath(),e.fill()}),r.renderRectangle=((e,t,o=r.color)=>{var n=t.transformBounds(r.x,r.y,r.width,r.height);e.beginPath(),e.lineWidth="1",e.rect(Math.floor(n.x-n.width/2),Math.floor(n.y-n.height/2),n.width,n.height),e.fillStyle=o,e.fill()}),r.renderSprite=((e,t,o=r.sprite,n=null)=>{if(o){var a;if(n)a=n;else{var i=r.width,s=r.height,l=r.x,h=r.y;r.clientWidth&&(i=r.clientWidth),r.clientHeight&&(s=r.clientHeight);var c=t.transformBounds(l,h,i,s),d=r.width/2,u=r.height/2;r.clientOffsetX&&(d=r.clientOffsetX),r.clientOffsetY&&(u=r.clientOffsetY);var p=t.transformBounds(l,h,d,u);e.imageSmoothingEnabled=!1,a={x:c.x-p.width,y:c.y-p.height,width:c.width,height:c.height}}return e.drawImage(o,a.x,a.y,a.width,a.height),r.showBounds&&r.renderRectangle(e,t,r.color),a}return r.renderRectangle(e,t,"violet"),null}),r.renderRotatedSprite=((e,t,o,r,n,a,i)=>{e.save();var s=t.transformPoint(o,r);e.translate(s.x,s.y),e.rotate(n),e.drawImage(a,i.x,i.y,i.width,i.height),e.restore()}),r.getMovementAnimationSpriteIndex=((e=r.moving,t=r.movementAngle)=>{var o=r.texture.rows-1;if(e){var n=t;n<0&&(n+=2*Math.PI),(n=n/Math.PI/2+1/o/2)<0&&(n+=1),n%=1;var a=Math.floor(n*o)%o+1}else a=0;return a*r.texture.columns+r.animationFrame}),r.renderMovementAnimation=((e,t,o=null)=>{if(o)var n=o;else n=r.getMovementAnimationSpriteIndex();return r.animationCounter==r.animationTime?(r.texture&&(r.animationFrame+=1,r.animationFrame==r.texture.columns&&(r.animationFrame=0)),r.animationCounter=0):r.animationCounter+=1,[r.renderSprite(e,t,r.texture.sprites[n]),n]}),r.getRenderBounds=((e=null)=>{if(e){l=r.width,h=r.height;var t=r.x,o=r.y;r.clientWidth&&(l=r.clientWidth),r.clientHeight&&(h=r.clientHeight);s=e.transformBounds(t,o,l,h),a=r.width/2,i=r.height/2;r.clientOffsetX&&(a=r.clientOffsetX),r.clientOffsetY&&(i=r.clientOffsetY);var n=e.transformBounds(t,o,a,i);return ctx.imageSmoothingEnabled=!1,finalBounds={x:s.x-n.width,y:s.y-n.height,width:s.width,height:s.height},finalBounds}var a=r.width/2,i=r.height/2;r.clientOffsetX&&(a=r.clientOffsetX),r.clientOffsetY&&(i=r.clientOffsetY);var s,l=r.width,h=r.height;return r.clientWidth&&(l=r.clientWidth),r.clientHeight&&(h=r.clientHeight),s={x:r.x-a,y:r.y-i,width:l,height:h}}),r},RectangleEntity=e=>{var t=ClientEntity(e);return t.render=((e,o)=>{t.renderRectangle(e,o)}),t},SpriteEntity=e=>{var t=ClientEntity(e);return t.render=((e,o)=>{t.renderSprite(e,o)}),t},MovementAnimationEntity=e=>{var t=ClientEntity({...e,animationTime:5});return t.render=((e,o)=>{t.renderMovementAnimation(e,o)}),t},Point=e=>{var t={x:0,y:0,xx:0,yy:0,color:"green",...e,update:e=>{Object.assign(t,e)},render:(e,o)=>{e.fillStyle=t.color,e.beginPath();let{x:r,y:n,width:a}=o.transformBounds(t.x,t.y,3,3);e.arc(r,n,a,0,360),e.stroke()}};return t},Line=e=>{var t=Entity({x:0,y:0,xx:0,yy:0,color:"green",...e});return t.render=((e,o)=>{let r=o.transformPoint(t.x,t.y);var n=o.transformPoint(t.xx,t.yy);e.strokeStyle=t.color,e.beginPath(),e.moveTo(r.x,r.y),e.lineTo(n.x,n.y),e.stroke()}),t},Rectangle=e=>{var t={x:0,y:0,xx:0,yy:0,color:"green",...e,update:e=>{Object.assign(t,e)},render:(e,o)=>{let r=o.transformPoint(t.x,t.y);var n=o.transformPoint(t.xx,t.yy);e.beginPath(),e.lineWidth="1",e.rect(r.x,r.y,n.x-r.x,n.y-r.y),t.fill?(e.fillStyle=t.color,e.fill()):(e.strokeStyle=t.color,e.stroke())}};return t},KeyboardListener=(e,t)=>{var o={client:e,keyListeners:{65:{inputMessage:MessageCodes.KI_MOV_LEFT,parameter:"pressedLeft"},87:{inputMessage:MessageCodes.KI_MOV_UP,parameter:"pressedUp"},68:{inputMessage:MessageCodes.KI_MOV_RIGHT,parameter:"pressedRight"},83:{inputMessage:MessageCodes.KI_MOV_DOWN,parameter:"pressedDown"}},additionalKeyListeners:{},activeTypes:["keydown","keyup"],...t};return o.handleKeyDown=o.activeTypes.includes("keydown"),o.handleKeyUp=o.activeTypes.includes("keyup"),Object.assign(o.keyListeners,o.additionalKeyListeners),o.onEvent=((e,t)=>{e.keyCode in o.keyListeners&&(listener=o.keyListeners[e.keyCode],o.client.pureLocalClient?o.client.clientObject&&(o.client.clientObject[listener.parameter]=t):o.client.socket.emit(MessageCodes.SM_KEY_PRESS,{inputId:listener.inputMessage,value:t}))}),o.initListener=(()=>{document.onkeydown=(e=>{o.handleKeyDown&&o.onEvent(e,!0),o.onKeyDown&&o.onKeyDown(e)}),document.onkeyup=(e=>{o.handleKeyUp&&o.onEvent(e,!1),o.onKeyUp&&o.onKeyUp(e)})}),o},MouseListener=(e,t)=>{var o={client:e,mouseCoordTransformation:null,activeButtons:[0,2],activeTypes:["mousedown","mouseup"],pressed:!1,...t,onMouseButtonEvent:(t,r,n)=>{o.client.uiHandler.mouseEvent(t)||(o.gamePlaneMouseButtonEvent(t,r,n),o.client.onMouseEvent(t,e))},gamePlaneMouseButtonEvent:(t,r,n)=>{if(o.activeButtons.includes(t.button)&&o.activeTypes.includes(t.type)){var a="mousedown"==t.type||"mouseup"!=t.type&&null;if(null===a)return void console.error("@MouseListener, event value is null");o.client.pureLocalClient?e.clientObject.mouseEventInWorld&&e.clientObject.mouseEventInWorld(r,n,t):o.client.socket.emit(MessageCodes.SM_MOUSE_INPUT,{x:r,y:n,value:a,type:t.type})}},initListener:()=>{document.onmousedown=(e=>{var t=e.clientX,r=e.clientY;if(o.pressed=!0,o.mouseCoordTransformation){var n=o.mouseCoordTransformation(t,r);t=n.x,r=n.y}o.onMouseDown&&o.onMouseDown(e,t,r),o.onMouseButtonEvent(e,t,r)}),document.onmouseup=(e=>{var t=e.clientX,r=e.clientY;if(o.pressed=!1,o.mouseCoordTransformation){var n=o.mouseCoordTransformation(t,r);t=n.x,r=n.y}o.onMouseUp&&o.onMouseUp(e,t,r),o.onMouseButtonEvent(e,t,r)}),document.onmousemove=(e=>{o.onMouseMove&&o.onMouseMove(e),o.client.uiHandler.mouseMove(e)})}};return o};const FileReader={readImage:(e,t,o=4)=>{var r=new Image;r.onload=(()=>{var e=document.createElement("canvas");e.width=r.width,e.height=r.height;var n=e.getContext("2d");n.drawImage(r,0,0,r.width,r.height);var a=n.getImageData(0,0,r.width,r.height);t({data:a.data,width:a.width,height:a.height,pixelSize:o})}),r.src=e}};try{SpoolMath=require("./spoolmath.js").SpoolMath}catch(e){console.warn("SpoolMath require importing failed, require is most likely not present, make sure you are importing SpoolMath in another way")}try{SpoolUtils=require("./spoolutils.js").SpoolUtils}catch(e){console.warn("SpoolUtils require importing failed, require is most likely not present, make sure you are importing SpoolMath in another way")}try{FileReader=require("../spoolfilereader.js").FileReader}catch(e){console.warn("FileReader require importing failed, require is most likely not present, make sure you are importing SpoolMath in another way")}try{var Perlin=require("perlin-noise")}catch(e){console.warn("Perlin noise is not available without require (server side)")}var Chunk=(e,t)=>{var o={x:0,y:0,width:0,height:0,handler:t,objects:{},...e,add:e=>{e.objectType in o.objects||(o.objects[e.objectType]={}),o.objects[e.objectType][e.id]=e},removeSignature:(e,t)=>{e in o.objects&&delete o.objects[e][t]},remove:e=>{o.removeSignature(e.objectType,e.id)},getClosestObject:(e,t,r)=>{var n=null;for(key in o.objects)if(!r||!r.whitelist||r.whitelist.includes(key))for(id in o.objects[key]){var a=o.objects[key][id],i=SpoolMath.distance(e,t,a.x,a.y);(!n||i<n.distance)&&(n={object:a,distance:i})}return n}};return o},Handler=(e={})=>{var t={objectsById:{},objects:{},chunks:{},staticKeys:[],preManagers:[],managers:[],chunkSize:300,chunkConstructor:Chunk,...e,resetObjects:()=>{Object.assign(t,{objectsById:{},objects:{},chunks:{}})},updateObjectsChunk:e=>{var o=!1,r=Math.floor((e.x-e.width/2)/t.chunkSize),n=Math.floor((e.y-e.height/2)/t.chunkSize),a=Math.floor((e.x+e.width/2)/t.chunkSize),i=Math.floor((e.y+e.height/2)/t.chunkSize);if(e.chunks)if(0==e.chunks.length)o=!0;else{if(r==e.chunksX&&n==e.chunksY&&a==e.chunksXX&&i==e.chunksYY)return;o=!0,e.chunks.forEach(t=>{t.remove(e)})}else o=!0;if(o&&(e.chunksX=r,e.chunksY=n,e.chunksXX=a,e.chunksYY=i,e.chunks=[],o))for(var s=r;s<a+1;s++)for(var l=n;l<i+1;l++){var h=`[${s};${l}]`,c=void 0;h in t.chunks?c=t.chunks[h]:(c=t.chunkConstructor({x:s,y:l,width:t.chunkSize,height:t.chunkSize,key:h,color:SpoolMath.randomHsvColor(.5,.8)},t),t.chunks[h]=c,t.onChunkCreated&&t.onChunkCreated(c)),c.add(e),e.chunks.push(c),e.chunkColor=c.color}},update:()=>{for(key in t.objects)if(!t.staticKeys.includes(key)){var e=t.objects[key];for(objKey in e){var o=e[objKey];if(!o.static){for(var r=0;r<t.preManagers.length;r++)t.preManagers[r].update(o);t.updateObjectsChunk(o),o.update();for(r=0;r<t.managers.length;r++)t.managers[r].update(o)}}}for(r=0;r<t.managers.length;r++)t.managers[r].handlerUpdate&&t.managers[r].handlerUpdate()},add:e=>{e.objectType in t.objects||(t.objects[e.objectType]={}),t.objects[e.objectType][e.id]=e,t.objectsById[e.id]=e,t.updateObjectsChunk(e)},removeSignature:(e,o)=>{e in t.objects&&(t.objects[e][o]&&t.objects[e][o].chunks&&t.objects[e][o].chunks.forEach(r=>{r.remove(t.objects[e][o])}),delete t.objects[e][o]),delete t.objectsById[o]},remove:e=>{t.removeSignature(e.objectType,e.id)},emptyObjectType:e=>{if(e in t.objects){var o=t.objects[e];Object.keys(o).forEach(o=>{t.remove(e,o)})}},getObject:(e,o)=>t.objects[e]&&t.objects[e][o]?t.objects[e][o]:null,getClosestObject:(e,o,r)=>{var n=Math.floor(e/t.chunkSize),a=Math.floor(o/t.chunkSize),i=null;if(t.getChunks(n,a,n,a).forEach(t=>{var n=t.getClosestObject(e,o,r);n&&(!i||n.distance<i.distance)&&(i=n)}),!i)for(key in t.chunks){var s=t.chunks[key].getClosestObject(e,o,r);s&&(!i||s.distance<i.distance)&&(i=s)}return i},addManager:e=>{t.managers.push(e)},addPreManager:e=>{t.preManagers.push(e)},getChunks:(e,o,r,n)=>{result=[];for(var a=e;a<=r;a++)for(var i=o;i<=n;i++){var s=`[${a};${i}]`;s in t.chunks&&result.push(t.chunks[s])}return result},getChunksForRect:e=>t.getChunks(Math.floor(e.x/t.chunkSize),Math.floor(e.y/t.chunkSize),Math.floor(e.xx/t.chunkSize),Math.floor(e.yy/t.chunkSize)),getObjectsInRect:(e,o=[],r=!0)=>{for(var n=t.getChunksForRect(e),a=[],i=0;i<n.length;i++){var s=n[i];for(bType in s.objects)if(onList=o.includes(bType),onList!=r)for(bKey in s.objects[bType]){var l=s.objects[bType][bKey];!l.SPL_COLL_MARKER&&e.collision(l.getBounds())&&(a.push(l),l.SPL_COLL_MARKER=!0)}}return a.forEach(e=>{delete e.SPL_COLL_MARKER}),a}};return t},CollisionManager=(e,t)=>{var o={handler:t,...e};return o.colPairs.forEach(e=>{e.a.forEach(t=>{e.b.forEach(r=>{o.colPairs.push({a:t,b:r,func:e.func,exception:e.exception,solid:void 0===e.solid||e.solid,solidException:e.solidException})})})}),o.getNeededChunks=(e=>{if(e.x>e.px)var t=e.px-e.width/2,r=e.x+e.width/2;else t=e.x-e.width/2,r=e.px+e.width/2;if(e.y>e.py)var n=e.py-e.height/2,a=e.y+e.height/2;else n=e.y-e.height/2,a=e.py+e.height/2;return o.handler.getChunksForRect(new SpoolRect(t,n,r-t,a-n))}),o.update=(e=>{var r=e.objectType;if(r in t.objects)for(var n=0;n<o.colPairs.length;n++){var a=o.colPairs[n].a,i=o.colPairs[n].harsh;if(r==a)for(var s=o.colPairs[n].b,l=o.getNeededChunks(e),h=0;h<l.length;h++){var c=l[h];if(s in c.objects)for(bKey in c.objects[s]){var d=e,u=c.objects[s][bKey];if(!(d.objectType==u.objectType&&d.id==u.id||o.colPairs[n].exception&&o.colPairs[n].exception(d,u))){if("oval"==d.bodyType&&"oval"==u.bodyType)var p=o.objectOvalCollision;else p=o.objectRectCollision;var y=p(d,u,i);y&&y.result&&(o.colPairs[n].solid&&y.point&&(o.colPairs[n].solidException&&o.colPairs[n].solidException(d,u)||(d.x=Math.round(y.point.x),d.y=Math.round(y.point.y))),o.colPairs[n].func&&o.colPairs[n].func(d,u,y))}}}}}),o.objectOvalCollision=((e,t)=>{if(aradius=Math.max(e.width,e.height)/2,bradius=Math.max(t.width,t.height)/2,SpoolMath.distance(e.x,e.y,t.x,t.y)<aradius+bradius){var o,r=parseInt(e.px),n=parseInt(e.py),a=parseInt(e.x),i=parseInt(e.y),s=bradius+aradius,l=parseInt(t.x),h=parseInt(t.y),c=0;if(r!=a){var d=(i-n)/(a-r),u=n-r*d,p=u-h,y=d*d+1,g=p*p+l*l-s*s,x=(-(b=2*d*p-2*l)+(S=Math.sqrt(Math.pow(b,2)-4*y*g)))/(2*y),f=(-b-S)/(2*y),m=d*x+u,v=d*f+u;SpoolMath.distance(x,m,r,n)<SpoolMath.distance(f,v,r,n)?(o=x,c=m):(o=f,c=v)}else{var b,S,k=r;y=1,g=h*h+l*l-s*s+k*k-2*l*k,m=(-(b=-2*h)+(S=Math.sqrt(b*b-4*y*g)))/(2*y),v=(-b-S)/(2*y);SpoolMath.distance(k,m,r,n)<SpoolMath.distance(k,v,r,n)?(o=k,c=m):(o=k,c=v)}return{result:!0,x:o,y:c}}return null}),o.objMovementLine=(e=>({x:e.px,y:e.py,xx:e.x,yy:e.y})),o.objectRectCollision=((e,t,o=!1)=>{var r=SpoolMath.movingRectCollision(e.getBounds(),t.getBounds(),{x:e.px,y:e.py},o);return r.result&&r.point&&r.direction&&("left"==r.direction||"right"==r.direction?r.point.y=(r.point.y+e.y)/2:r.point.x=(r.point.x+e.x)/2),r}),o},OuterWorldManager=(e,t)=>{var o={handler:e,validObjects:t,update:e=>{if(o.validObjects.includes(e.objectType)&&e.objectType in o.handler.objects){var t=SpoolMath.distance(e.x,e.y,0,0);t>OUTER_EDGE?e.setAcc("outer-world",t/500,SpoolMath.globalAngle(e.x,e.y,0,0)):e.setAcc("outer-world",0,0)}}};return o},GravityManager=(e,t)=>{var o={handler:t,gravityType:"homogenous",G:2,colPairs:[],...e,update:e=>{"homogenous"==o.gravityType?o.homGravity(e):o.vecGravity(e)},vecGravity:e=>{var r=e.objectType,n=e.accelerations.gravity?e.accelerations.gravity.angle:0;if(e.setAcc("gravity",0,n),!e.ground&&!e.gravityLock&&r in t.objects)for(var a=0;a<o.colPairs.length;a++){if(r==o.colPairs[a].a){var i=o.colPairs[a].b;if(i in t.objects)for(bKey in t.objects[i]){var s=e,l=t.objects[i][bKey];SpoolMath.objDistance(s,l)<bradius*GRAVITY_RADIUS_COEF&&s.addToAcc("gravity",o.objectGravity(s,l),SpoolMath.objGlobalAngle(s,l))}}}e.rotation=e.accelerations.gravity.angle+Math.PI},objectGravity:(e,t)=>{var r=o.G*e.mass*t.mass/Math.pow(SpoolMath.objDistance(e,t),GRAVITY_RADIUS_POW);return gravity=r/e.mass},homGravity:e=>{e.gravityIgnore||e.setAcc("gravity",o.G,Math.PI/2*3)}};return o},SpoolTimer=(e,t,o=null)=>{var r={startTime:Date.now(),duration:e,event:t,object:o,active:!0,timeLeft:0,update:()=>{r.timeLeft=r.startTime+r.duration-Date.now(),r.timeLeft<0&&r.active&&(r.event(o),r.active=!1)},stop:()=>{r.active=!1}};return r},ObjectSpawner=(e,t,o={})=>{var r={keyToConstAndDefs:t,handler:e,...o,zones:{},zoneCounters:{},currentZoneMap:null,gx:10,gy:10,mapPxWidth:0,mapPxHeight:0,colTexturingMap:[[!0,!0,!0,!0],[!0,!1,!0,!1],[!1,!0,!1,!0],[!1,!0,!0,!0],[!0,!0,!1,!1],[!1,!0,!1,!1],[!1,!0,!0,!1],[!0,!1,!0,!0],[!0,!1,!1,!1],[!1,!1,!1,!1],[!1,!1,!0,!1],[!0,!0,!1,!0],[!0,!1,!1,!0],[!1,!1,!1,!0],[!1,!1,!0,!0],[!0,!0,!0,!1]],reset:()=>{Object.assign(r,{zones:{},zoneCounters:{}})},spawn:(e,o=0,n=0)=>{if(e in r.keyToConstAndDefs){var a=t[e],i=a.const({...a.defs,x:o,y:n});return r.handler.add(i),i}},spawnInRadius:(e,o,n,a=0,i=0)=>{if(e in r.keyToConstAndDefs)for(var s=t[e],l=0;l<o;l++){var h=Math.random()*Math.PI*2,c=Math.random()*n,d=a+c*Math.cos(h),u=i+c*Math.sin(h),p=s.const({...s.defs,x:d,y:u});r.handler.add(p)}},spawnInRectangle:(e,o,n,a,i,s)=>{if(e in r.keyToConstAndDefs)for(var l=t[e],h=0;h<o;h++){var c=n+i*Math.random(),d=a+s*Math.random(),u=l.const({...l.defs,x:c,y:d});r.handler.add(u)}},zoneStep:(e,t,o,n)=>{if(r.currentZoneMap[t][e]){var a=r.currentZoneMap[t][e];a.key==o.key&&a.color==o.color&&(r.zoneMap[t][e][o.key]=n,r.zones[o.key]||(r.zones[o.key]={}),r.zones[o.key][n]||(r.zones[o.key][n]=[]),r.zones[o.key][n].push([e,t]),r.currentZoneMap[t][e]=null,r.zoneStep(e-1,t,o,n),r.zoneStep(e+1,t,o,n),r.zoneStep(e,t-1,o,n),r.zoneStep(e,t+1,o,n))}},addZonesFromImageArray:(e,t,o)=>{r.addZones(e[0],t,()=>{var n=e.slice(1);0==n.length?o():r.addZonesArray(n,t,o)})},addZonesFromImage:(e,t,o)=>{FileReader.readImage(e,e=>{var n=[],a=e.data;if(!r.zoneMap){for(var i=[],s=0;s<e.height;s++){for(var l=[],h=0;h<e.width;h++)l.push({});i.push(l)}r.zoneMap=i}for(s=0;s<e.height;s++){var c=[];for(h=0;h<e.width;h++){var d=(s*e.width+h)*e.pixelSize,u=a[d],p=a[d+1],y=a[d+2],g=t[SpoolMath.rgbToHex(u,p,y)];g?c.push({key:g,color:SpoolMath.rgbToHex(u,p,y)}):c.push(null)}n.push(c)}r.mapPxWidth=e.width,r.mapPxHeight=e.height;var x=r.zoneCounters;r.currentZoneMap=n;for(s=0;s<r.currentZoneMap.length;s++)for(h=0;h<r.currentZoneMap[s].length;h++){var f=r.currentZoneMap[s][h];f&&(f.key in x||(x[f.key]=0),r.zoneStep(h,s,f,x[f.key]),x[f.key]+=1)}r.zoneCounters=x,o&&o()})},spawnFromKeyArray:(e,o=r.gx,n=r.gy,a=null)=>{for(var i=0;i<e.length;i++)for(var s=0;s<e[i].length;s++)if(e[i][s]){var l=t[e[i][s]];if(l){var h={};l.dependantConst&&(h=l.dependantConst(r,a?a[i][s]:null));var c=l.const({...l.defs,x:parseInt((s-e[i].length/2)*o),y:parseInt((-i+e.length/2)*n),gridX:s,gridY:i,...h}),d=[e[i][s]];if(l.gridColRemovalSiblings&&(d=[e[i][s],...l.gridColRemovalSiblings]),c.gridColRemoval){s>0&&d.includes(e[i][s-1])&&(c.leftColIgnore=!0),s<e[i].length-1&&d.includes(e[i][s+1])&&(c.rightColIgnore=!0),i>0&&d.includes(e[i-1][s])&&(c.topColIgnore=!0),i<e.length-1&&d.includes(e[i+1][s])&&(c.bottomColIgnore=!0);var u=r.getColTextureId([!c.leftColIgnore,!c.topColIgnore,!c.rightColIgnore,!c.bottomColIgnore]);c.textureId=u,c.onGridColRemoval&&c.onGridColRemoval()}r.zoneMap&&Object.keys(r.zoneMap[i][s]).forEach(e=>{c.zones[e]=r.zoneMap[i][s][e]}),r.handler.add(c)}}},getColTextureId:e=>{for(var t=0;t<r.colTexturingMap.length;t++){for(var o=r.colTexturingMap[t],n=!1,a=0;a<e.length;a++)if(o[a]!==e[a]){n=!0;break}if(!n)return t}return 0},spawnFromIndexMap:(e,t=r.gx,o,n=" ",a="\r\n")=>{FileReader.readFile(e,e=>{var i=[],s=Object.keys(r.keyToConstAndDefs);e.split(a).forEach(e=>{var t=e.split(n);xPointer=0;var o=[];t.forEach(e=>{r.keyToConstAndDefs[s[parseInt(e)-1]]?o.push(s[parseInt(e)-1]):o.push(null)}),i.push(o)}),r.spawnFromKeyArray(i,t,o)})},spawnFromImageMap:(e,t,o,n=r.gx,a=r.gy)=>{FileReader.readImage(e,e=>{for(var i=[],s=(Object.keys(r.keyToConstAndDefs),e.data),l=t["non-black"],h=[],c=0;c<e.height;c++){for(var d=[],u=[],p=0;p<e.width;p++){var y=(c*e.width+p)*e.pixelSize,g=s[y],x=s[y+1],f=s[y+2],m=SpoolMath.rgbToHex(g,x,f),v=t[m];!l||v||0==g&&0==x&&0==f||(v=l),v?d.push(v):d.push(null),u.push([g,x,f,m])}i.push(d),h.push(u)}r.spawnFromKeyArray(i,n,a,h),o&&o()})},spawnRPGWorld:(e,t,o=r.gx,n=r.gy)=>{r.spawnFromImageMap(e.ground,t,o,n),r.spawnFromImageMap(e.objects,t,o,n)},spawnInZone:(e,o,n,a=null)=>{if(e in r.keyToConstAndDefs){var i=t[e];if(r.zones[n])for(var s=0;s<o;s++){var l=a;if(void 0==l||null==l){var h=Object.keys(r.zones[n]);l=h[Math.round(Math.random()*(h.length-1))]}var c=r.zones[n][l];if(c){var d=c[Math.round(Math.random()*(c.length-1))],u=(d[0]-r.mapPxWidth/2)*r.gx+Math.round(Math.random()*r.gx),p=(-d[1]+r.mapPxWidth/2)*r.gy+Math.round(Math.random()*r.gy),y=i.const({...i.defs,x:u,y:p});r.handler.add(y)}}}else console.log("@ObjectSpawner: Object key is not in known by object spawner: "+e)},getRandomPositionInZone:(e,t=null)=>{var o=t;if(!o){var n=Object.keys(r.zones[e]);o=n[Math.round(Math.random()*(n.length-1))]}var a=r.zones[e][o];if(a){var i=a[Math.round(Math.random()*(a.length-1))];return{x:(i[0]-r.mapPxWidth/2)*r.gx+Math.round(Math.random()*r.gx),y:(-i[1]+r.mapPxHeight/2)*r.gy+Math.round(Math.random()*r.gy)}}return null}};return r},Entity=(e={},t=null)=>{var o={asyncUpdatePackage:{},asyncUpdateNeeded:!1,x:0,y:0,velX:0,velY:0,calculatedVelX:0,calculatedVelY:0,movementAngle:0,rotation:0,accelerations:{},velocities:{},chunks:[],chunksX:0,chunksY:0,chunksXX:0,chunksYY:0,color:"red",zones:{},...GravityParameters,...CollisionParameters,...OvalBodyParameters,id:Math.random(),objectType:"BLANK_ENTITY",...e};if(t)var r=t(o);else r=o;return r.getEntityId=(()=>objectType+":"+id),r.update=(()=>{var e=!1;return r.updateVel(),(e|=r.updatePos())?r.updatePack():null}),r.initPack=(()=>{var e={};return void 0!==r.textureId&&(e.textureId=r.textureId),{...r.updatePack(),objectType:r.objectType,width:r.width,height:r.height,bodyType:r.bodyType,color:r.color,...e}}),r.updatePack=(()=>({x:r.x,y:r.y,color:r.color,rotation:r.rotation,id:r.id,movementAngle:r.movementAngle,moving:r.moving,...r.asyncUpdatePackage})),r.authorizedUpdatePack=(()=>null),r.setAsyncUpdateValue=((e,t)=>{r.asyncUpdatePackage[e]=t,r.asyncUpdateNeeded=!0}),r.addAsyncUpdatePackage=(e=>{Object.assign(r.asyncUpdatePackage,e),r.asyncUpdateNeeded=!0}),r.updatePos=(()=>{for(velKey in r.px=r.x,r.py=r.y,r.x+=r.velX,r.y+=r.velY,r.calculatedVelX=0,r.calculatedVelY=0,r.velocities){var e=r.velocities[velKey],t=SpoolMath.coordVelsFromVel(e.vel,e.angle);r.x+=t.x,r.y+=t.y,r.calculatedVelX+=t.x,r.calculatedVelY+=t.y}return r.px!=r.x||r.py!=r.y?(r.movementAngle=SpoolMath.globalAngle(r.px,r.py,r.x,r.y),r.moving=!0,!0):(r.moving=!1,!0)}),r.impulse=((e,t)=>{var o=SpoolMath.coordVelsFromVel(e,t);r.velX+=o.x,r.velY+=o.y}),r.vectorImpulse=((e,t)=>{r.velX+=e,r.velY+=t}),r.updateVel=(()=>{for(acckey in r.accelerations){var e=r.accelerations[acckey],t=SpoolMath.coordVelsFromVel(e.acc,e.angle);r.velX+=t.x,r.velY+=t.y}}),r.setAcc=((e,t,o)=>{r.accelerations[e]={acc:t,angle:o}}),r.addToAcc=((e,t,o)=>{var n={...r.accelerations[e]},a=n.acc*Math.cos(n.angle)+t*Math.cos(o),i=n.acc*Math.sin(n.angle)+t*Math.sin(o);newAcc=Math.sqrt(a*a+i*i),newAngle=Math.atan2(i,a),r.setAcc(e,newAcc,newAngle)}),r.removeAcc=(e=>{delete r.accelerations[e]}),r.setVel=((e,t,o)=>{r.velocities[e]={vel:t,angle:o}}),r.setVelVector=((e,t)=>{r.velocities[e]={vel:SpoolMath.distance(0,0,t[0],t[1]),angle:SpoolMath.globalAngle(0,0,t[0],t[1])}}),r.removeVel=(e=>{delete r.velocities[e]}),r.addToHandler=(e=>{e.add(r)}),r.vectorFromVel=(()=>({angle:Math.atan2(r.velY,r.velX),value:SpoolMath.distance(r.velX,r.velY,0,0)})),r.vectorFromVels=((e,t)=>({angle:Math.atan2(t,e),value:SpoolMath.distance(e,t,0,0)})),r.left=(()=>r.x-r.width/2),r.top=(()=>r.y-r.height/2),r.right=(()=>r.x+r.width/2),r.bottom=(()=>r.y+r.height/2),r.getBounds=(()=>new SpoolRect(r.x-r.width/2,r.y-r.height/2,r.width,r.height)),r},InputManager=()=>{},KeyInputParameters={pressedLeft:!1,pressedUp:!1,pressedRight:!1,pressedDown:!1},GravityParameters={mass:1,gravityLock:!1},CollisionParameters={px:0,py:0},OvalBodyParameters={bodyType:"oval",width:10,height:10},RectangleBodyParameters={bodyType:"rect",width:10,height:10};try{module.exports={Handler:Handler,Chunk:Chunk,CollisionManager:CollisionManager,GravityManager:GravityManager,OuterWorldManager:OuterWorldManager,InputManager:InputManager,ObjectSpawner:ObjectSpawner,Entity:Entity,KeyInputParameters:KeyInputParameters,GravityParameters:GravityParameters,CollisionParameters:CollisionParameters,OvalBodyParameters:OvalBodyParameters,RectangleBodyParameters:RectangleBodyParameters,SpoolTimer:SpoolTimer,SpoolMath:SpoolMath,SpoolUtils:SpoolUtils,Perlin:Perlin}}catch(e){"undefined"==typeof module?console.log("Modules are not present, you are probably on client, make sure this script is included before the files that require it"):console.error(e)}const SpoolMath={coordVelsFromVel:(e,t)=>({x:Math.cos(t)*e,y:Math.sin(t)*e}),globalAngle:(e,t,o,r)=>Math.atan2(r-t,o-e),objGlobalAngle:(e,t)=>this.globalAngle(e.x,e.y,t.x,t.y),angleDistance:(e,t)=>{var o=(t-e)%(2*Math.PI);return o>0?o>Math.PI?-(2*Math.PI-o):o:o<-Math.PI?-(-2*Math.PI-o):o},distance:(e,t,o,r)=>Math.sqrt(Math.pow(o-e,2)+Math.pow(r-t,2)),objDistance:(e,t)=>Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)),polarPoint:(e,t,o,r)=>({x:e+o*Math.cos(r),y:t+o*Math.sin(r)}),rotatePoint:(e,t,o,r,n)=>{var a=Math.sin(n),i=Math.cos(n);return{x:(e-=o)*i-(t-=r)*a+o,y:e*a+t*i+r}},rotatePoints:(e,t,o,r)=>{for(var n=Math.sin(r),a=Math.cos(r),i=[],s=0;s<e.length;s++){var l=e[s][0]-t,h=e[s][1]-o;i.push([l*a-h*n+t,l*n+h*a+o])}return i},transformPoints:(e,t,o)=>{for(var r=[],n=0;n<e.length;n++)r.push([e[n][0]+t,e[n][1]+o]);return r},randRange:(e,t)=>Math.random()*(t-e)+e,randomColor:(e,t)=>`rgb(${Math.floor(Math.random()*(t-e)+e)},${Math.floor(Math.random()*(t-e)+e)},${Math.floor(Math.random()*(t-e)+e)})`,randomHsvColor:(e,t)=>SpoolMath.HSVtoColor(Math.random(),e,t),HSVtoColor:(e,t,o)=>{let{r:r,g:n,b:a}=SpoolMath.HSVtoRGB(e,t,o);return`rgb(${r}, ${n}, ${a})`},HSVtoRGB:(e,t=null,o=null)=>{var r,n,a,i,s,l,h,c;switch(!e||t||o||(t=e.s,o=e.v,e=e.h),l=o*(1-t),h=o*(1-(s=6*e-(i=Math.floor(6*e)))*t),c=o*(1-(1-s)*t),i%6){case 0:r=o,n=c,a=l;break;case 1:r=h,n=o,a=l;break;case 2:r=l,n=o,a=c;break;case 3:r=l,n=h,a=o;break;case 4:r=c,n=l,a=o;break;case 5:r=o,n=l,a=h}return{r:Math.round(255*r),g:Math.round(255*n),b:Math.round(255*a)}},generateLines(e,t,o){for(var r=[],n=0;n<o;n++)r.push(new SpoolLine(e(n),t(n)));return r},lineIntersection:(e,t)=>{var o=e.x,r=e.xx,n=e.y,a=e.yy,i=t.x,s=t.xx,l=t.y,h=t.yy,c=(o-r)*(l-h)-(n-a)*(i-s);if(0==c)return null;var d=((o*a-n*r)*(i-s)-(o-r)*(i*h-l*s))/c,u=((o*a-n*r)*(l-h)-(n-a)*(i*h-l*s))/c;return SpoolMath.inInterval(d,o,r,2)&&SpoolMath.inInterval(d,i,s,2)&&SpoolMath.inInterval(u,n,a,2)&&SpoolMath.inInterval(u,l,h,2)?{x:d,y:u}:null},rectCollision:(e,t)=>(e.x<=t.x&&t.x<=e.xx||e.x<=t.xx&&t.xx<=e.xx)&&(e.y<=t.y&&t.y<=e.yy||e.y<=t.yy&&t.yy<=e.yy),getLinesFromRect:e=>[{x:e.x,y:e.y,xx:e.x,yy:e.yy},{x:e.xx,y:e.y,xx:e.xx,yy:e.yy},{x:e.x,y:e.yy,xx:e.xx,yy:e.yy},{x:e.x,y:e.y,xx:e.xx,yy:e.y}],getLine:(e,t)=>({x:e.x,y:e.y,xx:t.x,yy:t.y}),movingRectCollision:(e,t,o,r=!1)=>{var n=SpoolMath.boundRect(parseInt(t.cx-t.width/2-e.width/2),parseInt(t.cy-t.height/2-e.height/2),parseInt(t.cx+t.width/2+e.width/2),parseInt(t.cy+t.height/2+e.height/2)),a={result:n.contains(e.cx,e.cy)};if(Math.abs(e.cx-t.cx)>=Math.abs(o.x-t.cx)&&Math.abs(e.cy-t.cy)>=Math.abs(o.y-t.cy))return a;var i=SpoolMath.getLine(o,{x:e.cx,y:e.cy});return SpoolMath.lineRectCollision(n,i)},lineRectCollision:(e,t)=>{var o=[],r=SpoolMath.getLinesFromRect(e),n=["right","left","bottom","top"],a=0;if(e.contains(t.x,t.y))return{x:t.x,y:t.y};e.contains(t.xx,t.yy)&&o.push({x:t.xx,y:t.yy}),r.forEach(e=>{var r=SpoolMath.lineIntersection(e,t);r&&(r.direction=n[a]),o.push(r),a++});var i=null,s=null;return a=0,o.forEach(e=>{if(e){var o=SpoolMath.distance(t.x,origin.y,e.x,e.y);(!s||o<s)&&(a,s=o,i=e)}a++}),i?{x:i.x,y:i.y,direction:i.direction}:null},lerp:(e,t,o)=>e+(t-e)*(o=o>1?1:o<0?0:o),lerpRotation:(e,t,o)=>{return e+(((t-e)%(2*Math.PI)+Math.PI/180*540)%(2*Math.PI)-Math.PI)*o%(2*Math.PI)},randomInt:(e,t)=>e+Math.round(Math.random()*(t-e)),randomChoice:e=>0==e.length?null:e[SpoolMath.randomInt(0,e.length-1)],toHex:e=>{var t=Number(e).toString(16);return t.length<2&&(t="0"+t),t},rgbToHex:(e,t,o)=>SpoolMath.toHex(e)+SpoolMath.toHex(t)+SpoolMath.toHex(o),divideColor:(e,t)=>{elements=e.substring(4).split(",");for(var o=0;o<elements.length;o++)elements[o]=parseInt(parseInt(elements[o])/t);return SpoolMath.rgbToHex(elements[0],elements[1],elements[2])},inInterval:(e,t,o,r=0)=>{if(t<o)var n=t,a=o;else n=o,a=t;return n-r<=e&&e<=a+r},inRange:(e,t,o)=>t<=e&&e<o,numberDefined:e=>void 0!==e&&null!==e,getYFromCircle:(e,t)=>{if(e<=t&&e>=-t)var o=Math.sqrt(Math.pow(t,2)-Math.pow(e,2));return-o},getYFromMovedCircle:(e,t,o,r)=>(movY=SpoolMath.getYFromCircle(o,r)+t,movX=o+e,pos=[movX,movY],pos),getAngleFromCircle:(e,t)=>{return Math.acos(t/e)-Math.PI/2},rectangleMouseCollision:(e,t,o,r,n,a)=>n>=e&&n<=e+o&&a<=t&&a>=t-r,rotatePoint:(e,t,o,r,n)=>{var a=SpoolMath.distance(e,t,o,r),i=SpoolMath.globalAngle(e,-t,o,-r)-n,s=Math.cos(i)*a+e,l=-Math.sin(i)*a+t;return pos=[s,l],pos},getUnitVector:e=>[Math.cos(e),Math.sin(e)],scaleVector:(e,t)=>e.map(e=>e*t),addVectors:(e,t)=>{res=[];for(var o=0;o<e.length;o++)res.push(e[o]+t[o]);return res},averageVectors:e=>{if(0==e.length)return null;temp=e[0];for(var t=1;t<e.length;t++)temp=SpoolMath.addVectors(temp,e[t]);return SpoolMath.scaleVector(temp,1/e.length)},average:e=>{if(0==e.length)return 0;for(var t=0,o=0;o<e.length;o++)t+=e[o];return t/e.length},weightedAverage:(e,t)=>{for(var o=0,r=0,n=0;n<e.length;n++)o+=e[n]*t[n],r+=t[n];return 0==r?0:o/r},sigmoid:e=>1/(1+Math.exp(-e)),boundRect:(e,t,o,r)=>new SpoolRect(e,t,o-e,r-t)};function SpoolPoint(e,t){this.x=e,this.y=t}function SpoolLine(e,t){this.a=e,this.b=t}function SpoolRect(e,t,o,r){this.x=e,this.y=t,this.width=o,this.height=r}SpoolLine.prototype.get=function(){return[this.x,this.y,this.xx,this.yy]},Object.defineProperty(SpoolLine.prototype,"x",{get:function(){return this.a.x},set:function(e){this.a.x=e}}),Object.defineProperty(SpoolLine.prototype,"y",{get:function(){return this.a.y},set:function(e){this.a.y=e}}),Object.defineProperty(SpoolLine.prototype,"xx",{get:function(){return this.b.x},set:function(e){this.b.x=e}}),Object.defineProperty(SpoolLine.prototype,"yy",{get:function(){return this.b.y},set:function(e){this.b.y=e}}),SpoolRect.prototype.get=function(){return[this.x,this.y,this.width,this.height]},SpoolRect.prototype.collision=function(e){return(this.x<=e.x&&e.x<=this.xx||this.x<=e.xx&&e.xx<=this.xx)&&(this.y<=e.y&&e.y<=this.yy||this.y<=e.yy&&e.yy<=this.yy)},SpoolRect.prototype.contains=function(e,t){return this.x<=e&&e<=this.xx&&this.y<=t&&t<=this.yy},Object.defineProperty(SpoolRect.prototype,"cx",{get:function(){return this.x+this.width/2},set:function(e){this.x=e-this.width/2}}),Object.defineProperty(SpoolRect.prototype,"cy",{get:function(){return this.y+this.height/2},set:function(e){this.y=e-this.height/2}}),Object.defineProperty(SpoolRect.prototype,"xx",{get:function(){return this.x+this.width},set:function(e){this.x=e-this.width}}),Object.defineProperty(SpoolRect.prototype,"yy",{get:function(){return this.y+this.height},set:function(e){this.y=e-this.height}});var RadiusRect=(e,t,o,r)=>new SpoolRect(e-o,t-r,2*o,2*r);try{module.exports={SpoolMath:SpoolMath,SpoolRect:SpoolRect,RadiusRect:RadiusRect}}catch(e){"undefined"==typeof module?console.log("Modules are not present, you are probably on client, make sure this script is included before the files that require it"):console.error(e)}const basicAliases={x:0,y:1,z:2,w:3,a:0,b:1,c:2,d:3,width:2,height:3},getIndexAndShape=(e,t,o=null)=>{var r=0;o||(o=getLevelSizes(e)),t.forEach((t,n)=>{if(!SpoolMath.inRange(t,0,e[n]))throw`${t} at ${n}-d is out of range(${e[n]})`;r+=t*o[1+n]});var n=e.slice(t.length);return{index:r,shape:n}},getVariableIndexAndShape=(e,t,o=null)=>{null===o&&(o=getIndexesMap(e)[0]);for(var r=o,n=e,a={index:r[0],shape:n},i=0;i<t.length;i++){var s=t[i];if(r=r[s],n=n[s],r.constructor!==Array)return(a=getIndexAndShape(n,t.slice(i+1))).index+=r,a;a={index:r[0],shape:n}}return a},getLevelSizes=e=>{for(var t=[1],o=1,r=e.length,n=0;n<r;n++)o*=e[r-n-1],t.push(o);return t.reverse(),t},getSize=e=>0==e.length?1:e[0].constructor===Array?e.map(e=>getSize(e)).reduce((e,t)=>e+t):e.reduce((e,t)=>e*t),getIndexesMap=(e,t=0)=>[e.map(e=>{if(e[0].constructor===Array){var o=getIndexesMap(e,t);return t+=o[1],o[0]}return index=t,t+=e.reduce((e,t)=>e*t),index}),t],getDimensions=e=>e.length,toFixedSize=(e,t=6)=>{for(var o=e.toString();o.length<t;)o+=" ";return o},toString=(e,t=0,o=0,r="")=>{var n="",a=e.shape.length-o;if(1==a){n+=r;for(var i=0;i<e.shape[e.shape.length-1];i++){var s=e.dimension>1&&i<e.shape[e.shape.length-1]-1?6:0;n+=toFixedSize(e.get(i+t),s)}}else{2!=a&&(n+=r+"[\n");for(i=0;i<e.shape[o];i++){var l=t+i*e.shape.slice(o+1).reduce((e,t)=>e*t),h=2==a&&0==i?r+"[ ":r+"  ",c=2==a&&i==e.shape[o]-1?"":"\n";n+=toString(e,l,o+1,h)+c}n+=2!=a?r+"]":" ]"}return n};function TensorBase(e){this.shape=e,this.size=getSize(e),this.dimension=getDimensions(e)}function Tensor(e,t=null,o=(()=>0)){if(TensorBase.call(this,e),this.type="fixed",this.levelSizes=getLevelSizes(e),t){if(t.length!=this.size)throw`The size of values (${t.length}) doesn't match the shape of the tensor (${e})`;this.values=t}else this.values=Array.from({length:this.size},o)}function VariableTensor(e,t,o=(()=>0)){if(TensorBase.call(this,e),this.type="variable",this.indexes=getIndexesMap(e)[0],t){if(t.length!=this.size)throw`The size of values (${t.length}) doesn't match the shape of the tensor (${e})`;this.values=t}else this.values=Array.from({length:this.size},o)}TensorBase.prototype.getIndex=function(e){return this.getIndexAndShape(e).index},TensorBase.prototype.getValue=function(e){const t=this.getIndex(e);return this.get(t)},TensorBase.prototype.T=function(){if(2!=this.dimension)throw`You can only transpose 2-d tensor, not ${this.d}-d`;var e=[this.shape[1],this.shape[0]],t=new SubTensor(self,e);return t.get=(e=>{var t=Math.floor(e/this.shape[0]),o=e%this.shape[0];return this.get(o*this.shape[1]+t)}),t},TensorBase.prototype.apply=function(e=((e,t)=>e)){return SpoolTensors.apply(this,e)},TensorBase.prototype.add=function(e){return"number"==typeof e?this.apply(t=>t+e):this.apply((t,o)=>t+e.get(o))},TensorBase.prototype.sub=function(e){return"number"==typeof e?this.apply(t=>t-e):this.apply((t,o)=>t-e.get(o))},TensorBase.prototype.mult=function(e){return"number"==typeof e?this.apply(t=>t*e):this.apply((t,o)=>t*e.get(o))},TensorBase.prototype.toString=function(){return toString(this)},Object.keys(basicAliases).forEach(function(e){Object.defineProperty(TensorBase.prototype,e,{get:function(){return this.get(basicAliases[e])},set:function(t){return this.set(basicAliases[e],t)}})}),Tensor.prototype=Object.create(TensorBase.prototype),Tensor.prototype.get=function(e){return this.values[e]},Tensor.prototype.set=function(e,t){return this.values[e]=t,this.values[e]},Tensor.prototype.getIndexAndShape=function(e){return getIndexAndShape(this.shape,e,this.levelSizes)},Tensor.prototype.subTensor=function(e){if(this.shape.length-e.length<0)throw`${e.length} coords for ${o.length} array`;let{index:t,shape:o}=this.getIndexAndShape(e);return new SubTensor(this,o,t,t+getSize(this.shape))},VariableTensor.prototype=Object.create(TensorBase.prototype),VariableTensor.prototype.get=function(e){return this.values[e]},VariableTensor.prototype.set=function(e,t){return this.values[e]=t},VariableTensor.prototype.getIndexAndShape=function(e){return getVariableIndexAndShape(this.shape,e,this.indexes)},VariableTensor.prototype.subTensor=function(e){let{index:t,shape:o}=this.getIndexAndShape(e);return new SubTensor(this,o,t,t+getSize(this.shape))},VariableTensor.prototype.toString=function(){for(var e="",t=0;t<this.shape.length;t++)e+=this.subTensor([t]).toString()+"\n";return e};const isVariable=e=>e.length>0&&e[0].constructor===Array;function SubTensor(e,t,o=null,r=null){TensorBase.call(this,t),this.parent=e,this.start=o,this.end=r,this.type="sub",null===this.start&&(this.start=0),null===this.end&&(this.end=getSize(t)),isVariable(t)?(this.indexes=getIndexesMap(this.shape)[0],this.getIndexAndShape=VariableTensor.prototype.getVariableIndexAndShape):(this.levelSizes=getLevelSizes(this.shape),this.getIndexAndShape=Tensor.prototype.getVariableIndexAndShape)}SubTensor.prototype=Object.create(TensorBase.prototype),SubTensor.prototype.get=function(e){return this.parent.get(e+this.start)},SubTensor.prototype.set=function(e,t){return this.parent.set(e+this.start,t)},SubTensor.prototype.subTensor=function(e){if(this.shape.length-e.length<0)throw`${e.length} coords for ${o.length} array`;let{index:t,shape:o}=this.getIndex(e);var r=getSize(o);return new SubTensor(this.parent,o,t+start,t+start+r)},SubTensor.prototype.toString=function(){return new Tensor(this.shape,null,(e,t)=>this.get(t)).toString()};var operations=["apply",""],SpoolTensors={apply:(e,t=((e,t)=>e))=>{for(var o=0;o<e.size;o++)e.set(o,t(e.get(o),o));return e},copy:(e,t=(e=>e))=>new(SpoolTensors.constructorForShape(e.shape))(e.shape,null,(o,r)=>t(e.get(r))),tensor:(e,t,o)=>new(SpoolTensors.constructorForShape(e))(e,t,o),const:(e,t)=>SpoolTensors.tensor(e,null,()=>{}),zeros:e=>SpoolTensors.const(e),ones:e=>SpoolTensors.const(e,1),constLike:(e,t=0)=>SpoolTensors.copy(e,()=>t),zerosLike:e=>SpoolTensors.constLike(e),onesLike:e=>SpoolTensors.constLike(e,1),random:(e,t=0,o=1)=>new Tensor(e,null,()=>SpoolMath.randRange(t,o)),randomLike:(e,t=0,o=1)=>SpoolTensors.copy(e,()=>SpoolMath.randRange(t,o)),range:(e,t=1)=>new(SpoolTensors.constructorForShape(e))(e,null,(e,o)=>o*t),elementWiseOperation:(e,t,o)=>{if(!SpoolUtils.arraysEqual(e.shape,t.shape))throw`The shapes of the tensors don't match: ${e.shape} != ${t.shape}`;return SpoolTensors.tensor(e.shape,null,(r,n)=>o(e.get(n),t.get(n)))},add:(e,t)=>SpoolTensors.elementWiseOperation(e,t,(e,t)=>e+t),sub:(e,t)=>SpoolTensors.elementWiseOperation(e,t,(e,t)=>e-t),mult:(e,t)=>SpoolTensors.elementWiseOperation(e,t,(e,t)=>e*t),dot:(e,t,o=[],r=[])=>{if(2!=e.dimension&&2!=t.dimension)throw`Dot product supports only 2-d tensor dot your (${e.d}d . ${t.d})`;aValues=e.values,bValues=t.values;let n=e.getIndexAndShape(o),a=n.index,i=n.shape;var s=i[0],l=i[1];let h=t.getIndexAndShape(r),c=h.index,d=h.shape;var u=d[0],p=d[1];if(l!=u)throw`Shapes of the tensors are not compatible for dot ${i} ${d}`;for(var y=[s,p],g=[],x=0;x<s;x++)for(var f=0;f<p;f++){for(var m=0,v=0;v<l;v++)m+=aValues[a+x*l+v]*bValues[c+v*p+f];g.push(m)}return new Tensor(y,g)},concat:e=>new VariableTensor(e.map(e=>e.shape),[].concat(...e.map(e=>e.values))),constructorForShape:e=>{var t=Tensor;return e.length>0&&e[0].constructor===Array&&(t=VariableTensor),t}};try{modules.export={SpoolTensors:SpoolTensors}}catch(e){"undefined"==typeof module?console.log("Modules are not present, you are probably on client, make sure this script is included before the files that require it"):console.error(e)}var MessageCodes={SM_RESET:"reset",SM_PACK_INIT:"init-pack",SM_PACK_UPDATE:"update-pack",SM_PACK_REMOVE:"remove-pack",OS_GET_OBJ:"get-obj",OS_SEND_OBJ:"send-obj",ASIGN_CLIENT_ID:"asign-id",SM_KEY_PRESS:"key-press",SM_MOUSE_INPUT:"mouse-clicked",KI_MOV_LEFT:"MOV_LEFT",KI_MOV_RIGHT:"MOV_RIGHT",KI_MOV_UP:"KI_MOV_UP",KI_MOV_DOWN:"KI_MOV_DOWN",SERVER_LOADING:"SERVER_LOADING"};try{module.exports={...MessageCodes}}catch(e){console.warn("Module exporting is not present. If you are in client make sure you include files correctly in you index file.")}var SpoolRenderer={ctx:null,camera:null,setColor:e=>{SpoolRenderer.ctx.fillStyle=e,SpoolRenderer.ctx.strokeStyle=e},setFont:(e,t)=>{SpoolRenderer.ctx.font=`${t}px ${e}`},drawInscribedOval:e=>{SpoolRenderer.ctx.beginPath(),SpoolRenderer.ctx.ellipse(e.cx,e.cy,e.width/2,e.height/2,0,0,360),SpoolRenderer.ctx.stroke()},fillInscribedOval:e=>{SpoolRenderer.ctx.beginPath(),SpoolRenderer.ctx.ellipse(e.cx,e.cy,e.width/2,e.height/2,0,0,360),SpoolRenderer.ctx.fill()},tDrawPoint:(e,t,o)=>{var r=SpoolRenderer.camera.transformPoint(e,t);SpoolRenderer.fillOval(r.x,r.y,o)},drawLine:(e,t,o,r)=>{SpoolRenderer.ctx.beginPath(),SpoolRenderer.ctx.moveTo(e,t),SpoolRenderer.ctx.lineTo(o,r),SpoolRenderer.ctx.stroke()},tDrawLine:(e,t,o,r)=>{var n=SpoolRenderer.camera.transformPoint(e,t),a=SpoolRenderer.camera.transformPoint(o,r);SpoolRenderer.ctx.beginPath(),SpoolRenderer.ctx.moveTo(n.x,n.y),SpoolRenderer.ctx.lineTo(a.x,a.y),SpoolRenderer.ctx.stroke()},fillInscribedOvalPercentFull:(e,t)=>{if(SpoolRenderer.ctx.beginPath(),t>.5){var o=t-.5,r=Math.asin(2*o);SpoolRenderer.ctx.ellipse(e.cx,e.cy,e.width/2,e.height/2,0,-r,Math.PI+r)}else{r=Math.asin(2*(.5-t));SpoolRenderer.ctx.ellipse(e.cx,e.cy,e.width/2,e.height/2,0,r,Math.PI-r)}SpoolRenderer.ctx.fill()},drawOval:(e,t,o)=>{SpoolRenderer.ctx.beginPath(),SpoolRenderer.ctx.arc(e,t,o,0,360),SpoolRenderer.ctx.stroke()},fillOval:(e,t,o)=>{SpoolRenderer.ctx.beginPath(),SpoolRenderer.ctx.arc(e,t,o,0,360),SpoolRenderer.ctx.fill()},linePolygon:e=>{SpoolRenderer.ctx.beginPath(),SpoolRenderer.ctx.moveTo(e[0][0],e[0][1]);for(var t=1;t<e.length;t++)SpoolRenderer.ctx.lineTo(e[t][0],e[t][1]);SpoolRenderer.ctx.closePath()},fillPolygon:e=>{SpoolRenderer.linePolygon(e),SpoolRenderer.ctx.fill()},renderRotatedSprite:(e,t,o,r,n)=>{SpoolRenderer.ctx.save(),SpoolRenderer.ctx.translate(o,r),SpoolRenderer.ctx.rotate(-t),SpoolRenderer.ctx.drawImage(e,n.x,n.y,n.width,n.height),SpoolRenderer.ctx.restore()},drawRect:(e,t,o,r)=>{SpoolRenderer.ctx.beginPath(),SpoolRenderer.ctx.rect(e,t,o,r),SpoolRenderer.ctx.stroke()},tDrawRect:(e,t,o,r)=>{const n=SpoolRenderer.camera.transformBounds(e,t,o,r);SpoolRenderer.drawRect(n.x,n.y-n.height,n.width,n.height)},fillRect:(e,t,o,r)=>{SpoolRenderer.ctx.fillRect(e,t,o,r)},fillSplRect:e=>{SpoolRenderer.ctx.fillRect(e.x,e.y,e.width,e.height)},drawSplRect:e=>{SpoolRenderer.ctx.fillRect(e.x,e.y,e.width,e.height)},fillRoundRect(e,t,o,r,n,a=0,i=!0,s=!1){if(void 0===a&&(a=5),"number"==typeof a)a={tl:a,tr:a,br:a,bl:a};else{var l={tl:0,tr:0,br:0,bl:0};for(var h in l)a[h]=a[h]||l[h]}e.beginPath(),e.moveTo(t+a.tl,o),e.lineTo(t+r-a.tr,o),e.quadraticCurveTo(t+r,o,t+r,o+a.tr),e.lineTo(t+r,o+n-a.br),e.quadraticCurveTo(t+r,o+n,t+r-a.br,o+n),e.lineTo(t+a.bl,o+n),e.quadraticCurveTo(t,o+n,t,o+n-a.bl),e.lineTo(t,o+a.tl),e.quadraticCurveTo(t,o,t+a.tl,o),e.closePath(),i&&e.fill(),s&&e.stroke()},multiLineText:(e,t,o,r=.33,n=null)=>{var a=[];e.split("\n").forEach(e=>{var t=e.split(" "),r="";SpoolRenderer.ctx.textAlign="center",t.forEach((e,t)=>{SpoolRenderer.ctx.measureText(r+e).width>=o?(a.push(r.trim()),r=e):r+=" "+e}),r&&a.push(r.trim())});var i=parseInt(SpoolRenderer.ctx.font)+3;a.forEach((e,o)=>{var s=t.x+t.width/2,l=t.y+t.height/2-(a.length-1)/2*i+o*i+i*r;n&&(SpoolRenderer.ctx.lineWidth=n,SpoolRenderer.ctx.strokeText(e,s,l)),SpoolRenderer.ctx.fillText(e,s,l)})},simpleText:(e,t,o,r=null)=>{r&&(SpoolRenderer.ctx.lineWidth=r,SpoolRenderer.ctx.strokeText(e,t,o)),SpoolRenderer.ctx.fillText(e,t,o)},tSimpleText:(e,t,o,r=null)=>{var n=SpoolRenderer.camera.transformPoint(t,o);r&&(SpoolRenderer.ctx.lineWidth=r,SpoolRenderer.ctx.strokeText(e,n.x,n.y)),SpoolRenderer.ctx.fillText(e,n.x,n.y)}};console.log("loaded");var SpoolUIElement=e=>{var t={elements:{},layerKeys:[],x:0,y:0,width:0,height:0,layer:10,visible:!0,bgColor:null,fgColor:null,strokeColor:null,textMargin:10,id:Math.random(),lineHeight:10,bindedMouseEvent:null,mouseUp:!1,mouseDown:!0,...e};return t.left=t.x,t.top=t.y,t.right=t.x+t.width,t.bottom=t.y+t.height,t.update=(()=>{}),t.render=(e=>{t.renderBounds(e),t.renderSprite(e),t.renderText(e),t.layerKeys.forEach(o=>{o.ids.forEach(r=>{t.elements[o.key][r].update(),t.elements[o.key][r].visible&&t.elements[o.key][r].render(e)})})}),t.renderBounds=(e=>{t.radius?(t.bgColor&&(e.fillStyle=t.bgColor),t.strokeColor&&(e.strokeStyle=t.strokeColor),drawRoundRect(e,t.x,t.y,t.width,t.height,t.radius,t.bgColor,t.strokeColor)):(e.beginPath(),e.lineWidth="1",e.rect(t.x,t.y,t.width,t.height),t.bgColor&&(1!=t.bgOpacity?(e.globalAlpha=t.bgOpacity,e.fillStyle=t.bgColor,e.fill(),e.globalAlpha=1):(e.fillStyle=t.bgColor,e.fill())))}),t.renderText=(e=>{if(t.text)if(t.disabled?e.fillStyle="gray":t.fgColor?e.fillStyle=fgColor:e.fillStyle="white",t.font&&(e.font=t.font),e.textAlign="center",t.multiLine){if(!t.linesSplit||!t.textLines||t.linesSplit!=t.text){var o="",r=[];t.text.split(" ").forEach((n,a)=>{e.measureText(o+n).width>=t.width-2*t.textMargin?(r.push(o),o=n):o+=" "+n}),o&&r.push(o),t.lineHeight=parseInt(e.font)+3,t.textLines=r}t.textLines.forEach((o,r)=>{e.fillText(o,t.x+t.width/2,t.y+t.height/2-t.textLines.length/2*t.lineHeight+r*t.lineHeight)}),t.linesSplit=t.text}else e.fillText(t.text,t.x+t.width/2,t.y+t.height/2)}),t.renderSprite=((e,o=t.sprite,r=1)=>{o&&e.drawImage(o,t.x+t.width/2-t.width/2*r,t.y+t.height/2-t.height/2*r,t.width*r,t.height*r)}),t.mouseEvent=((e,o=t.mouseUp,r=t.mouseDown)=>{var n=!1;if(t.disabled)return!1;if(t.layerKeys.forEach(o=>{o.ids.forEach(r=>{t.elements[o.key][r].visible&&(n|=t.elements[o.key][r].mouseEvent(e))})}),n)return n;if(recognizedEvent="mouseup"==e.type&&o||"mousedown"==e.type&&r,t.bindedMouseEvent&&recognizedEvent){if(t.x<=e.x&&e.x<=t.x+t.width)if(t.y<=e.y&&e.y<=t.y+t.width)if(!1!==(n=t.bindedMouseEvent(e,t)))return!0;return!1}return!1}),t.mouseMove=(e=>{t.mx=e.clientX,t.my=e.clientY;var o=!1,r=!1;t.layerKeys.forEach(o=>{o.ids.forEach(n=>{t.elements[o.key][n].visible&&(r|=t.elements[o.key][n].mouseMove(e))})});var n=t.mouseOn,a=t.mouseIn;return r?(n=!1,a=!0,o=!1):(t.x<=e.x&&e.x<=t.x+t.width&&t.y<=e.y&&e.y<=t.y+t.width&&(o=!0),n=o,a=o),n!=t.mouseOn&&(n&&t.onMouseEnter?t.onMouseEnter(e,t):!n&&t.onMouseLeave&&t.onMouseLeave(e,t),t.mouseOn=n),t.mouseOn=a,o}),t.add=(e=>{t.elements[e.layer]||(t.elements[e.layer]={}),t.elements[e.layer][e.id]=e,t.refreshKeys()}),t.remove=(e=>{delete t.elements[e],t.refreshKeys()}),t.forEachElement=(e=>{t.layerKeys.forEach(o=>{o.ids.forEach(r=>{e(t.elements[o.key][r])})})}),t.removeAll=(()=>{t.elements={},t.layerKeys=[]}),t.refreshKeys=(()=>{var e=Object.keys(t.elements).sort((e,t)=>parseInt(e)-parseInt(t));t.layerKeys=[],e.forEach(e=>{t.layerKeys.push({key:e,ids:Object.keys(t.elements[e])})})}),t.alignItems=((e,o,r)=>{var n=null,a=null,i=null,s=null;t.layerKeys.forEach(e=>{e.ids.forEach(o=>{var r=t.elements[e.key][o];(!n||r.x<n)&&(n=r.x),(!i||r.y<i)&&(i=r.y),(!a||r.x+r.width>a)&&(a=r.x+r.width),(!s||r.y+r.height>s)&&(s=r.y+r.height)})});var l=o-(n+a)/2,h=r-(i+s)/2;console.log(l,h),t.layerKeys.forEach(e=>{e.ids.forEach(o=>{t.elements[e.key][o].x+=l,t.elements[e.key][o].y+=h})})}),t.getElementBounds=(()=>{var e=null,o=null,r=null,n=null;return t.layerKeys.forEach(a=>{a.ids.forEach(i=>{var s=t.elements[a.key][i];(!e||s.x<e)&&(e=s.x),(!r||s.y<r)&&(r=s.y),(!o||s.x+s.width>o)&&(o=s.x+s.width),(!n||s.y+s.height>n)&&(n=s.y+s.height)})}),{x:e,y:r,width:o-e,height:n-r,left:e,right:o,top:r,bottom:n}}),t.pack=(()=>{var e=t.getElementBounds();t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height}),t},SpoolUIHandler=e=>{return SpoolUIElement({initObject:e})},SpoolUIButton=e=>{return SpoolUIElement({...e})},SpoolUIButtonList=(e,t,o=SpoolUIButton)=>{var r=SpoolUIElement({rows:1,columns:1,margin:10,buttonWidth:50,buttonHeight:50,offsetX:.5,offsetY:.5,...e});r.width=(r.margin+r.buttonWidth)*r.columns,r.height=(r.margin+r.buttonHeight)*r.rows;var n=r.x-r.width*r.offsetX,a=r.y-r.height*r.offsetY,i=0;return r.left=n,r.up=a,r.right=n+r.width,r.bottom=a+r.height,r.buttons=[],t.forEach(e=>{var t=o({x:n+i%r.columns*(r.buttonWidth+r.margin),y:a+Math.floor(i/r.columns)*(r.buttonWidth+r.margin),width:r.buttonWidth,height:r.buttonHeight,...e});i+=1,r.buttons.push(t),r.add(t)}),r},LoadingUI=(e,t)=>{var o=SpoolUIElement({client:e,x:e.gameArea.width-60,y:e.gameArea.height-60,width:50,height:50,overlay:!1,overlayColor:"white",...t});return o.animationFrame=0,o.bounds=SpoolRect(o.x,o.y,o.width,o.height),o.render=(t=>{o.animationFrame+=1,(o.client.serverSideLoading||o.client.clientSideLoading)&&(o.overlay&&(SpoolRenderer.setColor(o.overlayColor),SpoolRenderer.fillRect(0,0,o.client.gameArea.width,o.client.gameArea.height),SpoolRenderer.setColor("black"),SpoolRenderer.setFont("Arial",50),e.serverSideLoadingData&&e.serverSideLoadingData.message?(t.textAlign="center",SpoolRenderer.simpleText(e.serverSideLoadingData.message,o.client.gameArea.width/2,o.client.gameArea.height/2),t.textAlign="right",SpoolRenderer.simpleText("Loading",o.bounds.cx-2*o.bounds.width,o.bounds.cy)):(t.textAlign="center",SpoolRenderer.simpleText("Loading",o.client.gameArea.width/2,o.client.gameArea.height/2))),SpoolRenderer.setColor("black"),SpoolRenderer.drawInscribedOval("black"),SpoolRenderer.fillInscribedOvalPercentFull(o.bounds,o.animationFrame/30),o.animationFrame>30&&(o.animationFrame=0))}),o};const SpoolUtils={forEachInObject:(e,t)=>{Object.keys(e).forEach(o=>{t(e[o],o)})},shuffle:e=>{e.sort(()=>Math.random()-.5)},subarray:(e,t,o)=>o<=t?[]:e.filter((e,r)=>r>=t&&r<o),arraysEqual:(e,t)=>{if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(var o=0;o<e.length;++o)if(e[o]!==t[o])return!1;return!0}};try{module.exports={SpoolUtils:SpoolUtils}}catch(e){"undefined"==typeof module?console.log("Modules are not present, you are probably on client, make sure this script is included before the files that require it"):console.error(e)}